<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ­Œæ›²è¯¦æƒ…ä¸è¯„è®º</title>
  <style>
     /* ========== å…¨å±€å˜é‡å®šä¹‰ ========== */
    :root {
      --primary: #6366f1;         /* ä¸»è‰²ï¼šç°ä»£é›è“ */
      --primary-hover: #4f46e5;   /* ä¸»è‰²hover */
      --bg-body: #fbfcfd;         /* é¡µé¢èƒŒæ™¯ */
      --bg-card: #ffffff;         /* å¡ç‰‡èƒŒæ™¯ */
      --text-main: #1e293b;       /* ä¸»è¦æ–‡å­— */
      --text-muted: #64748b;      /* æ¬¡è¦æ–‡å­— */
      --border-color: #f1f5f9;    /* è¾¹æ¡†è‰² */
      --accent-orange: #f59e0b;   /* è¯„åˆ†æ©™è‰² */
      --danger-red: #ff4d4f;      /* ç‚¹èµçº¢è‰² */
      --success-green: #52c41a;   /* æç¤ºç»¿è‰² */
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --comment-bg: #fafafa;      /* è¯„è®ºèƒŒæ™¯ */
    }

    /* ========== åŸºç¡€é‡ç½® ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      padding: 2rem 1rem;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    /* å›å¤ç›¸å…³æŒ‰é’®æ ·å¼ */
    .reply-toggle-btn {
      background: rgba(99, 102, 241, 0.08);
      color: var(--primary);
      border: 1px solid rgba(99, 102, 241, 0.2);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 8px;
    }

    .reply-toggle-btn:hover {
      background: rgba(99, 102, 241, 0.12);
      border-color: rgba(99, 102, 241, 0.3);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
    }

    .reply-toggle-btn:active {
      transform: translateY(0);
    }

    .load-more-replies-btn {
      background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 8px 0;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .load-more-replies-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--primary-hover) 0%, #7c3aed 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .load-more-replies-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .load-more-replies-btn::after {
      content: "â†“";
      font-size: 0.9em;
      transition: transform 0.2s ease;
    }

    .load-more-replies-btn:hover::after {
      transform: translateY(1px);
    }

    .delete-btn {
      background: rgba(239, 68, 68, 0.08);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.2);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-left: auto;
    }

    .delete-btn:hover {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(239, 68, 68, 0.3);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.1);
    }

    .delete-btn:active {
      transform: translateY(0);
    }

    /* ========== å®¹å™¨æ ·å¼ ========== */
    .container {
      width: 100%;
      max-width: 800px;
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(226, 232, 240, 0.5);
      overflow: hidden;
    }

    /* ========== å¤´éƒ¨æ ·å¼ ========== */
    .header {
      padding: 1.25rem 2rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 16px;
      cursor: pointer;
      background-color: #ffffff;
      color: #475569;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      outline: none;
    }

    .back-btn:hover {
      background-color: #f8fafc;
      border-color: #cbd5e1;
      color: var(--primary);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .back-btn:active {
      background-color: #f1f5f9;
      transform: scale(0.97);
    }

    .back-btn:disabled {
      background-color: #ffffff;
      color: #cbd5e1;
      border-color: #f1f5f9;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* ========== æ­Œæ›²å†…å®¹åŒºåŸŸ ========== */
    .song-content {
      padding: 2.5rem;
      display: none; /* åˆå§‹éšè—ï¼ŒåŠ è½½å®Œæˆåæ˜¾ç¤º */
    }

    .song-header {
      margin-bottom: 2rem;
    }

    .song-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-main);
      margin-bottom: 0.75rem;
      letter-spacing: -0.025em;
    }

    .meta-row {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .album-badge {
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .release-date {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    /* ========== è¯„åˆ†å¡ç‰‡æ ·å¼ ========== */
    .score-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .score-info h3 {
      font-size: 0.875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .score-display {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .avg-num {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--accent-orange);
    }

    .count-text {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    #scoreLoading {
      font-size: 0.75rem;
      color: var(--primary);
      margin-left: 10px;
      display: none;
    }

    .rating-action {
      text-align: right;
    }

    .star-group {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      justify-content: flex-end;
    }

    .star {
      font-size: 1.75rem;
      color: #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .star.active, .star.hover {
      color: var(--accent-orange);
      transform: scale(1.1);
    }

    .submit-btn {
      background: var(--primary);
      color: white;
      border: none;
	padding: 8px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .submit-btn:hover:not(:disabled) {
      background: var(--primary-hover);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .rating-tip {
      font-size: 0.75rem;
      margin-top: 8px;
      color: var(--text-muted);
    }

    /* ========== æ­Œæ›²è¯¦æƒ…ç½‘æ ¼ ========== */
    .details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 2rem;
      border-top: 1px solid var(--border-color);
      padding-top: 2rem;
      margin-bottom: 3rem;
    }

    .detail-item label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .detail-item p {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-main);
    }

    /* ========== è¯„è®ºåŒºåŸŸæ ·å¼ ========== */
    .comments-section {
      margin-top: 3rem;
      border-top: 1px solid var(--border-color);
      padding-top: 2rem;
    }

    .comments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .comments-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-main);
    }

    .comments-count {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    /* ========== è¯„è®ºå‘å¸ƒè¡¨å• ========== */
    .comment-form {
      background: var(--comment-bg);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 2rem;
    }

    .comment-input-wrapper {
      margin-bottom: 1rem;
    }

    .comment-input {
      width: 100%;
      min-height: 80px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 0.95rem;
      resize: vertical;
      background: white;
      transition: border-color 0.2s;
    }

    .comment-input:focus {
      outline: none;
	  border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }

    .comment-input::placeholder {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .comment-form-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .comment-length-tip {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .comment-submit-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .comment-submit-btn:hover:not(:disabled) {
      background: var(--primary-hover);
    }

    .comment-submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .comment-login-tip {
      text-align: center;
      padding: 1rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .comment-login-tip a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }

    /* ========== è¯„è®ºåˆ—è¡¨ ========== */
    .comments-list {
      margin-bottom: 2rem;
      display: none; /* åˆå§‹éšè— */
    }

    .comment-item {
      padding: 1.25rem 0;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      animation: fadeIn 0.5s ease forwards;
    }

    /* ä¸´æ—¶è¯„è®ºæ ‡è®° */
    .temp-comment {
      opacity: 0.8;
      border-left: 3px solid #ffa500;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* è¯„è®ºå¤´åƒ */
    .comment-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      overflow: hidden;
    }

    .comment-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .comment-avatar-placeholder {
      font-size: 16px;
      color: var(--text-muted);
    }

    .comment-content-wrapper {
      flex: 1;
      min-width: 0;
    }

    .comment-item:last-child {
      border-bottom: none;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .comment-nickname {
      color: var(--primary);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .comment-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .comment-content {
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text-main);
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    /* è¯„è®º/å›å¤ä¸­çš„å›¾ç‰‡æ ·å¼ - æ–°å¢é€‚é…å›¾ç‰‡æ¸²æŸ“ */
    .comment-img, .reply-img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin: 8px 0;
      object-fit: cover;
    }

    /* ========== è¯„è®ºæ“ä½œï¼ˆç‚¹èµ+å›å¤ï¼‰ ========== */
    .comment-actions {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border-color);
    }

    /* ç‚¹èµæŒ‰é’® */
    .like-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-muted);
      transition: all 0.2s;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .like-btn:hover {
      color: var(--danger-red);
    }

    .like-btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      color: var(--border-color);
    }

    /* çˆ±å¿ƒå›¾æ ‡ */
    .heart-icon {
      font-size: 1rem;
      color: transparent;
      text-shadow: 0 0 0 #ccc;
      transition: color 0.2s ease;
    }

    .heart-icon.liked {
      color: var(--danger-red);
      text-shadow: none;
      animation: heartBeat 0.3s ease forwards;
    }

    @keyframes heartBeat {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .comment-like-count, .reply-like-count {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    /* å›å¤æŒ‰é’® */
    .reply-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .reply-btn:hover {
      color: var(--primary);
    }

    .reply-btn:disabled {
      cursor: not-allowed;
      color: var(--border-color);
    }

    /* ========== å›å¤åˆ—è¡¨ ========== */
    .replies-list {
      margin-top: 1rem;
      padding-left: 1.5rem;
      border-left: 2px solid var(--border-color);
      gap: 1rem;
      display: none; /* é»˜è®¤æŠ˜å  */
      flex-direction: column;
    }
    .replies-list.show {
      display: flex; /* ç‚¹å‡»å±•å¼€åæ˜¾ç¤º */
    }

    /* ========== å›å¤é¡¹æ ¸å¿ƒæ ·å¼ - ä¿®å¤å¸ƒå±€é”™ä¹± é‡ç‚¹ âœ…âœ…âœ… ========== */
    .reply-item {
      padding: 1rem 0;
      border-bottom: 1px solid var(--border-color);
      display: flex !important; /* å¼ºåˆ¶flexç”Ÿæ•ˆï¼Œä¼˜å…ˆçº§æ‹‰æ»¡ */
      align-items: flex-start;   /* å¤´åƒä¸å†…å®¹é¡¶éƒ¨å¯¹é½ */
      gap: 12px;                 /* å¤´åƒå’Œå†…å®¹é—´è· */
      width: 100%;
    }
    .reply-item:last-child {
      border-bottom: none; /* æœ€åä¸€ä¸ªå›å¤å»æ‰ä¸‹è¾¹æ¡† */
    }

    /* å›å¤å¤´åƒæ ·å¼ */
    .reply-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0; /* å¤´åƒæ°¸ä¸è¢«æŒ¤å‹å˜å½¢ */
      overflow: hidden;
      flex: none;
    }
    .reply-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .reply-avatar-placeholder {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* å›å¤å†…å®¹å®¹å™¨ - è§£å†³å†…å®¹æº¢å‡º/ä¸æ¢è¡Œ */
    .reply-content-wrapper {
      flex: 1;          /* å æ»¡å‰©ä½™æ‰€æœ‰ç©ºé—´ */
      min-width: 0;     /* å…³é”®å±æ€§ï¼šè§£å†³flexå­å…ƒç´ å†…å®¹æº¢å‡ºä¸æ¢è¡Œ */
    }

    /* ä¸´æ—¶å›å¤æ ‡è¯† - æ©™è‰²è¾¹æ¡†ä¸é®æŒ¡å¤´åƒ */
    .temp-reply {
      opacity: 0.8;
    }
    .temp-reply .reply-content-wrapper {
      border-left: 2px solid #ffa500;
      padding-left: 12px;
      margin-left: -12px;
    }

    .reply-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .reply-username {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.875rem;
    }

    .reply-to {
      color: var(--text-muted);
      font-size: 0.8rem;
      margin-left: 4px;
    }

    .reply-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .reply-content {
      font-size: 0.9rem;
      line-height: 1.5;
      color: var(--text-main);
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* å›å¤æ“ä½œæ  */
    .reply-actions {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border-color);
    }

    /* å›å¤ä¸­ @ç”¨æˆ· çš„æ ·å¼ï¼šçªå‡ºæ˜¾ç¤º */
    .reply-at-user {
      color: var(--primary);
      font-weight: 600;
    }

    /* æš‚æ— å›å¤æç¤º */
    .empty-replies-tip {
      padding: 1rem 0;
      color: var(--text-muted);
      font-size: 0.875rem;
      text-align: left;
    }

    /* ========== å›å¤è¡¨å• ========== */
    .reply-form {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--comment-bg);
      border-radius: 8px;
      display: none;
    }

    .reply-form.show {
      display: block;
      animation: fadeIn 0.3s ease forwards;
    }

    .reply-input-wrapper {
      margin-bottom: 0.75rem;
    }

    .reply-input {
      width: 100%;
      min-height: 60px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px 14px;
      font-size: 0.875rem;
      resize: vertical;
      background: white;
      transition: border-color 0.2s;
    }

    .reply-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }

    .reply-input::placeholder {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .reply-form-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .reply-length-tip {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .reply-submit-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reply-submit-btn:hover:not(:disabled) {
      background: var(--primary-hover);
    }

    .reply-submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .reply-cancel-btn {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border-color);
      padding: 6px 16px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reply-cancel-btn:hover {
      color: var(--text-main);
      border-color: #cbd5e1;
    }

    /* ========== ç©ºè¯„è®º/åŠ è½½çŠ¶æ€ ========== */
    .empty-comments {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
      display: none; /* åˆå§‹éšè— */
    }

    .empty-comments-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #e2e8f0;
    }

    .comments-loading, .loading-overlay {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .loading-overlay {
      padding: 5rem;
    }

    /* ========== è¯„è®ºåˆ†é¡µ ========== */
    .comments-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 2rem;
      display: none; /* åˆå§‹éšè— */
    }

    .page-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: white;
      color: var(--text-main);
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .page-btn:hover:not(:disabled) {
      border-color: var(--primary);
      color: var(--primary);
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* ========== å…¨å±€æç¤ºæ¡† ========== */
    .comment-tip {
      font-size: 0.9rem;
      font-weight: 500;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 16px;
      border-radius: 4px;
      color: #fff;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    /* ========== å“åº”å¼é€‚é… ========== */
    @media (max-width: 640px) {
      .back-btn {
        padding: 6px 12px;
        font-size: 0.85rem;
      }
      .score-card { 
        flex-direction: column; 
        text-align: center; 
        gap: 1.5rem; 
      }
      .rating-action { text-align: center; }
      .star-group { justify-content: center; }
      .song-content { padding: 1.5rem; }
      .comments-header { 
        flex-direction: column; 
        align-items: flex-start; 
        gap: 0.5rem; 
      }
      .comment-avatar { width: 36px; height: 36px; }
      .reply-avatar { width: 32px; height: 32px; }
      .replies-list { padding-left: 0.8rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨è¿”å›æŒ‰é’® -->
    <div class="header">
      <button class="back-btn" id="backToListBtn">â† è¿”å›åˆ—è¡¨</button>
    </div>

    <!-- åŠ è½½ä¸­æç¤º -->
    <div id="loading" class="loading-overlay">æ­£åœ¨è·å–èµ„æºä¿¡æ¯...</div>

    <!-- æ­Œæ›²è¯¦æƒ…ä¸»ä½“ -->
    <div id="songDetail" class="song-content">
      <!-- æ­Œæ›²æ ‡é¢˜ä¸å…ƒä¿¡æ¯ -->
      <div class="song-header">
        <h1 class="song-title" id="songName">åŠ è½½ä¸­...</h1>
        <div class="meta-row">
          <span class="album-badge" id="albumName">-</span>
          <span class="release-date" id="releaseDate">å‘è¡Œæ—¶é—´ï¼š-</span>
        </div>
      </div>

      <!-- è¯„åˆ†å¡ç‰‡ -->
      <div class="score-card">
        <div class="score-info">
          <h3>å¬ä¼—è¯„åˆ†</h3>
          <div class="score-display">
            <span class="avg-num" id="averageScore">0.0</span>
            <span class="count-text" id="ratingCount">0 äººå‚ä¸</span>
            <span id="scoreLoading">åŒæ­¥ä¸­...</span>
          </div>
        </div>
        <div class="rating-action">
          <div class="star-group" id="starRating">
            <span class="star" data-score="1">â˜…</span>
            <span class="star" data-score="2">â˜…</span>
            <span class="star" data-score="3">â˜…</span>
            <span class="star" data-score="4">â˜…</span>
            <span class="star" data-score="5">â˜…</span>
          </div>
          <button class="submit-btn" id="ratingSubmit" disabled>æäº¤æˆ‘çš„è¯„åˆ†</button>
          <div class="rating-tip" id="ratingTip">ç™»å½•åå³å¯å‚ä¸æ‰“åˆ†</div>
        </div>
      </div>

      <!-- æ­Œæ›²è¯¦æƒ…ç½‘æ ¼ -->
      <div class="details-grid">
        <div class="detail-item">
          <label>ä½œè¯</label>
          <p id="lyricist">-</p>
        </div>
        <div class="detail-item">
          <label>ä½œæ›²</label>
          <p id="composer">-</p>
        </div>
        <div class="detail-item">
          <label>ç¼–æ›²</label>
          <p id="arranger">-</p>
        </div>
        <div class="detail-item">
          <label>æ—¶é•¿</label>
          <p id="duration">-</p>
        </div>
      </div>

      <!-- è¯„è®ºåŒºåŸŸ -->
      <div class="comments-section" id="commentsSection">
        <div class="comments-header">
          <h2 class="comments-title">å¬ä¼—è¯„è®º</h2>
          <span class="comments-count" id="commentsTotalCount">0 æ¡è¯„è®º</span>
        </div>

        <!-- è¯„è®ºå‘å¸ƒè¡¨å• -->
        <div id="commentFormContainer" class="comment-form">
          <div id="commentLoginTip" class="comment-login-tip">
            <a href="login.html">è¯·ç™»å½•</a> åå‘è¡¨ä½ çš„çœ‹æ³•
          </div>
          <div id="commentForm" style="display: none;">
            <div class="comment-input-wrapper">
              <textarea 
                class="comment-input" 
                id="commentContent" 
                placeholder="åˆ†äº«ä½ çš„å¬åæ„Ÿï¼ˆ1-500å­—ï¼‰..."
                maxlength="500"></textarea>
            </div>
            <div class="comment-form-footer">
              <span class="comment-length-tip" id="commentLengthTip">0/500</span>
              <button class="comment-submit-btn" id="commentSubmitBtn" disabled>å‘å¸ƒè¯„è®º</button>
            </div>
          </div>
        </div>

        <!-- è¯„è®ºåŠ è½½çŠ¶æ€ -->
        <div id="commentsLoading" class="comments-loading">åŠ è½½è¯„è®ºä¸­...</div>
        
        <!-- ç©ºè¯„è®ºæç¤º -->
        <div id="emptyComments" class="empty-comments">
          <div class="empty-comments-icon">ğŸ’¬</div>
          <p></p>
        </div>

        <!-- è¯„è®ºåˆ—è¡¨ -->
        <div id="commentsList" class="comments-list"></div>

        <!-- è¯„è®ºåˆ†é¡µ -->
        <div id="commentsPagination" class="comments-pagination"></div>
      </div>
    </div>
  </div>

<!-- å¼•å…¥axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!-- JSé€»è¾‘éƒ¨åˆ†å¯åç»­è¡¥å……ï¼Œæ­¤å¤„ä»…ä¿ç•™HTML+CSS -->
<script>
// ========== å…¨å±€å˜é‡ ==========
const searchParams = new URLSearchParams(window.location.search);
const resourceId = searchParams.get('resourceId');
const resourceType = searchParams.get('resourceType') || 'song';
let selectedScore = 0;
console.log(`ã€å…¨å±€åˆå§‹åŒ–ã€‘ã€é¡µé¢å‚æ•°ã€‘ resourceId=${resourceId}, resourceType=${resourceType}ï¼Œå½“å‰é¡µé¢èµ„æºç±»å‹ä¸º${resourceType}`);

// è¯„è®ºç›¸å…³å…¨å±€å˜é‡
let currentCommentPage = 1;
const commentPageSize = 20;
let totalCommentPages = 0;
console.log(`ã€å…¨å±€åˆå§‹åŒ–ã€‘ã€è¯„è®ºåˆ†é¡µã€‘ åˆå§‹é¡µç =${currentCommentPage}, æ¯é¡µæ¡æ•°=${commentPageSize}`);

// ========== ç”¨æˆ·ç¼“å­˜ç›¸å…³å‡½æ•° ==========
/**
 * ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°ç¼“å­˜
 * @param {Object} userInfo - ç”¨æˆ·ä¿¡æ¯å¯¹è±¡ï¼ˆnick_name/avatar/usernameï¼‰
 */
function saveUserToCache(userInfo) {
  console.log(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€ä¿å­˜ç¼“å­˜ã€‘ å¼€å§‹ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œå…¥å‚userInfo=`, userInfo);
  if (!userInfo) {
    console.warn(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€ä¿å­˜ç¼“å­˜ã€‘ ç”¨æˆ·ä¿¡æ¯ä¸ºç©ºï¼Œç»ˆæ­¢ä¿å­˜`);
    return;
  }
  const cacheData = {
    nick_name: userInfo.nick_name || userInfo.nickname || userInfo.username,
    avatar: userInfo.avatar || '',
    username: userInfo.username || '',
    cacheTime: Date.now() // è®°å½•ç¼“å­˜æ—¶é—´ï¼Œå¯é€‰ï¼šç”¨äºè¿‡æœŸåˆ¤æ–­
  };
  localStorage.setItem('music_user_info', JSON.stringify(cacheData));
  console.log(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€ä¿å­˜ç¼“å­˜ã€‘ ç”¨æˆ·ä¿¡æ¯ä¿å­˜æˆåŠŸï¼Œç¼“å­˜æ•°æ®=`, cacheData);
}

/**
 * ä»æœ¬åœ°ç¼“å­˜è¯»å–ç”¨æˆ·ä¿¡æ¯
 * @returns {Object} ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆæ— åˆ™è¿”å›nullï¼‰
 */
function getUserFromCache() {
  console.log(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€è¯»å–ç¼“å­˜ã€‘ å¼€å§‹è¯»å–æœ¬åœ°ç”¨æˆ·ç¼“å­˜`);
  const cacheStr = localStorage.getItem('music_user_info');
  if (!cacheStr) {
    console.warn(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€è¯»å–ç¼“å­˜ã€‘ æœ¬åœ°æ— ç”¨æˆ·ç¼“å­˜æ•°æ®ï¼Œè¿”å›null`);
    return null;
  }
  try {
    const cacheData = JSON.parse(cacheStr);
    console.log(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€è¯»å–ç¼“å­˜ã€‘ è¯»å–åˆ°ç¼“å­˜æ•°æ®=`, cacheData);
    // å¯é€‰ï¼šç¼“å­˜è¿‡æœŸåˆ¤æ–­ï¼ˆæ¯”å¦‚è¶…è¿‡24å°æ—¶åˆ™å¤±æ•ˆï¼‰
    const expireTime = 24 * 60 * 60 * 1000; // 24å°æ—¶
    const cacheDiff = Date.now() - cacheData.cacheTime;
    console.log(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€è¿‡æœŸæ ¡éªŒã€‘ ç¼“å­˜æ—¶é•¿=${Math.floor(cacheDiff/1000)}ç§’ï¼Œè¿‡æœŸé˜ˆå€¼=${Math.floor(expireTime/1000)}ç§’`);
    if (cacheDiff > expireTime) {
      console.warn(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€è¿‡æœŸæ ¡éªŒã€‘ ç¼“å­˜å·²è¿‡æœŸï¼Œæ‰§è¡Œæ¸…é™¤ç¼“å­˜æ“ä½œ`);
      clearUserCache();
      return null;
    }
    console.log(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€è¯»å–ç¼“å­˜ã€‘ ç¼“å­˜æœ‰æ•ˆï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯`);
    return cacheData;
  } catch (e) {
    console.error(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€è¯»å–ç¼“å­˜ã€‘ è§£æç¼“å­˜å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯=`, e);
    clearUserCache();
    return null;
  }
}

/**
 * æ¸…é™¤æœ¬åœ°ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
 */
function clearUserCache() {
  console.log(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€æ¸…é™¤ç¼“å­˜ã€‘ æ‰§è¡Œæ¸…é™¤æœ¬åœ°ç”¨æˆ·ä¿¡æ¯ç¼“å­˜æ“ä½œ`);
  localStorage.removeItem('music_user_info');
  console.log(`ã€ç”¨æˆ·ç¼“å­˜ã€‘ã€æ¸…é™¤ç¼“å­˜ã€‘ æœ¬åœ°ç”¨æˆ·ä¿¡æ¯ç¼“å­˜æ¸…é™¤å®Œæˆ`);
}

// ========== å…¨å±€è¾…åŠ©å‡½æ•° ==========
/**
 * å…¨å±€è¯„è®º/æ“ä½œæç¤ºæ¡†
 * @param {string} message - æç¤ºå†…å®¹
 * @param {string} type - æç¤ºç±»å‹ï¼ˆsuccess/errorï¼‰
 */
function showCommentTip(message, type = 'success') {
  console.log(`ã€å…¨å±€å·¥å…·ã€‘ã€å¼¹çª—æç¤ºã€‘ æç¤ºç±»å‹=${type}, æç¤ºå†…å®¹=${message}`);
  const tipEl = document.createElement('div');
  tipEl.className = `comment-tip ${type}`;
  tipEl.textContent = message;
  
  if (type === 'success') {
    tipEl.style.backgroundColor = '#52c41a';
  } else {
    tipEl.style.backgroundColor = '#ff4d4f';
  }
  
  document.body.appendChild(tipEl);
  setTimeout(() => tipEl.style.opacity = '1', 10);
  setTimeout(() => {
    tipEl.style.opacity = '0';
    setTimeout(() => document.body.removeChild(tipEl), 300);
  }, 2000);
}

/**
 * æ ¼å¼åŒ–æ—¶é—´ï¼ˆè¯„è®º/å›å¤åˆ›å»ºæ—¶é—´ï¼‰
 * @param {string} timeStr - åŸå§‹ISOæ—¶é—´å­—ç¬¦ä¸²
 * @returns {string} æ ¼å¼åŒ–åçš„å‹å¥½æ—¶é—´
 */
function formatCommentTime(timeStr) {
  const d = new Date(timeStr);
  const diff = Date.now() - d;
  if (diff < 60000) return "åˆšåˆš";
  if (diff < 3600000) return Math.floor(diff / 60000) + "åˆ†é’Ÿå‰";
  if (diff < 86400000) return Math.floor(diff / 3600000) + "å°æ—¶å‰";
  return d.toLocaleDateString();
}

/**
 * è·å–é»˜è®¤å¤´åƒï¼ˆå­—ç¬¦å ä½ï¼‰
 * @param {string} name - ç”¨æˆ·å/æ˜µç§°
 * @returns {string} å¤´åƒå ä½ç¬¦HTML
 */
function getDefaultAvatar(name) {
  const ch = name?.trim()?.charAt(0)?.toUpperCase() || "ğŸ‘¤";
  return `<div class="comment-avatar-placeholder">${ch}</div>`;
}

// ========== ç”¨æˆ·ä¿¡æ¯ç›¸å…³å‡½æ•° ==========
/**
 * è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆç¼“å­˜ä¼˜å…ˆ + å¼‚æ­¥åˆ·æ–°ï¼‰
 * @returns {Promise<Object|null>} ç”¨æˆ·ä¿¡æ¯å¯¹è±¡æˆ–null
 */
async function getCurrentUserInfo() {
  console.group(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€è·å–å½“å‰ç”¨æˆ·ã€‘ å¼€å§‹æ‰§è¡Œè·å–ç”¨æˆ·ä¿¡æ¯æµç¨‹`);
  // ========== é‡ç‚¹TOKENæ—¥å¿— ==========
  const token = localStorage.getItem('music_user_token');
  const desensitizeToken = token ? `${token.slice(0,8)}****${token.slice(-8)}` : 'æ— TOKEN';
  console.log(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€TOKENæ ¡éªŒã€‘ æœ¬åœ°è¯»å–TOKEN=${desensitizeToken}, TOKENæ˜¯å¦å­˜åœ¨=${!!token}`);

  if (!token) {
    console.warn(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€TOKENæ ¡éªŒã€‘ TOKENä¸ºç©ºï¼Œæ‰§è¡Œæ¸…é™¤ç¼“å­˜æ“ä½œï¼Œè¿”å›null`);
    clearUserCache(); // tokenå¤±æ•ˆæ—¶æ¸…é™¤ç¼“å­˜
    console.groupEnd();
    return null;
  }

  // æ ¸å¿ƒä¼˜åŒ–ï¼šå…ˆè¯»ç¼“å­˜è¿”å›ï¼Œå†å¼‚æ­¥è¯·æ±‚æœ€æ–°æ•°æ®
  const cacheUser = getUserFromCache();
  if (cacheUser) {
    console.log(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€ç¼“å­˜å‘½ä¸­ã€‘ è¯»å–åˆ°æœ‰æ•ˆç”¨æˆ·ç¼“å­˜ï¼Œä¼˜å…ˆè¿”å›ç¼“å­˜æ•°æ®ï¼Œå¼‚æ­¥åˆ·æ–°æœ€æ–°æ•°æ®`);
    // å¼‚æ­¥è¯·æ±‚æœ€æ–°æ•°æ®ï¼Œæ›´æ–°ç¼“å­˜ï¼ˆä¸é˜»å¡å½“å‰æ“ä½œï¼‰
    refreshUserInfo(token);
    console.groupEnd();
    return cacheUser; // ä¼˜å…ˆè¿”å›ç¼“å­˜
  }

  // æ— ç¼“å­˜æ—¶ï¼Œæ­£å¸¸è¯·æ±‚å¹¶ç¼“å­˜
  try {
    console.log(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€æ¥å£è¯·æ±‚ã€‘ æ— ç¼“å­˜ï¼Œå¼€å§‹è¯·æ±‚ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼Œè¯·æ±‚åœ°å€=http://localhost:3000/api/user/info`);
    const res = await axios.get('http://localhost:3000/api/user/info', {
      headers: { 'Authorization': `Bearer ${token}` },
      withCredentials: true
    });
    console.log(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€æ¥å£å“åº”ã€‘ è¯·æ±‚æˆåŠŸï¼Œå“åº”çŠ¶æ€=${res.status}, å“åº”æ•°æ®=`, res.data);
    const userInfo = res.data.code === 200 ? res.data.data : null;
    if (userInfo) {
      console.log(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€æ¥å£å“åº”ã€‘ æ¥å£è¿”å›æœ‰æ•ˆç”¨æˆ·ä¿¡æ¯ï¼Œæ‰§è¡Œç¼“å­˜ä¿å­˜`);
      saveUserToCache(userInfo); // ç¼“å­˜æœ€æ–°æ•°æ®
    } else {
      console.warn(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€æ¥å£å“åº”ã€‘ æ¥å£è¿”å›ç”¨æˆ·ä¿¡æ¯ä¸ºç©º`);
    }
    console.groupEnd();
    return userInfo;
  } catch (err) {
    console.error(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€æ¥å£å¼‚å¸¸ã€‘ è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯å¤±è´¥, é”™è¯¯è¯¦æƒ…=`, err);
    clearUserCache(); // è¯·æ±‚å¤±è´¥æ—¶æ¸…é™¤ç¼“å­˜
    console.groupEnd();
    return null;
  }
}

/**
 * å¼‚æ­¥åˆ·æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸é˜»å¡UIï¼‰
 * @param {string} token - ç”¨æˆ·ç™»å½•ä»¤ç‰Œ
 */
async function refreshUserInfo(token) {
  console.group(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€å¼‚æ­¥åˆ·æ–°ã€‘ å¼€å§‹å¼‚æ­¥åˆ·æ–°ç”¨æˆ·ä¿¡æ¯`);
  const desensitizeToken = token ? `${token.slice(0,8)}****${token.slice(-8)}` : 'æ— TOKEN';
  console.log(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€å¼‚æ­¥åˆ·æ–°ã€‘ åˆ·æ–°ä½¿ç”¨TOKEN=${desensitizeToken}`);
  try {
    const res = await axios.get('http://localhost:3000/api/user/info', {
      headers: { 'Authorization': `Bearer ${token}` },
      withCredentials: true
    });
    console.log(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€å¼‚æ­¥åˆ·æ–°ã€‘ åˆ·æ–°è¯·æ±‚æˆåŠŸï¼Œå“åº”æ•°æ®=`, res.data);
    const newUserInfo = res.data.code === 200 ? res.data.data : null;
    if (newUserInfo) {
      console.log(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€å¼‚æ­¥åˆ·æ–°ã€‘ è·å–åˆ°æœ€æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œæ›´æ–°æœ¬åœ°ç¼“å­˜`);
      saveUserToCache(newUserInfo); // æ›´æ–°ç¼“å­˜
    } else {
      console.warn(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€å¼‚æ­¥åˆ·æ–°ã€‘ åˆ·æ–°è¿”å›ç”¨æˆ·ä¿¡æ¯ä¸ºç©º`);
    }
  } catch (err) {
    console.error(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€å¼‚æ­¥åˆ·æ–°ã€‘ å¼‚æ­¥åˆ·æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥, é”™è¯¯è¯¦æƒ…=`, err);
    if (err.response?.status === 401) {
      console.error(`ã€ç”¨æˆ·ä¿¡æ¯ã€‘ã€å¼‚æ­¥åˆ·æ–°ã€‘ TOKENå¤±æ•ˆ/æœªæˆæƒï¼Œæ¸…é™¤ç¼“å­˜å’ŒTOKEN`);
      clearUserCache();
      localStorage.removeItem('music_user_token');
    }
  }
  console.groupEnd();
}

// ========== è¯„åˆ†ç›¸å…³å‡½æ•° ==========
/**
 * è·å–èµ„æºå¹³å‡è¯„åˆ†
 */
async function getResourceRating() {
  console.group(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€è·å–å¹³å‡åˆ†ã€‘ å¼€å§‹è·å–èµ„æºè¯„åˆ†`);
  if (!resourceId) {
    console.warn(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€è·å–å¹³å‡åˆ†ã€‘ resourceIdä¸ºç©ºï¼Œç»ˆæ­¢è¯·æ±‚`);
    console.groupEnd();
    return;
  }
  console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€è·å–å¹³å‡åˆ†ã€‘ è¯·æ±‚å‚æ•°ï¼šresourceId=${resourceId}, resourceType=${resourceType}`);
  const scoreLoading = document.getElementById('scoreLoading');
  scoreLoading.style.display = 'inline';
  
  try {
    const reqUrl = `http://localhost:3000/api/${resourceType}s/${resourceId}/rating/average`;
    console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€è·å–å¹³å‡åˆ†ã€‘ è¯·æ±‚åœ°å€=${reqUrl}`);
    const res = await axios.get(reqUrl, { withCredentials: true });
    console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€è·å–å¹³å‡åˆ†ã€‘ è¯·æ±‚æˆåŠŸï¼Œå“åº”æ•°æ®=`, res.data);
    if (res.data.code === 200) {
      const { averageScore, ratingCount } = res.data.data;
      console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€è·å–å¹³å‡åˆ†ã€‘ è§£æåˆ°è¯„åˆ†æ•°æ®ï¼šå¹³å‡åˆ†=${averageScore}, è¯„åˆ†äººæ•°=${ratingCount}`);
      document.getElementById('averageScore').textContent = averageScore || '0.0';
      document.getElementById('ratingCount').textContent = `${ratingCount || 0} äººå‚ä¸`;
    }
  } catch (err) {
    console.error(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€è·å–å¹³å‡åˆ†ã€‘ è·å–è¯„åˆ†å¤±è´¥, é”™è¯¯è¯¦æƒ…=`, err);
  } finally {
    scoreLoading.style.display = 'none';
    console.groupEnd();
  }
}

/**
 * è·å–ç”¨æˆ·å½“å‰å¯¹è¯¥èµ„æºçš„è¯„åˆ†
 */
async function getUserCurrentRating() {
  console.group(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€ç”¨æˆ·è¯„åˆ†ã€‘ å¼€å§‹è·å–ç”¨æˆ·å½“å‰è¯„åˆ†`);
  // ========== é‡ç‚¹TOKENæ—¥å¿— ==========
  const token = localStorage.getItem('music_user_token');
  const desensitizeToken = token ? `${token.slice(0,8)}****${token.slice(-8)}` : 'æ— TOKEN';
  console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€ç”¨æˆ·è¯„åˆ†ã€‘ TOKEN=${desensitizeToken}, TOKENæ˜¯å¦å­˜åœ¨=${!!token}, resourceId=${resourceId}`);

  if (!token || !resourceId) {
    console.warn(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€ç”¨æˆ·è¯„åˆ†ã€‘ TOKENæˆ–resourceIdä¸ºç©ºï¼Œç»ˆæ­¢è¯·æ±‚`);
    console.groupEnd();
    return;
  }

  try {
    const reqUrl = `http://localhost:3000/api/user/${resourceType}s/${resourceId}/rating`;
    console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€ç”¨æˆ·è¯„åˆ†ã€‘ è¯·æ±‚åœ°å€=${reqUrl}`);
    const res = await axios.get(reqUrl, {
      headers: { 'Authorization': `Bearer ${token}` },
      withCredentials: true
    });
    console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€ç”¨æˆ·è¯„åˆ†ã€‘ è¯·æ±‚æˆåŠŸï¼Œå“åº”æ•°æ®=`, res.data);
    if (res.data.code === 200 && res.data.data.score) {
      selectedScore = res.data.data.score;
      console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€ç”¨æˆ·è¯„åˆ†ã€‘ ç”¨æˆ·å·²è¯„åˆ†ï¼Œè¯„åˆ†æ˜Ÿçº§=${selectedScore}`);
      updateStarDisplay(selectedScore);
      document.getElementById('ratingTip').textContent = `å·²è¯„åˆ†ï¼š${selectedScore} æ˜Ÿ (å¯ä¿®æ”¹)`;
      document.getElementById('ratingSubmit').disabled = false;
    } else {
      console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€ç”¨æˆ·è¯„åˆ†ã€‘ ç”¨æˆ·æœªå¯¹è¯¥èµ„æºè¯„åˆ†`);
    }
  } catch (err) {
    console.warn(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€ç”¨æˆ·è¯„åˆ†ã€‘ è·å–ç”¨æˆ·è¯„åˆ†å¤±è´¥(ç”¨æˆ·æœªè¯„åˆ†)ï¼Œé™é»˜å¤„ç†ï¼Œé”™è¯¯=`, err);
  }
  console.groupEnd();
}

/**
 * æ›´æ–°æ˜Ÿçº§æ˜¾ç¤º
 * @param {number} score - è¯„åˆ†æ˜Ÿçº§
 */
function updateStarDisplay(score) {
  console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€æ˜Ÿçº§æ›´æ–°ã€‘ æ›´æ–°æ˜Ÿçº§æ˜¾ç¤ºï¼Œé€‰ä¸­æ˜Ÿçº§=${score}`);
  const stars = document.querySelectorAll('.star');
  stars.forEach(s => {
    s.classList.toggle('active', parseFloat(s.dataset.score) <= score);
  });
}

/**
 * åˆå§‹åŒ–æ˜Ÿçº§è¯„åˆ†ç³»ç»Ÿ
 */
function initRatingSystem() {
  console.group(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€åˆå§‹åŒ–ã€‘ å¼€å§‹åˆå§‹åŒ–æ˜Ÿçº§è¯„åˆ†ç³»ç»Ÿ`);
  const stars = document.querySelectorAll('.star');
  const submitBtn = document.getElementById('ratingSubmit');
  const tip = document.getElementById('ratingTip');
  // ========== é‡ç‚¹TOKENæ—¥å¿— ==========
  const token = localStorage.getItem('music_user_token');
  const desensitizeToken = token ? `${token.slice(0,8)}****${token.slice(-8)}` : 'æ— TOKEN';
  console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€åˆå§‹åŒ–ã€‘ TOKEN=${desensitizeToken}, TOKENæ˜¯å¦å­˜åœ¨=${!!token}`);

  if (!token) {
    console.warn(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€åˆå§‹åŒ–ã€‘ TOKENä¸ºç©ºï¼Œæ˜¾ç¤ºç™»å½•æç¤º`);
    tip.innerHTML = '<a href="login.html" style="color:var(--primary)">è¯·å…ˆç™»å½•åå†è¯„åˆ†</a>';
    console.groupEnd();
    return;
  }

  console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€åˆå§‹åŒ–ã€‘ TOKENæœ‰æ•ˆï¼Œåˆå§‹åŒ–è¯„åˆ†äº‹ä»¶ç»‘å®š`);
  tip.textContent = "é€‰æ‹©æ˜Ÿçº§æäº¤è¯„åˆ†";

  stars.forEach(star => {
    star.addEventListener('mouseenter', () => {
      const hoverScore = star.dataset.score;
      stars.forEach(s => s.classList.toggle('hover', s.dataset.score <= hoverScore));
    });

    star.addEventListener('mouseleave', () => {
      stars.forEach(s => s.classList.remove('hover'));
      // æ¢å¤å·²é€‰æ˜Ÿçº§æ˜¾ç¤º
      updateStarDisplay(selectedScore);
    });

    star.addEventListener('click', () => {
      selectedScore = parseFloat(star.dataset.score);
      console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€æ˜Ÿçº§é€‰æ‹©ã€‘ ç”¨æˆ·ç‚¹å‡»é€‰æ‹©æ˜Ÿçº§=${selectedScore}`);
      updateStarDisplay(selectedScore);
      submitBtn.disabled = false;
      tip.textContent = `å‡†å¤‡æäº¤ï¼š${selectedScore} æ˜Ÿ`;
    });
  });

  submitBtn.onclick = async () => {
    console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€æäº¤è¯„åˆ†ã€‘ ç”¨æˆ·ç‚¹å‡»æäº¤è¯„åˆ†ï¼Œæ˜Ÿçº§=${selectedScore}`);
    submitBtn.disabled = true;
    submitBtn.textContent = "æäº¤ä¸­...";
    
    try {
      const reqUrl = `http://localhost:3000/api/${resourceType}s/${resourceId}/rating`;
      console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€æäº¤è¯„åˆ†ã€‘ è¯·æ±‚åœ°å€=${reqUrl}, è¯·æ±‚å‚æ•°={score:${selectedScore}}`);
      const res = await axios.post(reqUrl, 
        { score: selectedScore },
        { 
          headers: { 'Authorization': `Bearer ${token}` },
          withCredentials: true 
        }
      );
      console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€æäº¤è¯„åˆ†ã€‘ è¯·æ±‚æˆåŠŸï¼Œå“åº”æ•°æ®=`, res.data);

      if (res.data.code === 200) {
        console.log(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€æäº¤è¯„åˆ†ã€‘ è¯„åˆ†æäº¤æˆåŠŸ`);
        tip.textContent = "è¯„åˆ†æˆåŠŸï¼æ­£åœ¨åŒæ­¥æ•°æ®...";
        setTimeout(async () => {
          await getResourceRating();
          submitBtn.textContent = "æäº¤æˆ‘çš„è¯„åˆ†";
          submitBtn.disabled = false;
          tip.textContent = `å·²è¯„åˆ†ï¼š${selectedScore} æ˜Ÿ (å¯ä¿®æ”¹)`;
        }, 600);
      }
    } catch (err) {
      console.error(`ã€è¯„åˆ†åŠŸèƒ½ã€‘ã€æäº¤è¯„åˆ†ã€‘ è¯„åˆ†å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…=`, err);
      alert("è¯„åˆ†å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
      submitBtn.disabled = false;
      submitBtn.textContent = "æäº¤æˆ‘çš„è¯„åˆ†";
    }
  };
  console.groupEnd();
}

// ========== è¯„è®ºç‚¹èµæ ¸å¿ƒå‡½æ•° ã€é‡ç‚¹æ—¥å¿—åŒºåŸŸ é‡ä¸­ä¹‹é‡ã€‘ ==========
/**
 * å¤„ç†è¯„è®º/å›å¤ç‚¹èµé€»è¾‘ï¼ˆä¿®å¤ï¼šæœªç™»å½•ç¦æ­¢ä»»ä½•ç‚¹èµ/å–æ¶ˆç‚¹èµæ“ä½œï¼Œæ— tokenä¸å¯ä¿®æ”¹ä»»ä½•çŠ¶æ€ï¼‰
 * @param {string} commentId - è¯„è®º/å›å¤ID
 * @param {HTMLElement} likeBtn - ç‚¹èµæŒ‰é’®DOMå…ƒç´ 
 * @param {HTMLElement} heartIcon - çº¢å¿ƒå›¾æ ‡DOMå…ƒç´ 
 * @param {HTMLElement} likeCountEl - ç‚¹èµæ•°æ˜¾ç¤ºDOMå…ƒç´ 
 */

async function handleCommentLike(commentId, likeBtn, heartIcon, likeCountEl) {
  // ========== å¼€å¯åˆ†ç»„æ—¥å¿—ï¼Œç‚¹èµå…¨é“¾è·¯æ—¥å¿— ==========
  console.group(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€ç‚¹èµæ“ä½œã€‘ å¼€å§‹æ‰§è¡Œç‚¹èµ/å–æ¶ˆç‚¹èµï¼Œç›®æ ‡ID=${commentId}`);
  // ========== é‡ç‚¹TOKENæ—¥å¿— - æœ€æ ¸å¿ƒæ ¡éªŒ ==========
  const token = localStorage.getItem('music_user_token');
  const desensitizeToken = token ? `${token.slice(0,8)}****${token.slice(-8)}` : 'æ— TOKEN';
  console.log(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€TOKENæ ¡éªŒã€‘ æœ¬åœ°TOKEN=${desensitizeToken}, TOKENæ˜¯å¦å­˜åœ¨=${!!token}`);
  
  // ğŸ”¥ æ ¸å¿ƒä¿®å¤1ï¼šå¼ºåŒ–æƒé™æ ¡éªŒï¼Œæœªç™»å½•ï¼ˆæ— tokenï¼‰æ—¶ï¼Œç›´æ¥ç¦æ­¢æ‰€æœ‰æ“ä½œï¼ˆåŒ…æ‹¬UIä¹è§‚æ›´æ–°ï¼‰
  if (!token) {
    console.error(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€TOKENæ ¡éªŒã€‘ TOKENä¸ºç©ºï¼Œç”¨æˆ·æœªç™»å½•ï¼Œç¦æ­¢ç‚¹èµæ“ä½œï¼Œå¼¹å‡ºé”™è¯¯æç¤º`);
    showCommentTip('è¯·å…ˆç™»å½•åå†è¿›è¡Œç‚¹èµ/å–æ¶ˆç‚¹èµæ“ä½œ', 'error');
    likeBtn.disabled = true;
    likeBtn.style.cursor = 'not-allowed';
    likeBtn.style.opacity = '0.6';
    console.groupEnd();
    return;
  }
  console.log(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€TOKENæ ¡éªŒã€‘ TOKENæœ‰æ•ˆï¼Œç”¨æˆ·å·²ç™»å½•ï¼Œç»§ç»­æ‰§è¡Œç‚¹èµé€»è¾‘`);

  // ä¿®å¤ç‚¹1ï¼šå°†ç‚¹èµæ•°å­—è½¬ä¸ºåˆæ³•æ•°å­—ï¼ˆé¿å…NaNï¼‰ï¼Œè®¾ç½®é»˜è®¤å€¼0ï¼Œé˜²æ­¢è´Ÿæ•°
  const currentLikeCount = parseInt(likeCountEl.textContent || '0', 10);
  console.log(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€æ•°æ®è½¬æ¢ã€‘ åŸå§‹ç‚¹èµæ•°æ–‡æœ¬=${likeCountEl.textContent}, è½¬æ¢åæ•°å­—=${currentLikeCount}, æ˜¯å¦ä¸ºæ•°å­—=${!isNaN(currentLikeCount)}`);
  if (isNaN(currentLikeCount)) {
    console.warn(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€æ•°æ®è½¬æ¢ã€‘ ç‚¹èµæ•°è½¬æ¢å¤±è´¥ä¸ºNaNï¼Œé‡ç½®ä¸º0`);
    likeCountEl.textContent = '0';
    console.groupEnd();
    return;
  }

  // 1. ä¹è§‚æ›´æ–°UIï¼ˆä»…å½“æœ‰tokenæ—¶æ‰æ‰§è¡Œï¼Œæœªç™»å½•å·²è¢«æå‰æ‹¦æˆªï¼‰
  const isCurrentlyLiked = heartIcon.classList.contains('liked');
  const newLikeCount = isCurrentlyLiked ? Math.max(0, currentLikeCount - 1) : currentLikeCount + 1;
  console.log(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€ä¹è§‚æ›´æ–°ã€‘ å½“å‰ç‚¹èµçŠ¶æ€=${isCurrentlyLiked ? 'å·²ç‚¹èµ' : 'æœªç‚¹èµ'}, åŸç‚¹èµæ•°=${currentLikeCount}, ä¹è§‚æ›´æ–°å=${newLikeCount}`);
  
  
  likeCountEl.textContent = newLikeCount;
  likeBtn.disabled = true;
  console.log(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€ä¹è§‚æ›´æ–°ã€‘ UIæ›´æ–°å®Œæˆï¼ŒæŒ‰é’®æš‚æ—¶ç¦ç”¨`);

  try {
    // å‘èµ·ç‚¹èµæ¥å£è¯·æ±‚
    const reqUrl = `http://localhost:3000/api/comments/${commentId}/like`;
    console.log(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€æ¥å£è¯·æ±‚ã€‘ è¯·æ±‚åœ°å€=${reqUrl}, è¯·æ±‚æ–¹å¼=POST, è¯·æ±‚ä½“={}`);
    const res = await axios.post(
      reqUrl,
      {},
      {
        withCredentials: true,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );
    console.log(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€æ¥å£å“åº”ã€‘ è¯·æ±‚æˆåŠŸï¼Œå“åº”çŠ¶æ€=${res.status}, å“åº”å®Œæ•´æ•°æ®=`, res.data);

    if (res.data.code === 200) {
      const { isLiked, likeCount } = res.data.data;
      const finalLikeCount = parseInt(likeCount || '0', 10);
      console.log(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€æ¥å£å“åº”ã€‘ è§£æåç«¯æ•°æ®ï¼šæœ€ç»ˆç‚¹èµçŠ¶æ€=${isLiked}, åç«¯è¿”å›ç‚¹èµæ•°=${finalLikeCount}`);
      
      // åŒæ­¥åç«¯è¿”å›çš„æœ€ç»ˆçŠ¶æ€
      heartIcon.classList.toggle('liked', isLiked);
      console.log(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€çŠ¶æ€åŒæ­¥ã€‘ åŒæ­¥åç«¯ç‚¹èµçŠ¶æ€å®Œæˆï¼Œçº¢å¿ƒæ ·å¼æ›´æ–°ä¸º=${isLiked}`);
      
      // ä»…å½“åç«¯è¿”å›æ•°æ®éæ³•æ—¶ï¼Œæ‰é‡ç½®ç‚¹èµæ•°
      if (isNaN(finalLikeCount)) {
        console.warn(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€æ•°æ®å¼‚å¸¸ã€‘ åç«¯è¿”å›ç‚¹èµæ•°éæ³•ä¸ºNaNï¼Œé‡ç½®ä¸º0`);
        likeCountEl.textContent = '0';
      }
    } else {
      console.warn(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€æ¥å£å“åº”ã€‘ æ¥å£è¿”å›ä¸šåŠ¡å¤±è´¥ï¼Œcode=${res.data.code}, msg=${res.data.msg}`);
      showCommentTip(`ç‚¹èµå¤±è´¥ï¼š${res.data.msg}`, 'error');
    }
  } catch (err) {
    console.error(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€æ¥å£å¼‚å¸¸ã€‘ ç‚¹èµæ¥å£è¯·æ±‚å¤±è´¥ï¼Œå®Œæ•´é”™è¯¯ä¿¡æ¯=`, err);
    console.log(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€å›æ»šæ“ä½œã€‘ è¯·æ±‚å¤±è´¥ï¼Œæ‰§è¡ŒUIçŠ¶æ€å›æ»š`);
    // å›æ»šUIçŠ¶æ€
    heartIcon.classList.toggle('liked', isCurrentlyLiked);
    likeCountEl.textContent = currentLikeCount;
    showCommentTip('ç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
  } finally {
    // ç™»å½•çŠ¶æ€ä¸‹ï¼Œæ“ä½œå®Œæˆåæ¢å¤æŒ‰é’®å¯ç”¨
    if (token) {
      likeBtn.disabled = false;
      likeBtn.style.cursor = 'pointer';
      likeBtn.style.opacity = '1';
      console.log(`ã€ç‚¹èµæ ¸å¿ƒã€‘ã€æ“ä½œå®Œæˆã€‘ ç‚¹èµæµç¨‹ç»“æŸï¼Œæ¢å¤æŒ‰é’®å¯ç”¨çŠ¶æ€`);
    }
    console.groupEnd();
  }
}

// ========== å›å¤ç›¸å…³å‡½æ•° ã€é‡ç‚¹æ—¥å¿—åŒºåŸŸ å›å¤å…¨é“¾è·¯ã€‘ ==========
/**
 * åŠ è½½æŒ‡å®šçˆ¶è¯„è®ºçš„å­è¯„è®ºï¼ˆè°ƒç”¨æ¥å£ï¼‰
 * @param {string} commentId - çˆ¶è¯„è®ºID
 * @param {number} page - é¡µç ï¼Œé»˜è®¤1
 * @param {number} pageSize - æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10ï¼ˆæœ€å¤§50ï¼‰
 * @returns {Promise<Object>} å­è¯„è®ºæ•°æ®ï¼ˆåŒ…å«parentCommentã€repliesã€paginationï¼‰
 */

async function loadCommentReplies(commentId, page = 1, pageSize = 10) {
  console.group(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ å¼€å§‹åŠ è½½çˆ¶è¯„è®ºçš„å›å¤åˆ—è¡¨ï¼Œçˆ¶è¯„è®ºID=${commentId}`);
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ è¯·æ±‚å‚æ•°ï¼špage=${page}, pageSize=${pageSize}`);
  console.log(`vvvvvvv=${commentId}`);
  try {
    // é™åˆ¶pageSizeæœ€å¤§ä¸º50ï¼ˆæ¥å£è¦æ±‚ï¼‰
    const reqParams = { 
  sortBy: 'like',    // æŒ‰ç‚¹èµæ•°æ’åº
  order: 'desc'      // é™åºæ’åˆ—
};
    const safePageSize = Math.min(pageSize, 50);
    const reqUrl = `http://localhost:3000/api/comments/${commentId}/replies?page=${page}&pageSize=${safePageSize}`;
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ è¯·æ±‚åœ°å€=${reqUrl}`);
    const response = await axios.get(reqUrl, {
      params: reqParams,
      withCredentials: true,
      headers: {
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache'
      }
    });
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ è¯·æ±‚æˆåŠŸï¼Œå“åº”çŠ¶æ€=${response.status}, å“åº”æ•°æ®=`, response.data);
    
    if (response.data.code === 200) {
      const replyCount = response.data.data.pagination?.total || 0;
      console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ åŠ è½½æˆåŠŸï¼Œå…±${replyCount}æ¡å›å¤æ•°æ®`);
      console.groupEnd();
      return response.data.data;
    } else {
      console.warn(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ åŠ è½½å¤±è´¥ï¼Œä¸šåŠ¡é”™è¯¯=${response.data.msg}`);
      showCommentTip(`åŠ è½½å›å¤å¤±è´¥: ${response.data.msg}`, 'error');
      console.groupEnd();
      return null;
    }
  } catch (error) {
    console.error(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ åŠ è½½å­è¯„è®ºæ¥å£è¯·æ±‚å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…=`, error);
    showCommentTip(`åŠ è½½å›å¤å¤±è´¥ï¼šè¯·æ±‚åœ°å€ä¸å­˜åœ¨æˆ–åç«¯æœªå®ç°\n${error.config?.url || 'æœªçŸ¥åœ°å€'}`, 'error');
    console.groupEnd();
    return null;
  }
}
// æ­£ç¡®è·å–çˆ¶è¯„è®ºIDçš„å®Œæ•´ä»£ç 


// è°ƒç”¨ç¤ºä¾‹

/**
 * åˆ‡æ¢å›å¤è¡¨å•æ˜¾ç¤º/éšè—
 * @param {string} commentId - è¯„è®ºID
 * @param {string} replyToName - å›å¤ç›®æ ‡ç”¨æˆ·å
 */
function toggleReplyForm(commentId, replyToName ) {
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€è¡¨å•åˆ‡æ¢ã€‘ åˆ‡æ¢å›å¤è¡¨å•æ˜¾éšï¼Œè¯„è®ºID=${commentId}, å›å¤ç›®æ ‡ç”¨æˆ·=${replyToName || 'æ— '}`);
  const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
  if (!commentItem) {
    console.warn(`ã€å›å¤åŠŸèƒ½ã€‘ã€è¡¨å•åˆ‡æ¢ã€‘ æœªæ‰¾åˆ°è¯„è®ºDOMå…ƒç´ ï¼Œè¯„è®ºID=${commentId}`);
    return;
  }

  const replyForm = commentItem.querySelector('.reply-form');
  const replyInput = replyForm.querySelector('.reply-input');
  const replyLengthTip = replyForm.querySelector('.reply-length-tip');

  // åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
  const isShow = !replyForm.classList.contains('show');
  replyForm.classList.toggle('show');
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€è¡¨å•åˆ‡æ¢ã€‘ è¡¨å•æœ€ç»ˆçŠ¶æ€=${isShow ? 'æ˜¾ç¤º' : 'éšè—'}`);

  // åˆå§‹åŒ–è¾“å…¥æ¡†ï¼ˆå«@ç”¨æˆ·ï¼‰
  if (isShow) {
    //const repliesList = commentItem.querySelector('.replies-list');
    //if (repliesList) repliesList.classList.add('show');
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€è¡¨å•åˆ‡æ¢ã€‘ è¡¨å•æ˜¾ç¤ºï¼Œè‡ªåŠ¨å±•å¼€å›å¤åˆ—è¡¨`);
    
    const placeholder = replyToName ? `å›å¤ @${replyToName}ï¼ˆ1-500å­—ï¼‰...` : 'è¾“å…¥å›å¤å†…å®¹ï¼ˆ1-500å­—ï¼‰...';
    replyInput.placeholder = placeholder;
    replyInput.value = replyToName ? `@${replyToName} ` : '';
    replyLengthTip.textContent = `${replyInput.value.length}/500`;
    replyInput.focus();
  console.log('replyToName2', replyToName);
    // ç»‘å®šå­—æ•°ç»Ÿè®¡
    replyInput.addEventListener('input', function() {
      const length = this.value.trim().length;
      replyLengthTip.textContent = `${length}/500`;
      const submitBtn = replyForm.querySelector('.reply-submit-btn');
      submitBtn.disabled = length < 1 || length > 500;
    });
  } else {
    // éšè—æ—¶æ¸…ç©ºè¾“å…¥æ¡†
    replyInput.value = '';
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€è¡¨å•åˆ‡æ¢ã€‘ è¡¨å•éšè—ï¼Œæ¸…ç©ºè¾“å…¥æ¡†å†…å®¹`);
  }
}

/**
 * åˆ‡æ¢å›å¤åˆ—è¡¨çš„å±•å¼€/æŠ˜å çŠ¶æ€
 * @param {HTMLElement} toggleBtn - åˆ‡æ¢æŒ‰é’®DOMå…ƒç´ 
 * @param {HTMLElement} repliesList - å›å¤åˆ—è¡¨å®¹å™¨
 * @param {number} replyCount - å›å¤æ€»æ•°
 */
function toggleRepliesList(toggleBtn, repliesList, replyCount) {
  const isShow = repliesList.classList.toggle('show');
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€åˆ—è¡¨åˆ‡æ¢ã€‘ å›å¤åˆ—è¡¨çŠ¶æ€=${isShow ? 'å±•å¼€' : 'æŠ˜å '}, å›å¤æ€»æ•°=${replyCount}`);
  // æ›´æ–°æŒ‰é’®æ–‡æœ¬
  if (isShow) {
    toggleBtn.innerHTML = `<span>æ”¶èµ·å›å¤(${replyCount})</span>`;
  } else {
    toggleBtn.innerHTML = `<span>å±•å¼€å›å¤(${replyCount})</span>`;
  }
}

/**
 * å¤„ç†å›å¤æäº¤ï¼ˆä¹è§‚æ›´æ–°ï¼‰ã€å›å¤æ ¸å¿ƒå‡½æ•° é‡ç‚¹æ—¥å¿—ã€‘
 * @param {string} commentId - çˆ¶è¯„è®ºID
 * @param {HTMLElement} replyForm - å›å¤è¡¨å•DOMå…ƒç´ 
 */
async function handleReplySubmit(commentId, replyForm) {
  console.group(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ å¼€å§‹æäº¤å›å¤ï¼Œçˆ¶è¯„è®ºID=${commentId}`);
  // ========== é‡ç‚¹TOKENæ—¥å¿— ==========
  const token = localStorage.getItem('music_user_token');
  const desensitizeToken = token ? `${token.slice(0,8)}****${token.slice(-8)}` : 'æ— TOKEN';
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ TOKEN=${desensitizeToken}, TOKENæ˜¯å¦å­˜åœ¨=${!!token}`);

  if (!token) {
    console.error(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ TOKENä¸ºç©ºï¼Œç”¨æˆ·æœªç™»å½•ï¼Œç¦æ­¢å‘å¸ƒå›å¤`);
    showCommentTip('è¯·å…ˆç™»å½•åå†å‘å¸ƒå›å¤', 'error');
    console.groupEnd();
    return;
  }

  const replyInput = replyForm.querySelector('.reply-input');
  const replySubmitBtn = replyForm.querySelector('.reply-submit-btn');
  const replyContent = replyInput.value.trim();
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ å›å¤å†…å®¹=${replyContent}, å†…å®¹é•¿åº¦=${replyContent.length}`);

  // éªŒè¯å†…å®¹é•¿åº¦
  if (replyContent.length < 1 || replyContent.length > 500) {
    console.warn(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ å†…å®¹é•¿åº¦æ ¡éªŒå¤±è´¥ï¼Œé•¿åº¦=${replyContent.length}ï¼Œè¦æ±‚1-500å­—`);
    showCommentTip('å›å¤å†…å®¹è¯·æ§åˆ¶åœ¨1-500å­—ä¹‹é—´', 'error');
    console.groupEnd();
    return;
  }

  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆç¼“å­˜ä¼˜å…ˆï¼‰
  let user = getUserFromCache();
  if (!user) {
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ æ— ç”¨æˆ·ç¼“å­˜ï¼Œè¯·æ±‚æœ€æ–°ç”¨æˆ·ä¿¡æ¯`);
    user = await getCurrentUserInfo();
    if (!user) {
      console.error(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ ç”¨æˆ·ä¿¡æ¯å¤±æ•ˆï¼Œæ¸…é™¤TOKENå¹¶è·³è½¬ç™»å½•`);
      showCommentTip('ç”¨æˆ·ä¿¡æ¯å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•', 'error');
      localStorage.removeItem('music_user_token');
      clearUserCache();
      setTimeout(() => location.href = "login.html", 1000);
      console.groupEnd();
      return;
    }
  }
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ è·å–åˆ°ç”¨æˆ·ä¿¡æ¯=`, user);

  // æå–@ç›®æ ‡ç”¨æˆ·ï¼ˆç®€åŒ–å¤„ç†ï¼‰
  let replyToName = '';
  let replyToUserId = '';
  if (replyInput.value.startsWith('@')) {
    const match = replyInput.value.match(/@([^\s]+)\s/);
    if (match) {
      replyToName = match[1];
      replyToUserId = commentId + '_' + replyToName;
    }
  }
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ å›å¤ç›®æ ‡ç”¨æˆ·=${replyToName}, ç›®æ ‡ç”¨æˆ·ID=${replyToUserId}`);

  const tempReplyId = `temp_${Date.now()}`;
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ ç”Ÿæˆä¸´æ—¶å›å¤ID=${tempReplyId}ï¼Œå¼€å§‹ä¹è§‚æ›´æ–°UI`);

  // 1. æ„å»ºä¸´æ—¶å›å¤æ•°æ®ï¼ˆä¹è§‚æ›´æ–°ç”¨ï¼‰
  const tempReply = {
    _id: tempReplyId,
    username: user.username,
    nick_name: user.nick_name,
    avatar: user.avatar,
    content: replyContent,
    likeCount: 0,
    likedByMe: false,
    parent_id: commentId,
    reply_to_user_id: replyToUserId,
    reply_to_name: replyToName,
    createdAt: new Date().toISOString(),
    isTemp: true
  };

  // 2. ä¹è§‚æ›´æ–°UIï¼šæ·»åŠ ä¸´æ—¶å›å¤åˆ°åˆ—è¡¨
  const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
  if (!commentItem) {
    console.error(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ æœªæ‰¾åˆ°çˆ¶è¯„è®ºDOMå…ƒç´ ï¼Œè¯„è®ºID=${commentId}`);
    showCommentTip('è¯„è®ºé¡¹ä¸å­˜åœ¨ï¼Œæ— æ³•å‘å¸ƒå›å¤', 'error');
    console.groupEnd();
    return;
  }

  let repliesList = commentItem.querySelector('.replies-list');
  const emptyRepliesTip = commentItem.querySelector('.empty-replies-tip');
  let isNewRepliesList = false;
  if (!repliesList) {
    isNewRepliesList = true;
    repliesList = document.createElement('div');
    repliesList.className = 'replies-list';
    if (emptyRepliesTip) {
      emptyRepliesTip.parentNode.replaceChild(repliesList, emptyRepliesTip);
    } else {
      const commentActions = commentItem.querySelector('.comment-actions');
      if (commentActions) {
        commentActions.parentNode.insertBefore(repliesList, commentActions.nextSibling);
      } else {
        showCommentTip('è¯„è®ºæ“ä½œæ ä¸å­˜åœ¨ï¼Œæ— æ³•å‘å¸ƒå›å¤', 'error');
        console.groupEnd();
        return;
      }
    }
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ æœªæ‰¾åˆ°å›å¤åˆ—è¡¨ï¼Œæ–°å»ºå›å¤åˆ—è¡¨å®¹å™¨`);
  }

  // å‘å¸ƒæ–°å›å¤æ—¶ï¼Œè‡ªåŠ¨å±•å¼€å›å¤åˆ—è¡¨
  repliesList.classList.add('show');
 if (emptyRepliesTip) emptyRepliesTip.style.display = 'none'; 
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ å±•å¼€å›å¤åˆ—è¡¨ï¼Œéšè—ç©ºæç¤º`);

  // æ¸²æŸ“ä¸´æ—¶å›å¤
  const tempReplyEl = renderReplyItem(tempReply, repliesList, true);
  console.log('aaaaaaaaaaaaaaaaaaaaa');
  console.log(commentId);
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ ä¸´æ—¶å›å¤æ¸²æŸ“å®Œæˆï¼ŒDOMå…ƒç´ =`, tempReplyEl);

  // æ›´æ–°å›å¤æ•°é‡æŒ‰é’®çš„è®¡æ•°
 const toggleBtn = commentItem.querySelector('.toggle-replies-btn');
  if (toggleBtn) {
    const currentCount = parseInt(toggleBtn.dataset.replyCount || '0', 10);
    toggleBtn.dataset.replyCount = currentCount + 1;
    // ğŸ”¥ ä¿®æ”¹ï¼šå›å¤åä¿æŒå±•å¼€çŠ¶æ€ï¼Œä¸è‡ªåŠ¨å˜æˆæ”¶èµ·çŠ¶æ€
    toggleBtn.innerHTML = `<span>å±•å¼€å›å¤(${currentCount + 1})</span>`;
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ æ›´æ–°å›å¤æ•°é‡ï¼ŒåŸæ•°é‡=${currentCount}ï¼Œæ–°æ•°é‡=${currentCount+1}`);
  }

  // 3. æ¸…ç©ºå›å¤è¾“å…¥æ¡†å¹¶ç¦ç”¨æŒ‰é’®
  replyInput.value = '';
  replyForm.querySelector('.reply-length-tip').textContent = '0/500';
  replySubmitBtn.disabled = true;
  replySubmitBtn.textContent = 'å‘å¸ƒä¸­...';
  console.log(`ã€å›å¤åŠŸèƒ½ã€æäº¤å›å¤ã€‘ æ¸…ç©ºè¾“å…¥æ¡†ï¼ŒæŒ‰é’®ç½®ä¸ºå‘å¸ƒä¸­çŠ¶æ€`);
  console.log(`${commentId}`);
  console.log('replyToName3', replyToName);
  try {
    // 4. å‘é€åç«¯è¯·æ±‚
    const reqUrl = `http://localhost:3000/api/comments/${commentId}/reply`;
    const reqData = { content: replyContent, reply_to_user_id: replyToUserId, reply_to_name: replyToName };
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ å‘èµ·åç«¯è¯·æ±‚ï¼Œåœ°å€=${reqUrl}, è¯·æ±‚å‚æ•°=`, reqData);
    const res = await axios.post(
      reqUrl, reqData,
      {
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        withCredentials: true
      }
    );
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ è¯·æ±‚æˆåŠŸï¼Œå“åº”çŠ¶æ€=${res.status}, å“åº”æ•°æ®=`, res.data);

    if (res.data.code === 200) {
      const { commentId: realReplyId, parent_id: realParentId = commentId } = res.data.data;
      const a = res.data.data.replyId;
      console.log(a);
      console.log(res.data.data);
      console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ å›å¤å‘å¸ƒæˆåŠŸï¼ŒçœŸå®å›å¤ID=${realReplyId}, çœŸå®çˆ¶ID=${realParentId}`);
      showCommentTip('å›å¤å‘å¸ƒæˆåŠŸï¼');

      // å…³é”®ä¿®å¤ï¼šæ›¿æ¢ä¸´æ—¶å›å¤IDä¸ºçœŸå®ID
      const tempReplyEl = repliesList.querySelector(`.reply-item[data-reply-id="${tempReplyId}"]`);
      if (tempReplyEl) {
        tempReplyEl.dataset.replyId = realReplyId;
        tempReplyEl.dataset.parentId = realParentId;
        const likeBtn = tempReplyEl.querySelector(`.like-btn[data-reply-id="${tempReplyId}"]`);
        if (likeBtn) {
          likeBtn.dataset.replyId = a;
          likeBtn.dataset.parentId = realParentId;
        }
        const deleteBtn = tempReplyEl.querySelector(`.delete-btn[data-reply-id="${tempReplyId}"]`);
        if (deleteBtn) {
          deleteBtn.dataset.replyId = a;
          deleteBtn.dataset.parentId = realParentId;
        }
        tempReplyEl.classList.remove('temp-reply');
        tempReplyEl.setAttribute('data-parent-comment-id', realParentId);
        console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ ä¸´æ—¶å›å¤IDæ›¿æ¢å®Œæˆï¼Œæ›´æ–°ä¸ºçœŸå®ID=${realReplyId}`);
      }

      // éšè—å›å¤è¡¨å•
      replyForm.classList.remove('show');
      console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ éšè—å›å¤è¡¨å•`);
    }
  } catch (err) {
    console.error(`ã€å›å¤åŠŸèƒ½ã€‘wqã€æäº¤å›å¤ã€‘ å›å¤å‘å¸ƒå¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…=`, err);
    // 6. è¯·æ±‚å¤±è´¥ï¼Œå›æ»šUIï¼šç§»é™¤ä¸´æ—¶å›å¤
    const tempReplyEl = repliesList.querySelector(`.reply-item[data-reply-id="${tempReplyId}"]`);
    if (tempReplyEl) tempReplyEl.remove();
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ è¯·æ±‚å¤±è´¥ï¼Œå›æ»šUIï¼Œç§»é™¤ä¸´æ—¶å›å¤`);

    // å›æ»šå›å¤æ•°é‡è®¡æ•°
    if (toggleBtn) {
      const currentCount = parseInt(toggleBtn.dataset.replyCount || '1', 10);
      const newCount = Math.max(0, currentCount - 1);
      toggleBtn.dataset.replyCount = newCount;
      toggleBtn.innerHTML = newCount > 0 ? `<span>å±•å¼€å›å¤(${newCount})</span>` : `<span>å±•å¼€å›å¤</span>`;
      console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ å›æ»šå›å¤æ•°é‡ï¼ŒåŸæ•°é‡=${currentCount}ï¼Œæ–°æ•°é‡=${newCount}`);
    }

    // ä¿®å¤å¤±è´¥åæ¢å¤â€œæš‚æ— å›å¤â€æç¤ºçš„é€»è¾‘
    if (repliesList.children.length === 0) {
      if (emptyRepliesTip && isNewRepliesList) {
        repliesList.parentNode.replaceChild(emptyRepliesTip, repliesList);
      } else if (emptyRepliesTip) {
        emptyRepliesTip.style.display = 'block';
      }
      repliesList.classList.remove('show');
      console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ å›å¤åˆ—è¡¨ä¸ºç©ºï¼Œæ¢å¤ç©ºæç¤ºå¹¶æŠ˜å åˆ—è¡¨`);
    }

    showCommentTip('å›å¤å‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    replySubmitBtn.textContent = 'å‘å¸ƒå›å¤';
    replySubmitBtn.disabled = false;
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€æäº¤å›å¤ã€‘ å›å¤æµç¨‹ç»“æŸï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€`);
    console.groupEnd();
  }
}


/**
 * æ¸²æŸ“å›å¤å¤´éƒ¨ï¼ˆåŒºåˆ†ï¼šå›å¤æ¥¼ä¸» / å›å¤æŸäººï¼‰
 */
function renderReplyHeader(reply) {
  // å…¼å®¹åç«¯æ‰€æœ‰ç©ºå€¼æƒ…å†µï¼šç©ºå­—ç¬¦ä¸²/undefined/null éƒ½åˆ¤å®šä¸ºã€å›å¤çˆ¶è¯„è®º/æ¥¼ä¸»ã€‘
  if (!reply.reply_to_user_id || reply.reply_to_user_id === '' || reply.reply_to_user_id === 'null' || reply.reply_to_user_id === 'undefined') {
    const userName = reply.nick_name || reply.username || 'åŒ¿åç”¨æˆ·';
    return `<span class="reply-nickname">${userName}</span>`;
  }
  // æœ‰å€¼ = å›å¤æŸæ¡å›å¤/æŸä¸ªç”¨æˆ·ï¼Œæ­£å¸¸æ¸²æŸ“@
  const userName = reply.nick_name || reply.username || 'åŒ¿åç”¨æˆ·';
  const replyToName = reply.reply_to_name || 'åŒ¿åç”¨æˆ·';
  console.log('replyToName1', replyToName);
  return `
    <span class="reply-nickname">${userName}</span>
    <span class="reply-to">å›å¤</span>
    <span class="reply-at-user">@${replyToName}</span>
  `;

}


function renderReplyItem(reply, container, insertToTop = false) {
  console.group(`ã€å›å¤æ¸²æŸ“ã€‘ã€å­å›å¤æ¸²æŸ“ã€‘ å¼€å§‹æ¸²æŸ“å•æ¡å›å¤ï¼Œå›å¤ID=${reply._id}, çˆ¶è¯„è®ºID=${reply.parent_id}`);
  if (!reply || !container) {
    console.error(`ã€å›å¤æ¸²æŸ“ã€‘ã€å­å›å¤æ¸²æŸ“ã€‘ å›å¤æ•°æ®æˆ–å®¹å™¨ä¸ºç©ºï¼Œç»ˆæ­¢æ¸²æŸ“`);
    console.groupEnd();
    return null;
  }

  // ========== âœ…ã€æ–°å¢æ ¸å¿ƒæ–¹æ³•ã€‘ä¸¥æ ¼æŒ‰ä½ çš„è¦æ±‚å®ç° - åŒºåˆ†å›å¤ç±»å‹æ¸²æŸ“å¤´éƒ¨ ==========

  // åˆ›å»ºå›å¤DOMèŠ‚ç‚¹
  const replyItem = document.createElement('div');
  replyItem.className = `reply-item ${reply.isTemp ? 'temp-reply' : ''}`;
  replyItem.dataset.replyId = reply._id;
  replyItem.dataset.parentId = reply.parent_id;

  // è·å–å½“å‰ç¼“å­˜ç”¨æˆ·ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±çš„å›å¤
// ========== âœ… å®Œç¾å¤åˆ»çˆ¶è¯„è®ºå¤´åƒå†™æ³•ã€åŸç”ŸDOMåˆ›å»ºï¼Œé›¶è¯­æ³•é”™è¯¯ã€‘ ==========
const cacheUser = getUserFromCache();
const isCurrentUserReply = cacheUser && cacheUser.username === reply.username;
const userName = isCurrentUserReply ? cacheUser.nick_name : (reply.nick_name || reply.username || "åŒ¿åç”¨æˆ·");
const avatarUrl = isCurrentUserReply ? cacheUser.avatar : reply.avatar;

// åˆ›å»ºå¤´åƒå®¹å™¨ã€å’Œçˆ¶è¯„è®ºå®Œå…¨ä¸€è‡´çš„å†™æ³•ã€‘
const avatarDiv = document.createElement("div");
avatarDiv.className = "reply-avatar"; // æ³¨æ„è¿™é‡Œæ˜¯ reply-avatar å¯¹åº”å›å¤çš„æ ·å¼ï¼Œçˆ¶è¯„è®ºæ˜¯ comment-avatar
if (avatarUrl) {
  const img = document.createElement("img");
  img.src = avatarUrl;
  img.alt = `${userName}çš„å¤´åƒ`;
  img.onerror = () => {
    avatarDiv.innerHTML = getDefaultAvatar(userName);
  };
  avatarDiv.appendChild(img);
} else {
  avatarDiv.innerHTML = getDefaultAvatar(userName);
}

  // âœ…ã€ä¿®å¤ã€‘å½»åº•åˆ é™¤åŸæœ‰çš„contenté‡Œçš„@æ‹¼æ¥é€»è¾‘ï¼Œé¿å…é‡å¤æ¸²æŸ“ï¼Œå†…å®¹åŸæ ·å±•ç¤ºå³å¯
  let replyContent = reply.content || 'æ— å†…å®¹';

  // ä¿®å¤ï¼šå›å¤ç‚¹èµæ•°é»˜è®¤å€¼0ï¼Œé¿å…NaN
  const replyLikeCount = parseInt(reply.likeCount || '0', 10);

  // âœ…ã€æ ¸å¿ƒä¿®æ”¹ã€‘åªæ”¹ reply-header å†…éƒ¨çš„å†…å®¹ï¼Œå…¶ä½™HTMLç»“æ„ã€æ ·å¼ç±»åã€å±æ€§å®Œå…¨ä¸å˜ï¼ï¼ï¼
// 1. å…ˆæ¸…ç©ºreplyItemï¼Œå†åˆ›å»ºå†…å®¹å®¹å™¨ï¼Œå»æ‰å¤´åƒçš„å­—ç¬¦ä¸²æ’å€¼
async function like() {

  try{  
    console.log(reply);
    const isLiked = await checkCommentLikeStatus(reply._id);
  reply.likedByMe = isLiked;}
  catch(e){console.error('è¯„è®ºåŠ è½½å¤±è´¥',err)}
  replyItem.innerHTML = `
  <div class="reply-content-wrapper">
    <div class="reply-header">
      ${renderReplyHeader(reply)}
      <span class="reply-time">${formatCommentTime(reply.createdAt)}</span>
    </div>
    <div class="reply-content">${replyContent}</div>
    <div class="reply-actions">
      <button class="like-btn" data-reply-id="${reply._id}">
        <span class="heart-icon ${reply.likedByMe ? 'liked' : ''}">â¤ï¸</span>
        <span class="reply-like-count">${isNaN(replyLikeCount) ? 0 : replyLikeCount}</span>
      </button>
      <button class="reply-btn reply-to-reply-btn" data-reply-id="${reply._id}" data-parent-id="${reply.parent_id}" data-reply-to="${userName}">
        <span>ğŸ’¬</span><span>å›å¤</span>
        
      </button>
    </div>
  </div>
`;

// 2. åŸç”Ÿè¿½åŠ å¤´åƒèŠ‚ç‚¹åˆ°æœ€å‰é¢ ã€å’Œçˆ¶è¯„è®ºå®Œå…¨ä¸€è‡´çš„appendChildé€»è¾‘ã€‘
replyItem.insertBefore(avatarDiv, replyItem.firstChild);

  // æ’å…¥åˆ°å®¹å™¨çš„é¡¶éƒ¨/åº•éƒ¨
  if (insertToTop) {
    container.insertBefore(replyItem, container.firstChild);
    replyItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  } else {
    container.appendChild(replyItem);
  }

  let user = getUserFromCache();
if (!user) {
    user = await getCurrentUserInfo();
    if (!user) {
        // ç”¨æˆ·ä¿¡æ¯å¤±æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•
        localStorage.removeItem('music_user_token');
        clearUserCache();
        // è·³è½¬åˆ°ç™»å½•é¡µ
    }
}
  //ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
const deleteBtn = document.createElement('button');
  deleteBtn.className = 'delete-btn';
  deleteBtn.textContent = 'åˆ é™¤';
  deleteBtn.setAttribute('data-reply-id', reply._id);
  const actions = replyItem.querySelector('.reply-actions');
  if(reply.username ===  user.username){
    actions.appendChild(deleteBtn);
  }
 deleteBtn.addEventListener('click', async () => {
  try {
    replyItem.remove();
     deleteComment(deleteBtn.dataset.replyId);
    // æ›´æ–°åˆ†é¡µ
    renderCommentsPagination();
  } catch (error) {
    console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
    showErrorToast('åˆ é™¤è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
});
  // ========== ç»‘å®šå›å¤çš„ç‚¹èµäº‹ä»¶ ==========
  const likeBtn = replyItem.querySelector(`.like-btn[data-reply-id="${reply._id}"]`);
  const heartIcon = replyItem.querySelector('.heart-icon');
  const likeCountEl = replyItem.querySelector('.reply-like-count');
  if (likeBtn && heartIcon && likeCountEl) {
    likeBtn.addEventListener('click', () => {
      const realReplyId = likeBtn.dataset.replyId;
      handleCommentLike(realReplyId, likeBtn, heartIcon, likeCountEl);
    });
    heartIcon.classList.toggle('liked', reply.likedByMe);
    console.log(`ã€å›å¤æ¸²æŸ“ã€‘ã€å­å›å¤æ¸²æŸ“ã€‘ å›å¤ç‚¹èµäº‹ä»¶ç»‘å®šå®Œæˆï¼Œå›å¤ID=${reply._id}`);
  }

  // ========== ç»‘å®šå›å¤çš„å›å¤æŒ‰é’®äº‹ä»¶ ==========
  const replyBtn = replyItem.querySelector('.reply-to-reply-btn');
  if (replyBtn) {
    replyBtn.addEventListener('click', () => {
const parentId = replyBtn.dataset.parentId;
const replyToName = replyBtn.dataset.replyTo;
toggleReplyForm(parentId, replyToName);
    });
    console.log(`ã€å›å¤æ¸²æŸ“ã€‘ã€å­å›å¤æ¸²æŸ“ã€‘ å›å¤çš„å›å¤æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ`);
  }

  console.log(`ã€å›å¤æ¸²æŸ“ã€‘ã€å­å›å¤æ¸²æŸ“ã€‘ å›å¤æ¸²æŸ“å®Œæˆï¼ŒDOMå…ƒç´ æ’å…¥æˆåŠŸ`);
  console.groupEnd();
  return replyItem;
}
like();
};

// ========== è¯„è®ºåˆ—è¡¨ä¸æ¸²æŸ“ç›¸å…³å‡½æ•° ==========
/**
 * åŠ è½½è¯„è®ºåˆ—è¡¨
 * @param {number} page - é¡µç 
 */
async function loadComments(page = 1) {
  console.group(`ã€è¯„è®ºåˆ—è¡¨ã€‘ã€åŠ è½½åˆ—è¡¨ã€‘ å¼€å§‹åŠ è½½è¯„è®ºåˆ—è¡¨ï¼Œé¡µç =${page}, æ¯é¡µæ¡æ•°=${commentPageSize}`);
  const list = document.getElementById("commentsList");
  const loading = document.getElementById("commentsLoading");
  const empty = document.getElementById("emptyComments");

  loading.style.display = "block";
  list.style.display = "none";
  empty.style.display = "none";

  try {
    const reqUrl = `http://localhost:3000/api/${resourceType}s/${resourceId}/comments`;
const reqParams = { 
    page, 
    pageSize: commentPageSize,
    sortBy: 'like',    // æŒ‰ç‚¹èµæ•°æ’åº
    order: 'desc'      // é™åºæ’åˆ—
  }; 
  
  console.log(`ã€è¯„è®ºåˆ—è¡¨ã€‘ã€åŠ è½½åˆ—è¡¨ã€‘ è¯·æ±‚åœ°å€=${reqUrl}, è¯·æ±‚å‚æ•°=`, reqParams); 
  
  const res = await axios.get(reqUrl, { 
    params: reqParams, 
    withCredentials: true, 
    headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' } 
  });
   
    console.log(`aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaã€è¯„è®ºåˆ—è¡¨ã€‘ã€åŠ è½½åˆ—è¡¨ã€‘ è¯·æ±‚æˆåŠŸï¼Œå“åº”æ•°æ®=${resourceType}s/${resourceId}`, res.data);
    

    const { comments, pagination } = res.data.data;
    console.log(res.data.data);
    console.log(`ã€è¯„è®ºåˆ—è¡¨ã€‘ã€åŠ è½½åˆ—è¡¨ã€‘ åŸå§‹è¯„è®ºæ•°æ®å…±${comments.length}æ¡=`, comments);
    
    list.innerHTML = "";

    // ç­›é€‰ä»…çˆ¶è¯„è®ºï¼ˆå­è¯„è®ºé€šè¿‡æ¥å£å•ç‹¬åŠ è½½ï¼‰
    const parentComments = comments.filter(comment => {
      return !comment.parent_id || comment.parent_id === 'null' || comment.parent_id === 'undefined';
    });
    console.log(`ã€è¯„è®ºåˆ—è¡¨ã€‘ã€åŠ è½½åˆ—è¡¨ã€‘ ç­›é€‰åçˆ¶è¯„è®ºå…±${parentComments.length}æ¡`);

    if (parentComments.length === 0) {
      console.log(`ã€è¯„è®ºåˆ—è¡¨ã€‘ã€åŠ è½½åˆ—è¡¨ã€‘ æ— çˆ¶è¯„è®ºï¼Œæ˜¾ç¤ºç©ºæç¤º`);
      empty.style.display = "block";
      list.style.display = "none";
      console.groupEnd();
      return;
    }
    let a =0;
    // æ¸²æŸ“æ‰€æœ‰çˆ¶è¯„è®º
    parentComments.forEach(parentComment => {
      parentComment.parent_id = null;
      console.log(`ã€è¯„è®ºåˆ—è¡¨ã€‘ã€åŠ è½½åˆ—è¡¨ã€‘ åŠ è½½å­è¯„è®ºï¼Œçˆ¶è¯„è®ºID=${parentComment._id}, å­è¯„è®ºå…±${parentComment.replies_total}æ¡`);
      renderCommentItem(parentComment);
      a = a+parentComment.replies_total;
    });
    console.log('parentComments',parentComments);

   document.getElementById("commentsTotalCount").textContent = `${pagination.total+a || 0} æ¡è¯„è®º`;
    totalCommentPages = pagination.totalPages || 0;
    console.log(`ã€è¯„è®ºåˆ—è¡¨ã€‘ã€åŠ è½½åˆ—è¡¨ã€‘ è¯„è®ºæ€»æ•°=${pagination.total}, æ€»é¡µæ•°=${totalCommentPages}`);

    list.style.display = "block";
    empty.style.display = "none";
    renderCommentsPagination();
    console.log(`ã€è¯„è®ºåˆ—è¡¨ã€‘ã€åŠ è½½åˆ—è¡¨ã€‘ åˆ†é¡µæ¸²æŸ“å®Œæˆ`);
  } catch (err) {
    console.error(`ã€è¯„è®ºåˆ—è¡¨ã€‘ã€åŠ è½½åˆ—è¡¨ã€‘ åŠ è½½è¯„è®ºå¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…=`, err);
    loading.textContent = 'åŠ è½½è¯„è®ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•';
    empty.style.display = "none";
    showCommentTip('åŠ è½½è¯„è®ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
  } finally {
    loading.style.display = "none";
    console.groupEnd();
  }
}
// æŸ¥è¯¢å•ä¸ªè¯„è®ºçš„ç‚¹èµçŠ¶æ€
async function checkCommentLikeStatus(commentId) {
  try {
    // è·å–ç”¨æˆ·tokenï¼ˆä»localStorageæˆ–cookieä¸­è·å–ï¼‰
   const token = localStorage.getItem('music_user_token');
    
    if (!token) {
      console.warn('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æŸ¥è¯¢ç‚¹èµçŠ¶æ€');
      return false;
    }
console.log(`xxxxxxx=${commentId}çš„ç‚¹èµçŠ¶æ€`);
    const response = await axios.get(`http://localhost:3000/api/comments/${commentId}/like/status`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    return response.data.data.isLiked; // true: å·²ç‚¹èµ, false: æœªç‚¹èµ
  } catch (error) {
    if (error.response && error.response.status === 401) {
      console.warn('ç”¨æˆ·è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
      // å¯ä»¥åœ¨è¿™é‡Œè§¦å‘é‡æ–°ç™»å½•é€»è¾‘
      handleAuthError();
    } else {
      console.error('æŸ¥è¯¢ç‚¹èµçŠ¶æ€å¤±è´¥:', error);
      console.log(`xxxxxxx=${commentId}çš„ç‚¹èµçŠ¶æ€`);
    }
    return false;
  }
}

// è¾…åŠ©å‡½æ•°ï¼šä»cookieè·å–token
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}

// è®¤è¯é”™è¯¯å¤„ç†å‡½æ•°
function handleAuthError() {
  // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„token
  localStorage.removeItem('userToken');
  // å¯ä»¥è·³è½¬åˆ°ç™»å½•é¡µæˆ–æ˜¾ç¤ºç™»å½•å¼¹çª—
  showLoginModal();
}

const lsID = '';
// åˆ é™¤è¯„è®º
async function deleteComment(commentId) {
  try {
    const token = localStorage.getItem('music_user_token');
    if (!token) {
      throw new Error('ç”¨æˆ·æœªç™»å½•');
    }

    const response = await axios.delete(`http://localhost:3000/api/comments/${commentId}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (response.data.code === 200) {
      return response.data;
    } else {
      throw new Error(response.data.message || 'åˆ é™¤å¤±è´¥');
    }
  } catch (error) {
    throw error;
  }
}
/**
 * æ¸²æŸ“å•æ¡è¯„è®ºï¼ˆå«ç‚¹èµã€å›å¤åˆ—è¡¨ã€å›å¤è¡¨å•ï¼‰
 * @param {Object} comment - è¯„è®ºæ•°æ®
 * @param {boolean} insertToTop - æ˜¯å¦æ’å…¥åˆ°åˆ—è¡¨é¡¶éƒ¨
 */

async function renderCommentItem(comment, insertToTop = false) {
  // æ ¡éªŒçˆ¶è¯„è®ºçš„parent_id
  if (comment.parent_id !== null && comment.parent_id !== undefined) {
    console.error(`ã€è¯„è®ºæ¸²æŸ“ã€‘ã€çˆ¶è¯„è®ºæ¸²æŸ“ã€‘ æ¸²æŸ“é”™è¯¯ï¼šéçˆ¶è¯„è®ºæ•°æ®è¢«ä¼ å…¥ï¼Œcomment=`, comment);
    return;
  }
  console.log(`ã€è¯„è®ºæ¸²æŸ“ã€‘ã€çˆ¶è¯„è®ºæ¸²æŸ“ã€‘ å¼€å§‹æ¸²æŸ“å•æ¡çˆ¶è¯„è®ºï¼Œè¯„è®ºID=${comment._id}, æ˜¯å¦æ’å…¥é¡¶éƒ¨=${insertToTop}`);

  const list = document.getElementById("commentsList");
  const empty = document.getElementById("emptyComments");
  empty.style.display = "none";
  list.style.display = "block";

  const item = document.createElement("div");
  item.className = `comment-item ${comment.isTemp ? 'temp-comment' : ''}`;
  item.dataset.commentId = comment._id;

  // ä¼˜å…ˆä½¿ç”¨ç¼“å­˜çš„å½“å‰ç”¨æˆ·ä¿¡æ¯
  const cacheUser = getUserFromCache();
  const isCurrentUserComment = cacheUser && cacheUser.username === comment.username;
  const name = isCurrentUserComment ? cacheUser.nick_name : (comment.nick_name || comment.username || "åŒ¿åç”¨æˆ·");
  const avatarUrl = isCurrentUserComment ? cacheUser.avatar : comment.avatar;

  const avatar = document.createElement("div");
  avatar.className = "comment-avatar";
  if (avatarUrl) {
    const img = document.createElement("img");
    img.src = avatarUrl;
    img.alt = `${name}çš„å¤´åƒ`;
    img.onerror = () => {
      avatar.innerHTML = getDefaultAvatar(name);
    };
    avatar.appendChild(img);
  } else {
    avatar.innerHTML = getDefaultAvatar(name);
  }

  const wrapper = document.createElement("div");
  wrapper.className = "comment-content-wrapper";

  // è®¡ç®—å›å¤æ•°é‡
  const replyCount = parseInt(comment.replies ? comment.replies.length : comment.replies_total || '0', 10);

  
  // æ„å»ºå±•å¼€/æŠ˜å å›å¤æŒ‰é’®
  let toggleBtnHtml = '';
  if (replyCount > 0) {
    toggleBtnHtml = `
      <button class="reply-btn toggle-replies-btn" data-comment-id="${comment._id}" data-reply-count="${replyCount}">
        <span>ğŸ“¤</span>
        <span>å±•å¼€å›å¤(${comment.replies_total || 0})</span>
      </button>
    `;
  } else{
        toggleBtnHtml = `
      <button class="reply-btn toggle-replies-btn" data-comment-id="${comment._id}" data-reply-count="${replyCount}">
      </button>
    `;
  }

  // ä¿®å¤ï¼šè¯„è®ºç‚¹èµæ•°é»˜è®¤å€¼0ï¼Œé¿å…ç©ºå€¼
  const commentLikeCount = parseInt(comment.likeCount || '0', 10);
  // æŸ¥è¯¢è¯„è®ºç‚¹èµçŠ¶æ€
  const isLiked = await checkCommentLikeStatus(comment._id);
  comment.likedByMe = isLiked;
  // æ„å»ºè¯„è®ºå†…å®¹
  wrapper.innerHTML = `
    <div class="comment-header">
      <span class="comment-nickname">${name}</span>
      <span class="comment-time">${formatCommentTime(comment.createdAt)}</span>
    </div>
    <div class="comment-content">${comment.content?.trim() || 'æ— å†…å®¹'}</div>
    <div class="comment-actions">
      <button class="like-btn" data-comment-id="${comment._id}">
        <span class="heart-icon ${!comment.likedByMe ? 'liked' : ''}">â¤ï¸</span>
        <span class="comment-like-count">${isNaN(commentLikeCount) ? 0 : commentLikeCount}</span>
      </button>
      <button class="reply-btn" data-comment-id="${comment._id}" data-reply-to="${name}">
        <span>ğŸ’¬</span>
        <span>å›å¤</span>
      </button>
    </div>
    <div class="empty-replies-tip" style="padding: 1rem 0; color: var(--text-muted); font-size: 0.875rem; text-align: left;"></div>
    <div class="reply-form">
      <div class="reply-input-wrapper">
        <textarea class="reply-input" maxlength="500"></textarea>
      </div>
      <div class="reply-form-footer">
        <span class="reply-length-tip">0/500</span>
        <div>
          <button class="reply-cancel-btn">å–æ¶ˆ</button>
          <button class="reply-submit-btn" disabled>å‘å¸ƒå›å¤</button>
        </div>
      </div>
    </div>
    ${replyCount > 0 ? `
    <div class="comment-replies-toggle">
      <div class="comment-replies-expand">
        <button class="reply-btn toggle-replies-btn" data-comment-id="${comment._id}" data-reply-count="${replyCount}">
          
          <span>å±•å¼€å›å¤(${replyCount})</span>
        </button>
      </div>
    </div>
    ` : ''}
<div class="comment-replies-controls" style="display: none; margin-top: 10px;">
  <div style="display: flex; justify-content: flex-start; gap: 10px;">
    <button class="reply-btn show-more-replies-btn" data-comment-id="${comment._id}" style="display: none;">
     
      <span>æŸ¥çœ‹æ›´å¤šå›å¤</span>
    </button>
    <button class="reply-btn collapse-replies-btn" data-comment-id="${comment._id}">
      <span>&nbsp;</span>
      <span>æ”¶èµ·å›å¤</span>
    </button>
  </div>
</div>
  `;
  item.appendChild(avatar);
  item.appendChild(wrapper);
 
  // æ’å…¥åˆ°è¯„è®ºåˆ—è¡¨
  insertToTop ? list.insertBefore(item, list.firstChild) : list.appendChild(item);
console.log('UUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU', comment);
  // æ»šåŠ¨åˆ°æ–°è¯„è®º
  if (insertToTop) {
    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  


let user = getUserFromCache();
if (!user) {
    user = await getCurrentUserInfo();
    if (!user) {
        // ç”¨æˆ·ä¿¡æ¯å¤±æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•
        localStorage.removeItem('music_user_token');
        clearUserCache();
        // è·³è½¬åˆ°ç™»å½•é¡µ
    }
}

  // ========== ç»‘å®šè¯„è®ºæ“ä½œäº‹ä»¶ ==========
  // 1. ç»‘å®šè¯„è®ºç‚¹èµäº‹ä»¶
  const likeBtn = item.querySelector(`.like-btn[data-comment-id="${comment._id}"]`);
  const heartIcon = item.querySelector('.heart-icon');
  const likeCountEl = item.querySelector('.comment-like-count');

  if (likeBtn && heartIcon && likeCountEl) {
    likeBtn.addEventListener('click', () => {
      const realCommentId = likeBtn.dataset.commentId;
      console.log('ç‚¹å‡»ç‚¹èµæŒ‰é’®ï¼Œè¯„è®ºID:', realCommentId);
      handleCommentLike(realCommentId, likeBtn, heartIcon, likeCountEl);
    });
    heartIcon.classList.toggle('liked', comment.likedByMe);
  }
  // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
const deleteBtn = document.createElement('button');
  deleteBtn.className = 'delete-btn';
  deleteBtn.textContent = 'åˆ é™¤';
  deleteBtn.setAttribute('data-comment-id', comment._id);
  const actions = item.querySelector('.comment-actions');
  if(comment.username ===  user.username){
    actions.appendChild(deleteBtn);
  }
 console.log( 'comment._id',comment._id);
deleteBtn.addEventListener('click', async () => {
  try {
item.remove();
     deleteComment(deleteBtn.dataset.commentId);
    
    // æ›´æ–°è¯„è®ºæ€»æ•°
    const totalEl = document.getElementById("commentsTotalCount");
    const currentTotal = parseInt(totalEl.textContent || '0', 10);
    totalEl.textContent = `${Math.max(0, currentTotal - 1)} æ¡è¯„è®º`;
    // å¦‚æœè¯„è®ºåˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºæç¤º
    const list = document.getElementById("commentsList");
    const empty = document.getElementById("emptyComments");
    if (list.children.length === 0) {
      empty.style.display = "block";
    }
    // æ›´æ–°åˆ†é¡µ
    renderCommentsPagination();
  } catch (error) {
    console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
    showErrorToast('åˆ é™¤è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
});
  // 2. ç»‘å®šå›å¤æŒ‰é’®äº‹ä»¶
  const replyBtn = item.querySelector('.reply-btn:not(.toggle-replies-btn)');
  const replyForm = item.querySelector('.reply-form');
  const replyCancelBtn = replyForm.querySelector('.reply-cancel-btn');
  const replySubmitBtn = replyForm.querySelector('.reply-submit-btn');

  if (replyBtn) {
    replyBtn.addEventListener('click', () => {
      const realCommentId = replyBtn.dataset.commentId;
      const replyToName = replyBtn.dataset.replyTo;
      toggleReplyForm(realCommentId, replyToName);
    });
  }

  if (replyCancelBtn) {
    replyCancelBtn.addEventListener('click', () => {
      const realCommentId = item.dataset.commentId;
      toggleReplyForm(realCommentId);
    });
  }

  if (replySubmitBtn) {
    replySubmitBtn.addEventListener('click', () => {
      const realCommentId = item.dataset.commentId;
      handleReplySubmit(realCommentId, replyForm);
    });
  }


  // 3. ç»‘å®šå±•å¼€/æŠ˜å å›å¤æŒ‰é’®äº‹ä»¶
  const toggleRepliesBtn = item.querySelector('.toggle-replies-btn');
  
  // ä¿®æ”¹å±•å¼€å›å¤æŒ‰é’®äº‹ä»¶
if (toggleRepliesBtn) {
  // è·å–å›å¤æ•°é‡
  const replyCount = parseInt(toggleRepliesBtn.dataset.replyCount || '0', 10);
  
  toggleRepliesBtn.addEventListener('click', async () => {
    const commentId = toggleRepliesBtn.dataset.commentId;
    console.log(`ã€å±•å¼€å›å¤ã€‘å¼€å§‹åŠ è½½è¯„è®º ${commentId} çš„å›å¤æ•°æ®`);
    
    // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    toggleRepliesBtn.disabled = true;
    toggleRepliesBtn.innerHTML = '<span>â³</span><span>åŠ è½½ä¸­...</span>';
    
    try {
      // æ‹‰å–åç«¯æ•°æ® - å…ˆåŠ è½½10æ¡
      const replyData = await loadCommentReplies(commentId, 1, 10);
      if (!replyData) {
        showCommentTip('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        return;
      }
      
      // ç§»é™¤ç°æœ‰å›å¤åˆ—è¡¨
      const repliesList = item.querySelector('.replies-list');
      const emptyRepliesTip = item.querySelector('.empty-replies-tip');
      
      if (repliesList) {
        repliesList.remove();
      }
      
      // åˆ›å»ºæ–°çš„å›å¤åˆ—è¡¨
      const newRepliesList = document.createElement('div');
      newRepliesList.className = 'replies-list show';
      
      if (emptyRepliesTip) {
        emptyRepliesTip.parentNode.replaceChild(newRepliesList, emptyRepliesTip);
      } else {
        const commentActions = item.querySelector('.comment-actions');
        if (commentActions) {
          commentActions.parentNode.insertBefore(newRepliesList, commentActions.nextSibling);
        }
      }
      
      // æ›´æ–°å›å¤æ•°é‡
      const realReplyCount = parseInt(replyData.pagination?.total || '0', 10);
      toggleRepliesBtn.dataset.replyCount = realReplyCount;
      
      // æ¸²æŸ“å›å¤é¡¹
      if (replyData.replies && replyData.replies.length > 0) {
        replyData.replies.forEach(reply => {
          if (!reply.parent_id || reply.parent_id !== commentId) {
            reply.parent_id = commentId;
          }
          renderReplyItem(reply, newRepliesList, false);
        });
      } else {
        const emptyTip = document.createElement('div');
        emptyTip.className = 'empty-replies-tip';
        emptyTip.style.cssText = 'padding: 1rem 0; color: var(--text-muted); font-size: 0.875rem; text-align: left;';
        emptyTip.textContent = '';
        newRepliesList.appendChild(emptyTip);
      }
      
      // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
      const repliesControls = item.querySelector('.comment-replies-controls');
      if (repliesControls) {
        repliesControls.style.display = 'block';
      }
      
      // éšè—åŸå§‹çš„å±•å¼€å›å¤æŒ‰é’®
      const repliesToggle = item.querySelector('.comment-replies-toggle');
      if (repliesToggle) {
        repliesToggle.style.display = 'none';
      }
      
      // å¦‚æœæœ‰æ›´å¤šå›å¤ï¼Œæ˜¾ç¤ºæŸ¥çœ‹æ›´å¤šæŒ‰é’®
      const showMoreBtn = item.querySelector('.show-more-replies-btn');
      if (showMoreBtn) {
        if (replyData.pagination?.totalPages > 1) {
          showMoreBtn.style.display = 'inline-block';
        }
      }
      
    } catch (err) {
      console.error('åŠ è½½å›å¤åˆ—è¡¨å¤±è´¥:', err);
      showCommentTip('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      // æ¢å¤æŒ‰é’®çŠ¶æ€
      toggleRepliesBtn.disabled = false;
      toggleRepliesBtn.innerHTML = '<span>å±•å¼€å›å¤(' + replyCount + ')</span>';
    }
  });
  
  // ç»‘å®šæ”¶èµ·å›å¤æŒ‰é’®äº‹ä»¶
  const collapseBtn = item.querySelector('.collapse-replies-btn');
  if (collapseBtn) {
    collapseBtn.addEventListener('click', () => {
      const commentId = collapseBtn.dataset.commentId;
      const repliesList = item.querySelector('.replies-list');
      const repliesControls = item.querySelector('.comment-replies-controls');
      const repliesToggle = item.querySelector('.comment-replies-toggle');
      const showMoreBtn = item.querySelector('.show-more-replies-btn');
      
      // éšè—å›å¤åˆ—è¡¨
      if (repliesList) {
        repliesList.remove();
      }
      
      // æ˜¾ç¤ºç©ºå›å¤æç¤º
      const emptyRepliesTip = document.createElement('div');
      emptyRepliesTip.className = 'empty-replies-tip';
      emptyRepliesTip.style.cssText = 'padding: 1rem 0; color: var(--text-muted); font-size: 0.875rem; text-align: left;';
      
      const replyForm = item.querySelector('.reply-form');
      if (replyForm) {
        replyForm.parentNode.insertBefore(emptyRepliesTip, replyForm);
      }
      
      // éšè—æ§åˆ¶æŒ‰é’®
      if (repliesControls) {
        repliesControls.style.display = 'none';
      }
      
      // æ˜¾ç¤ºåŸå§‹çš„å±•å¼€å›å¤æŒ‰é’®
      if (repliesToggle) {
        repliesToggle.style.display = 'block';
      }
      
      // éšè—æŸ¥çœ‹æ›´å¤šæŒ‰é’®
      if (showMoreBtn) {
        showMoreBtn.style.display = 'none';
      }
    });
  }
  
  // ç»‘å®šæŸ¥çœ‹æ›´å¤šå›å¤æŒ‰é’®äº‹ä»¶
  const showMoreBtn = item.querySelector('.show-more-replies-btn');
  if (showMoreBtn) {
    showMoreBtn.addEventListener('click', async () => {
      const commentId = showMoreBtn.dataset.commentId;
      
      // åŠ è½½æ‰€æœ‰å›å¤
      const replyData = await loadCommentReplies(commentId, 1, 100);
      if (!replyData) {
        showCommentTip('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        return;
      }
      
      // æ›´æ–°å›å¤åˆ—è¡¨
      const repliesList = item.querySelector('.replies-list');
      if (repliesList) {
        // æ¸…ç©ºç°æœ‰å›å¤
        repliesList.innerHTML = '';
        
        // æ¸²æŸ“æ‰€æœ‰å›å¤
        if (replyData.replies && replyData.replies.length > 0) {
          replyData.replies.forEach(reply => {
            renderReplyItem(reply, repliesList, false);
          });
        }
      }
      
      // éšè—æŸ¥çœ‹æ›´å¤šæŒ‰é’®
      showMoreBtn.style.display = 'none';
    });
  }
}
  console.log(`ã€è¯„è®ºæ¸²æŸ“ã€‘ã€çˆ¶è¯„è®ºæ¸²æŸ“ã€‘ è¯„è®ºæ¸²æŸ“å®Œæˆï¼Œäº‹ä»¶ç»‘å®šå®Œæˆ`);
  return item;
}


/**
 * æ¸²æŸ“è¯„è®ºåˆ†é¡µ
 */
function renderCommentsPagination() {
  const paginationEl = document.getElementById('commentsPagination');
  paginationEl.innerHTML = '';                    
  console.log(`ã€è¯„è®ºåˆ—è¡¨ã€‘ã€åˆ†é¡µæ¸²æŸ“ã€‘ å¼€å§‹æ¸²æŸ“åˆ†é¡µï¼Œå½“å‰é¡µç =${currentCommentPage}, æ€»é¡µæ•°=${totalCommentPages}`);
  
  // ä¸Šä¸€é¡µæŒ‰é’®
  const prevBtn = document.createElement('button');
  prevBtn.className = 'page-btn';
  prevBtn.textContent = 'â†';
  prevBtn.disabled = currentCommentPage === 1;
  prevBtn.onclick = () => {
    if (currentCommentPage > 1) {
      currentCommentPage--;
      loadComments(currentCommentPage);
    }
  };
  paginationEl.appendChild(prevBtn);

  // é¡µç æŒ‰é’®ï¼ˆæœ€å¤šæ˜¾ç¤º5ä¸ªï¼‰
  const startPage = Math.max(1, currentCommentPage - 2);
  const endPage = Math.min(totalCommentPages, startPage + 4);
  
  for (let i = startPage; i <= endPage; i++) {
    const pageBtn = document.createElement('button');
    pageBtn.className = `page-btn ${i === currentCommentPage ? 'active' : ''}`;
    pageBtn.textContent = i;
    pageBtn.onclick = () => {
      currentCommentPage = i;
      loadComments(i);
    };
    paginationEl.appendChild(pageBtn);
  }

  // ä¸‹ä¸€é¡µæŒ‰é’®
  const nextBtn = document.createElement('button');
  nextBtn.className = 'page-btn';
  nextBtn.textContent = 'â†’';
  nextBtn.disabled = currentCommentPage === totalCommentPages;
  nextBtn.onclick = () => {
    if (currentCommentPage < totalCommentPages) {
      currentCommentPage++;
      loadComments(currentCommentPage);
    }
  };
  paginationEl.appendChild(nextBtn);
  paginationEl.style.display = totalCommentPages > 1 ? 'flex' : 'none';
  console.log(`ã€è¯„è®ºåˆ—è¡¨ã€‘ã€åˆ†é¡µæ¸²æŸ“ã€‘ åˆ†é¡µæ¸²æŸ“å®Œæˆ`);
}

/**
 * åˆå§‹åŒ–è¯„è®ºå‘å¸ƒè¡¨å•
 */
function initCommentForm() {
  console.group(`ã€è¯„è®ºå‘å¸ƒã€‘ã€è¡¨å•åˆå§‹åŒ–ã€‘ å¼€å§‹åˆå§‹åŒ–è¯„è®ºå‘å¸ƒè¡¨å•`);
  // ========== é‡ç‚¹TOKENæ—¥å¿— ==========
  const token = localStorage.getItem('music_user_token');
  const desensitizeToken = token ? `${token.slice(0,8)}****${token.slice(-8)}` : 'æ— TOKEN';
  console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€è¡¨å•åˆå§‹åŒ–ã€‘ TOKEN=${desensitizeToken}, TOKENæ˜¯å¦å­˜åœ¨=${!!token}`);

  const loginTip = document.getElementById('commentLoginTip');
  const form = document.getElementById('commentForm');
  const textarea = document.getElementById('commentContent');
  const lengthTip = document.getElementById('commentLengthTip');
  const btn = document.getElementById('commentSubmitBtn');
  const empty = document.getElementById('emptyComments');

  if (!token) {
    console.warn(`ã€è¯„è®ºå‘å¸ƒã€‘ã€è¡¨å•åˆå§‹åŒ–ã€‘ TOKENä¸ºç©ºï¼Œæ˜¾ç¤ºç™»å½•æç¤ºï¼Œéšè—å‘å¸ƒè¡¨å•`);
    loginTip.style.display = 'block';
    form.style.display = 'none';
    console.groupEnd();
    return;
  }

  loginTip.style.display = 'none';
  form.style.display = 'block';
  console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€è¡¨å•åˆå§‹åŒ–ã€‘ TOKENæœ‰æ•ˆï¼Œæ˜¾ç¤ºå‘å¸ƒè¡¨å•`);

  // å­—æ•°ç»Ÿè®¡
  textarea.addEventListener('input', () => {
    const content = textarea.value.trim();
    const length = content.length;
    lengthTip.textContent = `${length}/500`;
    btn.disabled = length < 1 || length > 500;
  });

  // å‘å¸ƒè¯„è®ºæ ¸å¿ƒé€»è¾‘
  btn.onclick = async () => {
    const content = textarea.value.trim();
    console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ ç”¨æˆ·ç‚¹å‡»å‘å¸ƒè¯„è®ºï¼Œå†…å®¹=${content}, é•¿åº¦=${content.length}`);
    if (!content || content.length < 1 || content.length > 500) {
      console.warn(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ å†…å®¹é•¿åº¦æ ¡éªŒå¤±è´¥ï¼Œç»ˆæ­¢å‘å¸ƒ`);
      return;
    }
  
    btn.disabled = true;
    btn.textContent = "å‘å¸ƒä¸­...";
    const tempCommentId = `temp_${Date.now()}`;
    console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ ç”Ÿæˆä¸´æ—¶è¯„è®ºID=${tempCommentId}ï¼Œå¼€å§‹ä¹è§‚æ›´æ–°UI`);
 
    try {
      // ä¼˜å…ˆè¯»å–ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯
      let user = getUserFromCache();
      if (!user) {
        console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ æ— ç”¨æˆ·ç¼“å­˜ï¼Œè¯·æ±‚æœ€æ–°ç”¨æˆ·ä¿¡æ¯`);
        user = await getCurrentUserInfo();
        if (!user) {
          console.error(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ ç”¨æˆ·ä¿¡æ¯å¤±æ•ˆï¼Œæ¸…é™¤TOKENå¹¶è·³è½¬ç™»å½•`);
          showCommentTip('ç”¨æˆ·ä¿¡æ¯å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ï¼', 'error');
          localStorage.removeItem('music_user_token');
          clearUserCache();
          setTimeout(() => location.href = "login.html", 1000);
          return;
        }
      }
  
      // å‰ç«¯ç«‹å³ç”¨ç¼“å­˜ä¿¡æ¯æ¸²æŸ“è¯„è®º
      renderCommentItem({
        _id: tempCommentId,
        content: content,
        nick_name: user.nick_name,
        username: user.username,
        avatar: user.avatar,
        likeCount: 0,
        likedByMe: false,
        createdAt: new Date().toISOString(),
        replies: [],
        replies_total: 0,
        isTemp: true
      }, true);
      empty.style.display = "none";
      console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ ä¸´æ—¶è¯„è®ºæ¸²æŸ“å®Œæˆï¼Œéšè—ç©ºæç¤º`);
  
      // æ¸…ç©ºè¾“å…¥æ¡†
      textarea.value = "";
      lengthTip.textContent = "0/500";
  
      // æ‰‹åŠ¨æ›´æ–°è¯„è®ºæ€»æ•°
      const totalEl = document.getElementById("commentsTotalCount");
      const currentTotal = parseInt(totalEl.textContent || '0', 10);
      totalEl.textContent = `${Math.max(0, currentTotal + 1)} æ¡è¯„è®º`;
      console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ æ›´æ–°è¯„è®ºæ€»æ•°ï¼ŒåŸæ€»æ•°=${currentTotal}ï¼Œæ–°æ€»æ•°=${currentTotal+1}`);
  
      // åå°å¼‚æ­¥æäº¤
      const reqUrl = `http://localhost:3000/api/${resourceType}s/${resourceId}/comments`;
      const reqData = { content: content };
      console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ å‘èµ·åç«¯è¯·æ±‚ï¼Œåœ°å€=${reqUrl}, è¯·æ±‚å‚æ•°=`, reqData);
      const response = await axios.post(
        reqUrl, reqData,
        {
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          withCredentials: true
        }
      );
      console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ è¯·æ±‚æˆåŠŸï¼Œå“åº”æ•°æ®=`, response.data);
  
      if (response.data.code === 200) {
        const { commentId: realCommentId } = response.data.data;
        console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ è¯„è®ºå‘å¸ƒæˆåŠŸï¼ŒçœŸå®è¯„è®ºID=${realCommentId}`);
        
        // æ›¿æ¢ä¸´æ—¶è¯„è®ºID
        const tempCommentEl = document.querySelector(`.comment-item[data-comment-id="${tempCommentId}"]`);
        if (tempCommentEl) {
          tempCommentEl.dataset.commentId = realCommentId;
          const likeBtn = tempCommentEl.querySelector(`.like-btn[data-comment-id="${tempCommentId}"]`);
          if (likeBtn) likeBtn.dataset.commentId = realCommentId;
          const replyBtn = tempCommentEl.querySelector(`.reply-btn[data-comment-id="${tempCommentId}"]`);
          if (replyBtn) replyBtn.dataset.commentId = realCommentId;
          const toggleBtn = tempCommentEl.querySelector(`.toggle-replies-btn[data-comment-id="${tempCommentId}"]`);
          if (toggleBtn) toggleBtn.dataset.commentId = realCommentId;
          tempCommentEl.classList.remove('temp-comment');
          const deleteBtn = tempCommentEl.querySelector(`.delete-btn[data-comment-id="${tempCommentId}"]`);
          if (deleteBtn) deleteBtn.setAttribute('data-comment-id', realCommentId);


          console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ ä¸´æ—¶IDæ›¿æ¢å®Œæˆï¼Œæ›´æ–°ä¸ºçœŸå®ID=${realCommentId}`);
        }

        if (currentCommentPage !== 1) {
          await loadComments(1);
          currentCommentPage = 1;
          console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ éç¬¬ä¸€é¡µå‘å¸ƒï¼Œåˆ·æ–°ç¬¬ä¸€é¡µè¯„è®ºåˆ—è¡¨`);
        }
  
        showCommentTip('è¯„è®ºå‘å¸ƒæˆåŠŸï¼');
      }

      refreshUserInfo(token);
    } catch (err) {
      console.error(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ è¯„è®ºæäº¤å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…=`, err);
      showCommentTip('è¯„è®ºå‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
      // å›æ»šUI
      const tempCommentEl = document.querySelector(`.comment-item[data-comment-id="${tempCommentId}"]`);
      if (tempCommentEl) {
        tempCommentEl.remove();
        const totalEl = document.getElementById("commentsTotalCount");
        const currentTotal = parseInt(totalEl.textContent || '0', 10);
        totalEl.textContent = `${Math.max(0, currentTotal - 1)} æ¡è¯„è®º`;
        if (list.children.length === 0) empty.style.display = "block";
        console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ è¯·æ±‚å¤±è´¥ï¼Œå›æ»šUIå¹¶æ¢å¤è¯„è®ºæ€»æ•°`);
      }
    } finally {
      btn.disabled = false;
      btn.textContent = "å‘å¸ƒè¯„è®º";
      console.log(`ã€è¯„è®ºå‘å¸ƒã€‘ã€æäº¤è¯„è®ºã€‘ è¯„è®ºå‘å¸ƒæµç¨‹ç»“æŸï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€`);
    }
  };
  console.groupEnd();
}

// ========== é¡µé¢åŠ è½½ä¸äº‹ä»¶ç»‘å®š ==========
/**
 * é¡µé¢ä¸»åŠ è½½å‡½æ•°
 */
async function loadPage() {
  console.group(`ã€é¡µé¢åˆå§‹åŒ–ã€‘ã€ä¸»åŠ è½½å‡½æ•°ã€‘ é¡µé¢å¼€å§‹åŠ è½½`);
  if (!resourceId) {
    console.error(`ã€é¡µé¢åˆå§‹åŒ–ã€‘ã€ä¸»åŠ è½½å‡½æ•°ã€‘ resourceIdä¸ºç©ºï¼Œè·³è½¬åˆ—è¡¨é¡µ`);
    window.location.replace('songs-list.html');
    console.groupEnd();
    return;
  }
  console.log(`ã€é¡µé¢åˆå§‹åŒ–ã€‘ã€ä¸»åŠ è½½å‡½æ•°ã€‘ resourceId=${resourceId}, resourceType=${resourceType}`);

  try {
    // è·å–èµ„æºåŸºç¡€ä¿¡æ¯
    const resourceRes = await axios.get(`http://localhost:3000/api/${resourceType}s/${resourceId}`, { withCredentials: true });
    const resource = resourceRes.data.data;
    console.log(`ã€é¡µé¢åˆå§‹åŒ–ã€‘ã€ä¸»åŠ è½½å‡½æ•°ã€‘ è·å–èµ„æºä¿¡æ¯æˆåŠŸ=`, resource);
    
    // å¤„ç†ä¸“è¾‘ä¿¡æ¯
    let albumName = 'å•æ›²';
    let releaseDate = 'æœªçŸ¥';
    if (resource.album_id && resource.album_id !== 'undefined' && resource.album_id !== '') {
      try {
        const albumRes = await axios.get(`http://localhost:3000/api/albums/${resource.album_id}`, { withCredentials: true });
        const album = albumRes.data.data;
        albumName = album.name_cn || 'å•æ›²';
        releaseDate = album.release_date || 'æœªçŸ¥';
        console.log(`ã€é¡µé¢åˆå§‹åŒ–ã€‘ã€ä¸»åŠ è½½å‡½æ•°ã€‘ è·å–ä¸“è¾‘ä¿¡æ¯æˆåŠŸ=`, album);
      } catch (albumErr) {
        console.warn(`ã€é¡µé¢åˆå§‹åŒ–ã€‘ã€ä¸»åŠ è½½å‡½æ•°ã€‘ è·å–ä¸“è¾‘ä¿¡æ¯å¤±è´¥=`, albumErr);
      }
    }

    // å¡«å……é¡µé¢æ•°æ®
    document.getElementById('songName').textContent = resource.name_cn || 'æœªçŸ¥åç§°';
    document.getElementById('albumName').textContent = albumName;
    document.getElementById('releaseDate').textContent = `å‘è¡Œæ—¶é—´ï¼š${releaseDate}`;
    document.getElementById('lyricist').textContent = resource.lyricist || 'â€”';
    document.getElementById('composer').textContent = resource.composer || 'â€”';
    document.getElementById('arranger').textContent = resource.arranger || 'â€”';
    document.getElementById('duration').textContent = resource.duration || 'â€”';
    console.log(`ã€é¡µé¢åˆå§‹åŒ–ã€‘ã€ä¸»åŠ è½½å‡½æ•°ã€‘ é¡µé¢æ•°æ®å¡«å……å®Œæˆ`);

    // æ˜¾ç¤ºå†…å®¹åŒº
    document.getElementById('loading').style.display = 'none';
    document.getElementById('songDetail').style.display = 'block';
    console.log(`ã€é¡µé¢åˆå§‹åŒ–ã€‘ã€ä¸»åŠ è½½å‡½æ•°ã€‘ æ˜¾ç¤ºé¡µé¢å†…å®¹åŒºï¼Œéšè—åŠ è½½ä¸­`);

    // åˆå§‹åŒ–è¯„åˆ†å’Œè¯„è®ºåŠŸèƒ½
    await getResourceRating();
    await getUserCurrentRating();
    initRatingSystem();
    initCommentForm();
    await loadComments(1);
    console.log(`ã€é¡µé¢åˆå§‹åŒ–ã€‘ã€ä¸»åŠ è½½å‡½æ•°ã€‘ æ‰€æœ‰åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ`);

  } catch (err) {
    document.getElementById('loading').textContent = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–èµ„æºIDæ˜¯å¦å­˜åœ¨";
    console.error(`ã€é¡µé¢åˆå§‹åŒ–ã€‘ã€ä¸»åŠ è½½å‡½æ•°ã€‘ é¡µé¢åŠ è½½å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…=`, err);
  }
  console.groupEnd();
}

// ç»‘å®šé¡µé¢äº‹ä»¶
document.getElementById('backToListBtn').addEventListener('click', () => {
  console.log(`ã€é¡µé¢æ“ä½œã€‘ã€è¿”å›åˆ—è¡¨ã€‘ ç”¨æˆ·ç‚¹å‡»è¿”å›åˆ—è¡¨æŒ‰é’®`);
  window.location.replace('./songs-list.html');
});

window.addEventListener('popstate', () => {
  console.log(`ã€é¡µé¢æ“ä½œã€‘ã€è¿”å›äº‹ä»¶ã€‘ ç›‘å¬æµè§ˆå™¨è¿”å›äº‹ä»¶ï¼Œè·³è½¬åˆ—è¡¨é¡µ`);
  window.location.replace('./songs-list.html');
});

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  console.log(`ã€é¡µé¢åˆå§‹åŒ–ã€‘ã€DOMåŠ è½½å®Œæˆã€‘ DOMæ ‘åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–ç”¨æˆ·ç¼“å­˜å’Œé¡µé¢`);
  getUserFromCache();
  loadPage();
});

</script>
</body>
</html>