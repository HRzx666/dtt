<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸ªäººä¸­å¿ƒ - é™¶å–†éŸ³ä¹è¯„åˆ†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
  <style>
    /* å…¨å±€å˜é‡ä¸åŸºç¡€æ ·å¼ - ä¿ç•™åŸå˜é‡ + æ–°å¢ä¼˜åŒ–å˜é‡ */
    :root {
      --primary-color: #6366f1;
      --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
      --bg-color: #f8fafc;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --hover-shadow: 0 8px 20px -5px rgba(0,0,0,0.06);
      --border-color: #e2e8f0;
      --danger-color: #ef4444;
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 24px;
      --transition: all 0.25s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang SC", "Microsoft Yahei", sans-serif; }

    body { background-color: var(--bg-color); color: var(--text-main); padding: 20px; line-height: 1.6; }

    .container { max-width: 1000px; margin: 0 auto; }

    /* å¤´éƒ¨å¯¼èˆª - ä¼˜åŒ–hoverè¿‡æ¸¡+é˜´å½± */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .header-title { font-size: 24px; font-weight: 700; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: var(--transition); display: inline-flex; align-items: center; gap: 6px; }
    .btn-back { background-color: white; color: var(--text-main); text-decoration: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .btn-back:hover { transform: translateX(-3px); box-shadow: var(--card-shadow); }
    .btn-logout { background-color: #fee2e2; color: #ef4444; }
    .btn-logout:hover { background-color: #ef4444; color: white; box-shadow: 0 2px 8px rgba(239,68,68,0.2); }

    /* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ - ä¼˜åŒ–é˜´å½±+hoveræŸ”å’Œè¿‡æ¸¡ */
    .user-card { background: white; padding: 35px; border-radius: 24px; margin-bottom: 30px; display: flex; flex-wrap: wrap; align-items: center; gap: 40px; box-shadow: var(--card-shadow); position: relative; overflow: hidden; transition: var(--transition); }
    .user-card:hover { box-shadow: var(--hover-shadow); }

    /* å¤´åƒåŒºåŸŸï¼šå‚ç›´å±…ä¸­æ’åˆ— - ä¼˜åŒ–å¤´åƒhoverç¼©æ”¾ */
    .avatar-area { display: flex; flex-direction: column; align-items: center; gap: 15px; position: relative; z-index: 1; }
    .avatar, .avatar-img { width: 110px; height: 110px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.12); transition: var(--transition); }
    .avatar { background: var(--primary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-size: 44px; font-weight: bold; }
    .avatar-img { object-fit: cover; display: none; }
    .avatar:hover, .avatar-img:hover { transform: scale(1.02); }
    
    /* éšè—åŸç”Ÿæ–‡ä»¶ä¸Šä¼  */
    #avatarInput { display: none; }
    
    /* è‡ªå®šä¹‰æ›´æ¢å¤´åƒæŒ‰é’® - ä¼˜åŒ–hoveræ•ˆæœ */
    .btn-change-avatar { padding: 6px 16px; background: #f1f5f9; color: var(--primary-color); border: 1px solid #e2e8f0; border-radius: 20px; font-size: 13px; cursor: pointer; transition: var(--transition); }
    .btn-change-avatar:hover { background: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 2px 6px rgba(99,102,241,0.2); }

    .user-info { flex: 1; min-width: 280px; }
    .nickname-wrapper { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .nickname-wrapper h3 { font-size: 24px; color: var(--text-main); }
    .btn-edit-nickname { padding: 4px 10px; font-size: 12px; background: #f1f5f9; color: var(--primary-color); border: none; border-radius: 6px; cursor: pointer; transition: var(--transition); }
    .btn-edit-nickname:hover { background: var(--primary-color); color: white; }

    .user-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 20px; }
    .info-item { background: #f8fafc; padding: 12px 16px; border-radius: 16px; border: 1px solid #f1f5f9; transition: var(--transition); }
    .info-item:hover { box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
    .info-label { font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 2px; }
    .info-value { font-size: 15px; font-weight: 600; color: var(--text-main); }
    .info-value.highlight { color: var(--primary-color); }

    /* åˆ—è¡¨æ¨¡å— - ä¼˜åŒ–å†…è¾¹è·+é˜´å½±è¿‡æ¸¡ */
    .section { background: white; padding: 25px; border-radius: 24px; margin-bottom: 30px; box-shadow: var(--card-shadow); transition: var(--transition); }
    .section:hover { box-shadow: var(--hover-shadow); }
    .section-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; position: relative; }
    .section-title::before { content: ""; width: 4px; height: 18px; background: var(--primary-gradient); border-radius: 2px; }

    .table-container { overflow-x: auto; border-radius: var(--radius-md); }
    .rating-list { width: 100%; border-collapse: collapse; min-width: 600px; }
    .rating-list th { text-align: left; padding: 12px 15px; color: var(--text-muted); font-size: 14px; border-bottom: 1px solid #f1f5f9; background: #f8fafc; }
    .rating-list td { padding: 15px; font-size: 14px; border-bottom: 1px solid #f8fafc; }
    .rating-list tr:hover td { background-color: #fcfcfd; }
    .rating-score { display: inline-block; padding: 2px 10px; background: #fffbeb; color: #d97706; border-radius: 6px; font-weight: 700; }
    .empty-tip { text-align: center; color: var(--text-muted); padding: 50px !important; font-size: 14px; }

    /* å¼¹çª—è®¾è®¡ - ä¼˜åŒ–è¾“å…¥æ¡†èšç„¦æ ·å¼+æŒ‰é’®hover */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(6px); display: none; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
    .modal-content { background: white; border-radius: 28px; padding: 30px; width: 100%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    .modal-title { font-size: 20px; margin-bottom: 20px; text-align: center; font-weight: 700; }
    .nickname-input { width: 100%; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 16px; margin-bottom: 20px; outline: none; transition: border-color 0.3s; }
    .nickname-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(99,102,241,0.1); }
    .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .loading { text-align: center; padding: 100px 0; color: var(--text-muted); font-size: 18px; }
    .crop-container { width: 100%; height: 350px; background: #f1f5f9; margin-bottom: 20px; border-radius: 16px; overflow: hidden; }

    /* ========== æ¶ˆæ¯é€šçŸ¥æ ·å¼ - ç²¾ç»†åŒ–ä¼˜åŒ– (ä¿ç•™åŸæœ‰ç»“æ„+å¢å¼ºè§†è§‰+æ–°å¢è¯„è®ºé¢„è§ˆæ ·å¼) ========== */
    .notification-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #ef4444;
        color: white;
        border-radius: 12px;
        padding: 2px 7px;
        font-size: 11px;
        font-weight: 600;
        min-width: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(239,68,68,0.2);
    }
    
    .notification-item {
        padding: 18px 16px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        gap: 14px;
        align-items: flex-start;
        cursor: pointer;
        transition: var(--transition);
        margin-bottom: 6px;
        border-radius: var(--radius-md);
    }
    
    .notification-item:hover {
        background-color: #f8fafc;
    }
    
    .notification-item.unread {
        background-color: #f0f9ff;
        border-left: 3px solid var(--primary-color);
        font-weight: 500;
    }
    
    .notification-avatar {
        width: 40px;
        height: 40px;
	border: 2px solid #fff;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .notification-content {
        flex: 1;
        min-width: 0;
    }
    
    .notification-sender {
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 4px;
        font-size: 15px;
    }
    
    .notification-text {
        color: var(--text-muted);
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 6px;
        word-break: break-all;
    }
    
    /* âœ… æ–°å¢ï¼šè¯„è®ºå†…å®¹é¢„è§ˆæ ·å¼ */
    .notification-comment {
        color: #64748b;
        font-size: 13px;
        margin: 4px 0;
        font-style: italic;
        line-height: 1.4;
        padding: 6px 8px;
        background: #f8fafc;
        border-radius: 6px;
        border-left: 3px solid #e2e8f0;
    }
    
    .notification-time {
        font-size: 12px;
        color: #94a3b8;
    }
    
    .notification-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
    }
    
    .notification-action-btn {
        padding: 4px 8px;
        font-size: 12px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .notification-action-btn:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }
    
    .notification-action-btn.primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .notification-action-btn.primary:hover {
        background: #4f46e5;
    }
    /* åˆ é™¤æŒ‰é’®å¢åŠ çº¢è‰²hoveræç¤º */
    .notification-action-btn.delete-btn:hover {
        color: var(--danger-color);
        border-color: var(--danger-color);
    }
    
    .notification-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin-top: 20px;
        padding: 0 16px;
    }
    
    .pagination-btn {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: var(--transition);
    }
    
    .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #f8fafc;
    }
    /* åˆ†é¡µæŒ‰é’®hoveré«˜äº® */
    .pagination-btn:not(:disabled):hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .pagination-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding: 0 16px;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .notification-controls {
        display: flex;
        gap: 8px;
    }
    /* ä¼˜åŒ–ç­›é€‰ä¸‹æ‹‰æ¡†æ ·å¼ */
    #notificationFilter {
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        color: var(--text-main);
        cursor: pointer;
        transition: var(--transition);
    }
    #notificationFilter:focus {
        border-color: var(--primary-color);
        outline: none;
    }
    /* åŠ è½½æç¤ºæ ·å¼ */
    .loading-tip {
        text-align: center;
        color: var(--text-muted);
        padding: 20px;
        font-size: 14px;
    }

    /* ========== æ–°å¢ï¼šè·³è½¬åŠ è½½åŠ¨ç”»æ ·å¼ ========== */
    #jump-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 99999;
        color: white;
        font-size: 16px;
        flex-direction: column;
        gap: 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="songs-list.html" class="btn btn-back">â† è¿”å›æ­Œæ›²åˆ—è¡¨</a>
      <h1 class="header-title">ä¸ªäººä¸­å¿ƒ</h1>
      <button class="btn btn-logout" id="logoutBtn">é€€å‡ºç™»å½•</button>
    </div>

    <div class="loading" id="loading">âœ¨ æ­£åœ¨è·å–éŸ³ä¹æ¡£æ¡ˆ...</div>

    <div id="profileContent" style="display: none;">
      <div class="user-card">
        <div class="avatar-area">
          <div class="avatar" id="userAvatar">U</div>
          <img src="" alt="ç”¨æˆ·å¤´åƒ" id="userAvatarImg" class="avatar-img">
          <input type="file" id="avatarInput" accept="image/*">
          <button class="btn-change-avatar" id="changeAvatarBtn">æ›´æ¢å¤´åƒ</button>
        </div>
        
        <div class="user-info">
          <div class="nickname-wrapper">
            <div>
              <h3 id="showNickname">ç”¨æˆ·å</h3>
              <small style="color: var(--text-muted); font-size: 12px;">@<span id="username">username</span></small>
            </div>
            <button class="btn-edit-nickname" id="editNicknameBtn">ç¼–è¾‘èµ„æ–™</button>
          </div>
          <div class="user-details">
            <div class="info-item"><span class="info-label">æˆ‘çš„æ˜µç§°</span><span class="info-value" id="nickname">æœªè®¾ç½®</span></div>
            <div class="info-item"><span class="info-label">å…¥é©»æ—¶é—´</span><span class="info-value" id="joinTime">--</span></div>
            <div class="info-item"><span class="info-label">æ­Œæ›²è¯„åˆ†</span><span class="info-value highlight"><span id="songRatingCount">0</span> é¦–</span></div>
            <div class="info-item"><span class="info-label">å•æ›²è¯„åˆ†</span><span class="info-value highlight"><span id="singleRatingCount">0</span> é¦–</span></div>
          </div>
        </div>
      </div>

      <!-- ========== æ¶ˆæ¯é€šçŸ¥æ¨¡å— ========== -->
      <div class="section">
        <h2 class="section-title">
          æ¶ˆæ¯é€šçŸ¥
          <span class="notification-badge" id="unreadCountBadge" style="display: none;"></span>
        </h2>
        <div class="notification-header">
          <div class="notification-controls">
            <button class="notification-action-btn" id="markAllReadBtn">å…¨éƒ¨æ ‡è®°å·²è¯»</button>
            <button class="notification-action-btn" id="refreshNotificationsBtn">åˆ·æ–°</button>
          </div>
          <div>
            <select id="notificationFilter">
              <option value="all">å…¨éƒ¨æ¶ˆæ¯</option>
              <option value="unread">ä»…æœªè¯»</option>
            </select>
          </div>
        </div>
        <div id="notificationList">
          <div class="empty-tip">æš‚æ— æ¶ˆæ¯é€šçŸ¥</div>
        </div>
        <div class="notification-pagination" id="notificationPagination" style="display: none;">
          <button class="pagination-btn" id="prevPageBtn">ä¸Šä¸€é¡µ</button>
          <span id="pageInfo">ç¬¬ 1 é¡µ</span>
          <button class="pagination-btn" id="nextPageBtn">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">æˆ‘çš„æ­Œæ›²è¯„åˆ†</h2>
        <div class="table-container">
          <table class="rating-list">
            <thead>
              <tr><th>æ­Œæ›²å</th><th>ä¸“è¾‘</th><th>æˆ‘çš„è¯„åˆ†</th><th>è¯„åˆ†æ—¶é—´</th></tr>
            </thead>
            <tbody id="songRatingList">
              <tr><td colspan="4" class="empty-tip">æš‚æ— æ­Œæ›²è¯„åˆ†</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">æˆ‘çš„å•æ›²è¯„åˆ†</h2>
        <div class="table-container">
          <table class="rating-list">
            <thead>
              <tr><td>å•æ›²å</td><td>å‘è¡Œæ—¶é—´</td><td>æˆ‘çš„è¯„åˆ†</td><td>è¯„åˆ†æ—¶é—´</td></tr>
            </thead>
            <tbody id="singleRatingList">
              <tr><td colspan="4" class="empty-tip">æš‚æ— å•æ›²è¯„åˆ†</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="cropModal">
    <div class="modal-content">
      <h3 class="modal-title">è£å‰ªå¤´åƒ</h3>
      <div class="crop-container"><img id="cropImage" src=""></div>
      <div class="modal-btns">
        <button class="btn btn-logout" id="cropCancelBtn" style="justify-content: center;">å–æ¶ˆ</button>
        <button class="btn btn-back" id="cropConfirmBtn" style="background: var(--primary-gradient); color: white; justify-content: center;">ç¡®è®¤è£å‰ª</button>
      </div>
    </div>
  </div>

  <div class="modal" id="nicknameModal">
    <div class="modal-content">
      <h3 class="modal-title">ä¿®æ”¹æ˜µç§°</h3>
      <input type="text" class="nickname-input" id="nicknameInput" placeholder="è¯·è¾“å…¥æ–°æ˜µç§°ï¼ˆ2-10ä¸ªå­—ç¬¦ï¼‰">
      <div class="modal-btns">
        <button class="btn btn-logout" id="cancelNicknameBtn" style="justify-content: center;">å–æ¶ˆ</button>
        <button class="btn btn-back" id="saveNicknameBtn" style="background: var(--primary-gradient); color: white; justify-content: center;">ä¿å­˜ä¿®æ”¹</button>
      </div>
    </div>
  </div>

  <script>
    /* æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ */
    let userToken = localStorage.getItem('music_user_token');
    let username = '';
    let cropper = null;

    // ========== è°ƒè¯•æ—¥å¿—å‡½æ•° ==========
    function log(msg, data = '') {
      console.log(`ã€ä¸ªäººä¸­å¿ƒã€‘${msg}`, data);
    }

    function checkLogin() {
      if (!userToken) { 
        alert('è¯·å…ˆç™»å½•ï¼'); 
        window.location.href = 'login.html'; 
        return false; 
      }
      if (!userToken.includes('.')) {
        alert('ç™»å½•å‡­è¯æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ï¼');
        localStorage.removeItem('music_user_token');
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }

    function parseJwt(token) {
      try {
        const base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
        const paddedBase64 = base64.padEnd(base64.length + (4 - base64.length % 4) % 4, '=');
        const jsonPayload = decodeURIComponent(atob(paddedBase64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        const payload = JSON.parse(jsonPayload);
        log('Tokenè§£æç»“æœ', payload);
        return payload;
      } catch (e) { 
        log('Tokenè§£æå¤±è´¥', e);
        return null; 
      }
    }

    // å‹ç¼©å›¾ç‰‡
    function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 200; canvas.height = 200;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, 200, 200);
            resolve(canvas.toDataURL('image/jpeg', 0.8));
          };
        };
      });
    }

    // è£å‰ªæµç¨‹
    function cropSelectedImage(file) {
      return new Promise((resolve) => { 
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => { 
          const cropImage = document.getElementById('cropImage');
          const cropModal = document.getElementById('cropModal');
          cropImage.src = e.target.result;
          cropModal.style.display = 'flex';
          cropper = new Cropper(cropImage, { aspectRatio: 1, viewMode: 1 }); 
          document.getElementById('cropConfirmBtn').onclick = () => { 
            cropper.getCroppedCanvas().toBlob((blob) => { 
              cropper.destroy(); cropModal.style.display = 'none';
              resolve(new File([blob], "avatar.jpg", { type: "image/jpeg" }));
            }, "image/jpeg"); 
          }; 
          document.getElementById('cropCancelBtn').onclick = () => { cropper.destroy(); cropModal.style.display = 'none'; resolve(null); }; 
        }; 
      }); 
    }

    async function apiUpdate(data) {
      try {
        const resp = await fetch('http://localhost:3000/api/user/update', {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${userToken}`, 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(data)
        });

        if (!resp.ok) {
          throw new Error(`è¯·æ±‚å¤±è´¥ï¼š${resp.status} ${resp.statusText}`);
        }

        const result = await resp.json();
        log('apiUpdateè¿”å›ç»“æœ', result);
        return result;
      } catch (e) {
        log('apiUpdateè¯·æ±‚å¤±è´¥', e);
        alert('æ¥å£è¯·æ±‚å¤±è´¥ï¼š' + e.message);
        return { code: 500, msg: e.message };
      }
    }

    async function getUserInfo() {
      try {
        const decoded = parseJwt(userToken);
        if (!decoded) {
          alert('ç™»å½•å‡­è¯è§£æå¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•ï¼');
          localStorage.removeItem('music_user_token');
          window.location.href = 'login.html';
          return;
        }
        username = decoded.username || decoded.sub || '';
        log('è§£æå‡ºçš„ç”¨æˆ·å', username);

        const resp = await fetch('http://localhost:3000/api/user/info', { 
          headers: { 
            'Authorization': `Bearer ${userToken}`,
            'Accept': 'application/json'
          },
          credentials: 'include'
        });

        if (!resp.ok) {
          throw new Error(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š${resp.status} ${resp.statusText}`);
        }

        const result = await resp.json();
        log('getUserInfoè¿”å›ç»“æœ', result);
        
        if (result.code !== 200) {
          throw new Error(result.msg || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
        }

        const data = result.data || {};
        const userNickname = data.nick_name || data.nickname || username;
        document.getElementById('username').textContent = username || 'æœªçŸ¥ç”¨æˆ·';
        document.getElementById('nickname').textContent = userNickname;
        document.getElementById('showNickname').textContent = userNickname;
        
        const joinTime = data.created_at || data.createdAt;
        if (joinTime) {
          document.getElementById('joinTime').textContent = new Date(joinTime).toLocaleDateString();
        } else {
          document.getElementById('joinTime').textContent = 'æœªçŸ¥';
        }
        
        const avatarImg = document.getElementById('userAvatarImg');
        const avatarTxt = document.getElementById('userAvatar');
        const avatarUrl = data.avatar || data.avatar_url || '';
        if (avatarUrl && avatarUrl.trim() !== '') { 
          avatarImg.src = avatarUrl; 
          avatarImg.style.display = 'block'; 
          avatarTxt.style.display = 'none'; 
          avatarImg.onerror = () => {
            avatarImg.style.display = 'none';
            avatarTxt.style.display = 'flex';
            avatarTxt.textContent = userNickname.charAt(0).toUpperCase();
          };
        } else {
          avatarTxt.textContent = userNickname.charAt(0).toUpperCase();
        }

        document.getElementById('changeAvatarBtn').onclick = () => document.getElementById('avatarInput').click();
        document.getElementById('avatarInput').onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const cropped = await cropSelectedImage(file);
          if (cropped) {
            const base64 = await compressImage(cropped);
            const res = await apiUpdate({ 
              avatar: base64,
              avatar_url: base64 
            });
            if (res.code === 200) { 
              avatarImg.src = base64; 
              avatarImg.style.display = 'block'; 
              avatarTxt.style.display = 'none'; 
              alert('å¤´åƒä¿®æ”¹æˆåŠŸï¼');
            } else {
              alert('å¤´åƒä¿®æ”¹å¤±è´¥ï¼š' + (res.msg || 'æœªçŸ¥é”™è¯¯'));
            }
          }
          e.target.value = '';
        };

        const nickModal = document.getElementById('nicknameModal');
        const nickInput = document.getElementById('nicknameInput');
        document.getElementById('editNicknameBtn').onclick = () => {
          nickInput.value = userNickname;
          nickModal.style.display = 'flex';
          nickInput.focus();
          nickInput.select();
        };
        document.getElementById('cancelNicknameBtn').onclick = () => nickModal.style.display = 'none';
        document.getElementById('saveNicknameBtn').onclick = async () => {
          const val = nickInput.value.trim();
          if (val.length < 2) {
            return alert('æ˜µç§°é•¿åº¦ä¸èƒ½å°‘äº2ä¸ªå­—ç¬¦ï¼');
          }
          if (val.length > 10) {
            return alert('æ˜µç§°é•¿åº¦ä¸èƒ½è¶…è¿‡10ä¸ªå­—ç¬¦ï¼');
          }
          
          const res = await apiUpdate({ 
            nickname: val,
            nick_name: val 
          });
          if (res.code === 200) { 
            document.getElementById('nickname').textContent = val;
            document.getElementById('showNickname').textContent = val;
            nickModal.style.display = 'none';
            alert('æ˜µç§°ä¿®æ”¹æˆåŠŸï¼');
          } else {
            alert('æ˜µç§°ä¿®æ”¹å¤±è´¥ï¼š' + (res.msg || 'æœªçŸ¥é”™è¯¯'));
          }
        };
      } catch (e) { 
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š', e);
        alert('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š' + e.message + 'ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        document.getElementById('loading').style.display = 'none';
        document.getElementById('profileContent').style.display = 'block';
      }
    }

    async function getRatings() {
      const fetchRatings = async (type) => {
        try {
          const res = await fetch(`http://localhost:3000/api/user/ratings/${type}`, { 
            headers: { 
              'Authorization': `Bearer ${userToken}`,
              'Accept': 'application/json'
            },
            credentials: 'include'
          });

          if (!res.ok) {
            throw new Error(`è·å–${type}è¯„åˆ†å¤±è´¥ï¼š${res.status} ${res.statusText}`);
          }

          const result = await res.json();
          log(`getRatings-${type}è¿”å›ç»“æœ`, result);
          return result;
        } catch (e) {
          log(`fetchRatings-${type}è¯·æ±‚å¤±è´¥`, e);
          alert(`è·å–${type}è¯„åˆ†å¤±è´¥ï¼š${e.message}`);
          return { code: 500, msg: e.message };
        }
      };

      try {
        const songs = await fetchRatings('songs');
        const singles = await fetchRatings('singles');

        const render = (targetId, countId, data, isSingle) => {
          if (!data || data.code !== 200) {
            document.getElementById(countId).textContent = 0;
            document.getElementById(targetId).innerHTML = `<tr><td colspan="4" class="empty-tip">åŠ è½½${isSingle ? 'å•æ›²' : 'æ­Œæ›²'}è¯„åˆ†å¤±è´¥</td></tr>`;
            return;
          }
          
          const ratingData = data.data || [];
          log(`æ¸²æŸ“${isSingle ? 'å•æ›²' : 'æ­Œæ›²'}è¯„åˆ†æ•°æ®`, ratingData);
          document.getElementById(countId).textContent = ratingData.length;
          const body = document.getElementById(targetId);
          
          if (ratingData.length > 0) {
            body.innerHTML = ratingData.map(item => {
              const itemData = isSingle ? (item.single || {}) : (item.song || {});
              const albumData = item.album || {};
              const ratingData = item.rating || {};
              
              const name = itemData.name_cn || itemData.name || 'æœªçŸ¥';
              const subInfo = isSingle ? (itemData.release_date || itemData.release_at || '--') : (albumData.name_cn || albumData.name || '--');
              const score = ratingData.score || 0;
              const time = ratingData.createdAt || ratingData.created_at || '--';
              const showTime = time !== '--' ? new Date(time).toLocaleDateString() : '--';
              
              return `
                <tr>
                  <td><strong>${name}</strong></td>
                  <td>${subInfo}</td>
                  <td><span class="rating-score">${score} åˆ†</span></td>
                  <td>${showTime}</td>
                </tr>
              `;
            }).join('');
          } else {
            body.innerHTML = `<tr><td colspan="4" class="empty-tip">æš‚æ— ${isSingle ? 'å•æ›²' : 'æ­Œæ›²'}è¯„åˆ†</td></tr>`;
          }
        };
        
        render('songRatingList', 'songRatingCount', songs, false);
        render('singleRatingList', 'singleRatingCount', singles, true);
      } catch (e) {
        console.error('è·å–è¯„åˆ†æ•°æ®å¤±è´¥ï¼š', e);
        alert('è·å–è¯„åˆ†æ•°æ®å¤±è´¥ï¼š' + e.message + 'ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }

    // ========== æ¶ˆæ¯é€šçŸ¥åŠŸèƒ½ã€æ ¸å¿ƒå®Œæ•´ç‰ˆ - å«å®Œæ•´è·³è½¬åŠŸèƒ½+æ— 404æŠ¥é”™ã€‘ ==========
    let currentNotificationPage = 1;
    let notificationPageSize = 10;
    let totalNotificationPages = 1;
    let unreadCount = 0;
    let notificationInterval = null;

    // æ›´æ–°æœªè¯»å¾½ç« æ˜¾ç¤º
    function updateUnreadBadge() {
      const badge = document.getElementById('unreadCountBadge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }

    // è·å–é€šçŸ¥åˆ—è¡¨ - ä»åˆ—è¡¨æ¥å£è¿”å›æ•°æ®ä¸­æå– unreadCount æœªè¯»æ•°é‡
    async function fetchNotifications(page = 1, pageSize = 10, unreadOnly = false) {
      try {
        const token = localStorage.getItem('music_user_token');
        const response = await fetch(
          `http://localhost:3000/api/notifications?page=${page}&pageSize=${pageSize}&unreadOnly=${unreadOnly}`,
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            credentials: 'include'
          }
        );
        
        if (!response.ok) throw new Error('è·å–é€šçŸ¥å¤±è´¥');
        const result = await response.json();
        
        if (result.code === 200) {
          unreadCount = result.data.unreadCount || result.data.notifications.filter(item=>!item.is_read).length || 0;
          updateUnreadBadge();
          return result.data;
        } else {
          throw new Error(result.msg);
        }
      } catch (error) {
        console.error('è·å–é€šçŸ¥å¤±è´¥:', error);
        unreadCount = 0;
        updateUnreadBadge();
        throw error;
      }
    }

    // æ ‡è®°å•æ¡é€šçŸ¥ä¸ºå·²è¯»
    async function markNotificationAsRead(notificationId) {
      try {
        const token = localStorage.getItem('music_user_token');
        const response = await fetch(`http://localhost:3000/api/notifications/${notificationId}/read`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'include'
        });
        
        if (!response.ok) throw new Error('æ ‡è®°å·²è¯»å¤±è´¥');
        const result = await response.json();
        
        if (result.code === 200) {
          return true;
        } else {
          throw new Error(result.msg);
        }
      } catch (error) {
        console.error('æ ‡è®°å·²è¯»å¤±è´¥:', error);
        throw error;
      }
    }

    // æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
    async function markAllNotificationsAsRead() {
      try {
        const token = localStorage.getItem('music_user_token');
        const response = await fetch('http://localhost:3000/api/notifications/read-all', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'include'
        });
        
        if (!response.ok) throw new Error('æ ‡è®°å…¨éƒ¨å·²è¯»å¤±è´¥');
        const result = await response.json();
        
        if (result.code === 200) {
          unreadCount = 0;
          updateUnreadBadge();
          return true;
        } else {
          throw new Error(result.msg);
        }
      } catch (error) {
        console.error('æ ‡è®°å…¨éƒ¨å·²è¯»å¤±è´¥:', error);
        throw error;
      }
    }

    // åˆ é™¤é€šçŸ¥
    async function deleteNotification(notificationId) {
      try {
        const token = localStorage.getItem('music_user_token');
        const response = await fetch(`http://localhost:3000/api/notifications/${notificationId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'include'
        });
        
        if (!response.ok) throw new Error('åˆ é™¤é€šçŸ¥å¤±è´¥');
        const result = await response.json();
        
        if (result.code === 200) {
          return true;
        } else {
          throw new Error(result.msg);
        }
      } catch (error) {
        console.error('åˆ é™¤é€šçŸ¥å¤±è´¥:', error);
        throw error;
      }
    }

    // ä¼˜åŒ–ï¼šæ ¼å¼åŒ–æ—¶é—´ï¼Œæ›´å‹å¥½
    function formatTime(timeStr) {
        const date = new Date(timeStr);
        return date.toLocaleString('zh-CN',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
    }

    // âœ… æ ¸å¿ƒä¼˜åŒ–ï¼šæ¸²æŸ“é€šçŸ¥åˆ—è¡¨ - æºå¸¦è·³è½¬ä¿¡æ¯+è¯„è®ºé¢„è§ˆ
    function renderNotifications(notifications, pagination) {
      const container = document.getElementById('notificationList');
      const paginationContainer = document.getElementById('notificationPagination');
      
      if (!notifications || notifications.length === 0) {
        container.innerHTML = '<div class="empty-tip">æš‚æ— æ¶ˆæ¯é€šçŸ¥</div>';
        paginationContainer.style.display = 'none';
        return;
      }
      
      totalNotificationPages = pagination.totalPages || 1;
      currentNotificationPage = pagination.page || 1;
      
      container.innerHTML = notifications.map(notification => {
        const isUnread = !notification.is_read;
        const senderAvatar = notification.sender_avatar || '';
        const senderName = notification.sender_nickname || notification.sender_username || 'æœªçŸ¥ç”¨æˆ·';
        const notificationTime = formatTime(notification.createdAt);
        const notificationType = notification.type === 'reply' ? 'å›å¤' : 'ç‚¹èµ';
        const jumpInfo = notification.jumpInfo || {};
        const commentContent = notification.commentContent || '';
        
        return `
          <div class="notification-item ${isUnread ? 'unread' : ''}" data-id="${notification._id}" data-jump-info='${JSON.stringify(jumpInfo)}'>
            ${senderAvatar ? 
              `<img src="${senderAvatar}" alt="${senderName}" class="notification-avatar" onerror="this.style.display='none';this.parentNode.innerHTML='<div class=notification-avatar style=background:var(--primary-gradient);color:white;display:flex;align-items:center;justify-content:center;font-weight:bold>${senderName.charAt(0)}</div>'">` : 
              `<div class="notification-avatar" style="background: var(--primary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${senderName.charAt(0)}</div>`
            }
            <div class="notification-content">
              <div class="notification-sender">${senderName}</div>
              <div class="notification-text">${notification.content}</div>
              ${commentContent ? `<div class="notification-comment">"${commentContent}"</div>` : ''}
              <div class="notification-time">${notificationTime} Â· ${notificationType}</div>
              ${isUnread ? `
                <div class="notification-actions">
                  <button class="notification-action-btn primary mark-read-btn">æ ‡è®°å·²è¯»</button>
                  <button class="notification-action-btn delete-btn">åˆ é™¤</button>
                </div>
              ` : `
                <div class="notification-actions">
                  <button class="notification-action-btn delete-btn">åˆ é™¤</button>
                </div>
              `}
            </div>
          </div>
        `;
      }).join('');
      
      paginationContainer.style.display = 'flex';
      document.getElementById('pageInfo').textContent = `ç¬¬ ${currentNotificationPage} é¡µ / å…± ${totalNotificationPages} é¡µ`;
      document.getElementById('prevPageBtn').disabled = currentNotificationPage <= 1;
      document.getElementById('nextPageBtn').disabled = currentNotificationPage >= totalNotificationPages;
      
      bindNotificationEvents();
    }

    // âœ… æ ¸å¿ƒå®Œæ•´ç‰ˆï¼šç»‘å®šé€šçŸ¥äº‹ä»¶ - ç‚¹å‡»è‡ªåŠ¨æ ‡ä¸ºå·²è¯» + å®Œæ•´è·³è½¬åŠŸèƒ½
    function bindNotificationEvents() {
      // æ ‡è®°å·²è¯»æŒ‰é’®äº‹ä»¶
      document.querySelectorAll('.mark-read-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const notificationItem = e.target.closest('.notification-item');
          const notificationId = notificationItem.dataset.id;
          
          try {
            await markNotificationAsRead(notificationId);
            notificationItem.classList.remove('unread');
            e.target.closest('.notification-actions').innerHTML = '<button class="notification-action-btn delete-btn">åˆ é™¤</button>';
            unreadCount = Math.max(0, unreadCount - 1);
            updateUnreadBadge();
          } catch (error) {
            alert('æ ‡è®°å·²è¯»å¤±è´¥ï¼š' + error.message);
          }
        });
      });
      
      // åˆ é™¤æŒ‰é’®äº‹ä»¶
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const notificationItem = e.target.closest('.notification-item');
          const notificationId = notificationItem.dataset.id;
          
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡é€šçŸ¥å—ï¼Ÿ')) {
            try {
              await deleteNotification(notificationId);
              const isUnread = notificationItem.classList.contains('unread');
              notificationItem.remove();
              
              if (isUnread) {
                unreadCount = Math.max(0, unreadCount - 1);
                updateUnreadBadge();
              }
              
              const container = document.getElementById('notificationList');
              if (container.children.length === 0) {
                container.innerHTML = '<div class="empty-tip">æš‚æ— æ¶ˆæ¯é€šçŸ¥</div>';
                document.getElementById('notificationPagination').style.display = 'none';
              }
            } catch (error) {
              alert('åˆ é™¤é€šçŸ¥å¤±è´¥ï¼š' + error.message);
            }
          }
        });
      });
      
      // âœ… æ ¸å¿ƒåŠŸèƒ½ï¼šç‚¹å‡»é€šçŸ¥æ¡ç›® â†’ è‡ªåŠ¨æ ‡ä¸ºå·²è¯» + è·³è½¬åˆ°å¯¹åº”è¯„è®ºä½ç½®
      document.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', async (e) => {
          if (e.target.tagName === 'BUTTON') return;
          
          const notificationItem = e.target.closest('.notification-item');
          const notificationId = notificationItem.dataset.id;
          const jumpInfoStr = notificationItem.dataset.jumpInfo;
          const isUnread = notificationItem.classList.contains('unread');
          
          // ç‚¹å‡»åè‡ªåŠ¨æ ‡ä¸ºå·²è¯»
          if(isUnread){
              try {
                await markNotificationAsRead(notificationId);
                notificationItem.classList.remove('unread');
                const actions = notificationItem.querySelector('.notification-actions');
                if (actions) {
                  actions.innerHTML = '<button class="notification-action-btn delete-btn">åˆ é™¤</button>';
                }
                unreadCount = Math.max(0, unreadCount - 1);
                updateUnreadBadge();
              } catch (error) {
                console.log('è‡ªåŠ¨æ ‡ä¸ºå·²è¯»å¤±è´¥', error);
              }
          }
          
          // å¤„ç†è·³è½¬é€»è¾‘
          if (jumpInfoStr) {
            try {
              const jumpInfo = JSON.parse(jumpInfoStr);
              await handleNotificationJump(jumpInfo, notificationItem);
            } catch (error) {
              console.error('è§£æè·³è½¬ä¿¡æ¯å¤±è´¥:', error);
              alert('è·³è½¬ä¿¡æ¯æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è·³è½¬');
            }
          } else {
            console.warn('è¯¥é€šçŸ¥æ²¡æœ‰è·³è½¬ä¿¡æ¯');
            alert('è¯¥é€šçŸ¥æ— æ³•è·³è½¬ï¼Œå…³è”è¯„è®ºå¯èƒ½å·²è¢«åˆ é™¤');
          }
        });
      });
    }

    // ========== æ–°å¢ï¼šé€šçŸ¥è·³è½¬æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ==========
     async function handleNotificationJump(jumpInfo, notificationItem) {
      try {
        if (!jumpInfo || !jumpInfo.jumpPath) {
          throw new Error('è·³è½¬ä¿¡æ¯ä¸å®Œæ•´');
        }
        
        const { jumpPath, resourceType, resourceId, commentId, hasParentComment } = jumpInfo;
        
        console.log('å¼€å§‹è·³è½¬:', { jumpPath, resourceType, resourceId, commentId });
        
        // æ„å»ºå®Œæ•´çš„è·³è½¬URL
        let targetUrl = '';
        
        if (jumpPath.startsWith('/')) {
          // å¤„ç†åç«¯è¿”å›çš„è·¯å¾„æ ¼å¼ï¼š/song/song_2002_03 -> songs-details.html?resourceId=song_2002_03&resourceType=song
          const pathParts = jumpPath.split('/');
          if (pathParts.length >= 3) {
            const type = pathParts[1]; // song, single, album
            const id = pathParts[2];   // resourceId
            
            switch (type) {
              case 'song':
              case 'single':
                targetUrl = `songs-details.html?resourceId=${id}&resourceType=${type}`;
                break;
              case 'album':
                targetUrl = `album-details.html?resourceId=${id}&resourceType=${type}`;
                break;
              default:
                targetUrl = `songs-details.html?resourceId=${id}&resourceType=${type}`;
            }
          } else {
            // å¦‚æœè·¯å¾„æ ¼å¼ä¸æ­£ç¡®ï¼Œä½¿ç”¨é»˜è®¤é€»è¾‘
            targetUrl = `songs-details.html?resourceId=${resourceId}&resourceType=${resourceType}`;
          }
        } else {
          // ç›´æ¥ä½¿ç”¨resourceTypeå’ŒresourceIdæ„å»ºURL
          switch (resourceType) {
            case 'song':
            case 'single':
              targetUrl = `songs-details.html?resourceId=${resourceId}&resourceType=${resourceType}`;
              break;
            case 'album':
              targetUrl = `album-details.html?resourceId=${resourceId}&resourceType=${resourceType}`;
              break;
            default:
              targetUrl = `songs-details.html?resourceId=${resourceId}&resourceType=${resourceType}`;
          }
        }
        
        // æ·»åŠ è¯„è®ºé«˜äº®å‚æ•°ï¼Œä¾›è¯¦æƒ…é¡µå®šä½è¯„è®º
        if (commentId) {
          targetUrl += (targetUrl.includes('?') ? '&' : '?') + `highlightComment=${commentId}`;
        }
        
        // æ˜¾ç¤ºè·³è½¬åŠ è½½åŠ¨ç”»
        showJumpLoading();
        
        // å»¶è¿Ÿè·³è½¬ï¼Œç¡®ä¿æ ‡è®°å·²è¯»æ“ä½œå®Œæˆ
        setTimeout(() => {
          console.log('è·³è½¬åˆ°:', targetUrl);
          window.location.href = targetUrl;
        }, 500);
        
      } catch (error) {
        console.error('è·³è½¬å¤±è´¥:', error);
        handleJumpError(error, notificationItem);
      }
    }
    // æ˜¾ç¤ºè·³è½¬åŠ è½½çŠ¶æ€
    function showJumpLoading() {
      const loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'jump-loading-overlay';
      loadingOverlay.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 12px; color: var(--text-main);">
          <div style="text-align: center; margin-bottom: 10px;">ğŸš€ æ­£åœ¨è·³è½¬åˆ°è¯„è®ºé¡µé¢...</div>
          <div style="display: flex; justify-content: center;">
            <div style="width: 30px; height: 30px; border: 3px solid #f3f4f6; border-top: 3px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
          </div>
        </div>
      `;
      document.body.appendChild(loadingOverlay);
    }

    // éšè—è·³è½¬åŠ è½½çŠ¶æ€
    function hideJumpLoading() {
      const loadingOverlay = document.getElementById('jump-loading-overlay');
      if (loadingOverlay) {
        loadingOverlay.remove();
      }
    }

    // å¤„ç†è·³è½¬é”™è¯¯
    function handleJumpError(error, notificationItem) {
      hideJumpLoading();
      if (error.message.includes('ä¸å®Œæ•´')) {
        alert('æ— æ³•è·³è½¬ï¼šå…³è”è¯„è®ºä¿¡æ¯ä¸å®Œæ•´');
      } else if (error.message.includes('ä¸å­˜åœ¨')) {
        alert('æ— æ³•è·³è½¬ï¼šå…³è”è¯„è®ºå¯èƒ½å·²è¢«åˆ é™¤');
      } else {
        alert('è·³è½¬å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    // åŠ è½½é€šçŸ¥åˆ—è¡¨ - å¢åŠ åŠ è½½æç¤º
    async function loadNotifications() {
      try {
        const container = document.getElementById('notificationList');
        container.innerHTML = '<div class="loading-tip">åŠ è½½ä¸­...</div>';
        
        const filter = document.getElementById('notificationFilter').value;
        const unreadOnly = filter === 'unread';
        const data = await fetchNotifications(currentNotificationPage, notificationPageSize, unreadOnly);
        renderNotifications(data.notifications, data.pagination);
      } catch (error) {
        console.error('åŠ è½½é€šçŸ¥å¤±è´¥:', error);
        document.getElementById('notificationList').innerHTML = '<div class="empty-tip">åŠ è½½é€šçŸ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
        document.getElementById('notificationPagination').style.display = 'none';
      }
    }

    // åˆå§‹åŒ–æ¶ˆæ¯é€šçŸ¥åŠŸèƒ½
    function initNotifications() {
      // å…¨éƒ¨æ ‡ä¸ºå·²è¯»
      document.getElementById('markAllReadBtn').addEventListener('click', async () => {
        if (unreadCount === 0) {
          alert('æ²¡æœ‰æœªè¯»é€šçŸ¥');
          return;
        }
        
        if (confirm('ç¡®å®šè¦å°†æ‰€æœ‰é€šçŸ¥æ ‡è®°ä¸ºå·²è¯»å—ï¼Ÿ')) {
          try {
            await markAllNotificationsAsRead();
            await loadNotifications();
            alert('å…¨éƒ¨æ ‡è®°å·²è¯»æˆåŠŸï¼');
          } catch (error) {
            alert('æ ‡è®°å…¨éƒ¨å·²è¯»å¤±è´¥ï¼š' + error.message);
          }
        }
      });
      
      // åˆ·æ–°æŒ‰é’®
      document.getElementById('refreshNotificationsBtn').addEventListener('click', () => {
        loadNotifications();
      });
      
      // ç­›é€‰åˆ‡æ¢
      document.getElementById('notificationFilter').addEventListener('change', () => {
        currentNotificationPage = 1;
        loadNotifications();
      });
      
      // åˆ†é¡µæŒ‰é’®
      document.getElementById('prevPageBtn').addEventListener('click', () => {
        if (currentNotificationPage > 1) {
          currentNotificationPage--;
          loadNotifications();
        }
      });
      
      document.getElementById('nextPageBtn').addEventListener('click', () => {
        if (currentNotificationPage < totalNotificationPages) {
          currentNotificationPage++;
          loadNotifications();
        }
      });
      
      // åˆå§‹åŒ–åŠ è½½é€šçŸ¥
      loadNotifications();
      // å®šæ—¶å™¨ï¼šæ¯30ç§’åˆ·æ–°é€šçŸ¥åˆ—è¡¨ï¼Œæ— æŠ¥é”™
      notificationInterval = setInterval(loadNotifications, 30000);
    }

    // ========== é¡µé¢åŠ è½½å…¥å£ ==========
    window.onload = async () => {
      if (checkLogin()) {
        try {
          await getUserInfo();
          await getRatings();
          initNotifications();
        } catch (e) {
          log('é¡µé¢åŠ è½½ä¸»æµç¨‹å¤±è´¥', e);
          alert('é¡µé¢åŠ è½½å¤±è´¥ï¼š' + e.message);
        } finally {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('profileContent').style.display = 'block';
        }
      }
      document.getElementById('logoutBtn').onclick = () => {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) { 
          if (notificationInterval) clearInterval(notificationInterval);
          localStorage.removeItem('music_user_token'); 
          localStorage.removeItem('music_user_info');
          window.location.href = 'login.html'; 
        }
      };
    };
  </script>
</body>
</html>