<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>歌曲列表 - 音乐收藏</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  
  <style>
    /* ========== 列表页专属样式 ========== */
    :root {
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --bg-body: #fbfcfd;
      --bg-card: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border-color: #f1f5f9;
      --accent-orange: #f59e0b;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --nav-height: 60px; /* 导航栏高度，仅用于适配 */
      --highlight-color: rgba(99, 102, 241, 0.1); /* 歌曲高亮背景色 */
      --highlight-border: 1px solid #6366f1; /* 歌曲高亮边框 */
    }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      padding: calc(3rem + var(--nav-height)) 1rem 3rem;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: var(--shadow);
      border: 1px solid rgba(226, 232, 240, 0.5);
    }

    h1 {
      text-align: left;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 2rem;
      position: relative;
      display: flex;
      align-items: center;
      color: var(--text-main);
    }

    h1::before {
      content: '';
      width: 4px;
      height: 1.25rem;
      background: var(--primary);
      margin-right: 12px;
      border-radius: 4px;
    }

    /* 新增：搜索框样式 */
    .search-box {
      display: flex;
      gap: 12px;
      margin-bottom: 0.8rem;
      width: 100%;
      max-width: 500px;
    }
    .search-input {
      flex: 1;
      padding: 0.8rem 1.2rem;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.9rem;
      outline: none;
      transition: all 0.2s;
    }
    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    .search-btn {
      padding: 0.8rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .search-btn:hover {
      background: var(--primary-hover);
    }

    /* ========== 新增：搜索历史记录样式 - 核心需求 ========== */
    .search-history {
      width: 100%;
      max-width: 500px;
      margin-bottom: 2rem;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .history-title {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-right: 8px;
      white-space: nowrap;
    }
    .history-item {
      padding: 4px 12px;
      background: #f8fafc;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s;
    }
    .history-item:hover {
      background: var(--highlight-color);
      border-color: var(--primary);
      color: var(--primary);
    }
    .clear-history {
      font-size: 0.8rem;
      color: var(--text-muted);
      cursor: pointer;
      margin-left: auto;
      transition: color 0.2s;
    }
    .clear-history:hover {
      color: var(--primary);
    }
    .history-empty {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .song-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .song-table th {
      background-color: #f8fafc;
      color: var(--text-muted);
      padding: 1rem 1.25rem;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-color);
    }

    .song-table td {
      padding: 1.25rem;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.925rem;
      transition: all 0.2s ease;
    }

    .song-item {
      cursor: pointer;
      transition: background-color 0.2s;
      border-radius: 8px;
    }

    .song-item:hover {
      background-color: #f8faff;
    }

    .song-item:hover td {
      color: var(--primary);
    }

    /* 高亮歌曲样式 */
    .song-item.highlight {
      background-color: var(--highlight-color);
      border: var(--highlight-border);
      border-left: none;
      border-right: none;
    }
    .song-item.highlight td {
      color: var(--primary);
      font-weight: 600;
    }

    .song-name {
      font-weight: 600;
      color: var(--text-main);
    }

    .score-badge {
      display: inline-flex;
      align-items: center;
      font-weight: 700;
      color: var(--accent-orange);
      background: rgba(245, 158, 11, 0.1);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
    }

    .rating-count {
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-left: 6px;
      font-weight: normal;
    }

    .pagination {
      margin-top: 2.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
    }

    .pagination button {
      padding: 0.6rem 1.25rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      color: var(--text-main);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
    }

    .pagination button:hover:not(:disabled) {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }

    .pagination button:disabled {
      cursor: not-allowed;
      opacity: 0.4;
      background: #f1f5f9;
    }

    .pagination span {
      color: var(--text-muted);
      font-size: 0.875rem;
      font-variant-numeric: tabular-nums;
    }

    .tip-row {
      text-align: center;
      padding: 4rem !important;
      color: var(--text-muted);
      font-style: italic;
    }

    @media (max-width: 640px) {
      .container { 
        padding: 1.5rem; 
      }
      .song-table th:nth-child(3), 
      .song-table td:nth-child(3) { 
        display: none; 
      }
      body { 
        padding: calc(2rem + var(--nav-height)) 1rem 2rem; 
      }
      .search-box, .search-history {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- 导航栏：结构不变 -->
  <nav class="nav">
    <ul>
      <li><a href="index.html">首页</a></li>
      <li><a href="about.html">专辑</a></li>
      <li><a href="songs-list.html">评分</a></li>
    </ul>
    <div class="auth-buttons" id="authContainer">
      <a href="login.html" class="register-btn" id="loginBtn">登录</a>
      <div class="avatar-container" id="avatarContainer" style="display: none;">
        <img src="" alt="用户头像" id="navAvatar" class="nav-avatar">
        <div class="avatar-dropdown">
          <a href="user-profile.html">个⼈中心</a>
          <a href="javascript:logout()" id="logoutLink">退出登录</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- 歌曲列表容器 -->
  <div class="container">
    <h1>歌曲列表</h1>
    
    <!-- ========== 搜索框 DOM ========== -->
    <div class="search-box">
      <input type="text" class="search-input" id="searchKeyword" placeholder="输入歌曲名搜索...">
      <button class="search-btn" id="searchBtn">搜索歌曲</button>
    </div>

    <!-- ========== 核心新增：搜索历史记录容器 ========== -->
    <div class="search-history" id="searchHistory"></div>

    <div class="table-wrapper">
      <table class="song-table">
        <thead>
          <tr>
            <th>歌名</th>
            <th>专辑</th>
            <th>发行时间</th>
            <th>评分详情</th>
          </tr>
        </thead>
        <tbody id="songList">
        </tbody>
      </table>
    </div>

    <div class="pagination">
      <button id="prevBtn" disabled>← 上一页</button>
      <span id="pageInfo">第 1 页 / 共 0 页</span>
      <button id="nextBtn" disabled>下一页 →</button>
    </div>
  </div>

  <script>
    // ========== 1. 核心变量与基础函数 ==========
    let currentPage = parseInt(sessionStorage.getItem('songListCurrentPage')) || 1;
    let totalPages = 0;
    let pageScrollPositions = JSON.parse(sessionStorage.getItem('pageScrollPositions')) || {};
    let hasRestoredScroll = false;
    // 搜索相关核心变量
    let isSearchMode = false; 
    let searchKeyword = '';    
    let targetSongId = '';    
    // 新增：搜索历史配置 - 最多保存10条
    const MAX_HISTORY = 10;

    // 防XSS转义
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    // ========== 新增：搜索历史 核心方法 【重中之重】 ==========
    // 1. 获取本地存储的搜索历史
    function getSearchHistory() {
      const history = localStorage.getItem('songSearchHistory');
      return history ? JSON.parse(history) : [];
    }
    // 2. 保存搜索关键词到历史（自动去重、最多10条）
    function saveSearchHistory(keyword) {
      if (!keyword.trim()) return;
      let history = getSearchHistory();
      // 去重：如果已有该关键词，先删除再添加到最前面
      history = history.filter(item => item !== keyword.trim());
      // 新增到头部
      history.unshift(keyword.trim());
      // 只保留最多10条
      if (history.length > MAX_HISTORY) history = history.slice(0, MAX_HISTORY);
      // 存入本地
      localStorage.setItem('songSearchHistory', JSON.stringify(history));
      // 刷新历史展示
      renderSearchHistory();
    }
    // 3. 渲染搜索历史到页面
    function renderSearchHistory() {
      const historyEl = document.getElementById('searchHistory');
      const history = getSearchHistory();
      if (history.length === 0) {
        historyEl.innerHTML = '<span class="history-empty">暂无搜索历史</span>';
        return;
      }
      let html = '<span class="history-title">搜索历史：</span>';
      history.forEach(item => {
        html += `<span class="history-item">${escapeHtml(item)}</span>`;
      });
      html += '<span class="clear-history">清空历史</span>';
      historyEl.innerHTML = html;

      // 绑定历史项点击事件：回填关键词+搜索
      document.querySelectorAll('.history-item').forEach(item => {
        item.onclick = () => {
          const keyword = item.textContent.trim();
          document.getElementById('searchKeyword').value = keyword;
          searchAndJumpToSong(keyword, '');
        }
      });
      // 绑定清空历史事件
      document.querySelector('.clear-history').onclick = () => {
        localStorage.removeItem('songSearchHistory');
        renderSearchHistory();
      }
    }

    // ========== 2. 原有：默认按评分排序的歌曲列表渲染 ==========
    async function renderSongList(page = 1) {
      isSearchMode = false; 
      try {
        const songListEl = document.getElementById('songList');
        songListEl.innerHTML = '<tr><td colspan="4" class="tip-row">正在同步最新资源...</td></tr>';

        const response = await axios.get('http://localhost:3000/api/all-resources/sort-by-rating', {
          params: { page, pageSize: 10, _t: Date.now() },
          withCredentials: true,
          timeout: 10000
        });

        const result = response.data;
        if (result.code !== 200) {
          songListEl.innerHTML = `<tr><td colspan="4" class="tip-row">同步失败：${escapeHtml(result.msg || '未知错误')}</td></tr>`;
          return;
        }

        const { resources, pagination } = result.data;
        currentPage = pagination.page;
        totalPages = pagination.totalPages;
        sessionStorage.setItem('songListCurrentPage', currentPage);

        renderTableData(resources, pagination);
      } catch (error) {
        handleRequestError(error);
      }
    }

    // ========== 核心：搜索并跳转歌曲函数 ==========
    async function searchAndJumpToSong(keyword, songId) {
      if (!keyword.trim()) {
        alert('请输入搜索关键词');
        return;
      }
      // 保存搜索关键词到历史
      saveSearchHistory(keyword);
      
      searchKeyword = keyword.trim();
      targetSongId = songId;
      isSearchMode = true;
      hasRestoredScroll = false;

      const songListEl = document.getElementById('songList');
      songListEl.innerHTML = '<tr><td colspan="4" class="tip-row">正在搜索歌曲...</td></tr>';

      try {
        let params = {
          keyword: searchKeyword,
          pageSize: 10, // ✅ 固定每页10条搜索结果，核心配置
          _t: Date.now()
        }
        if(targetSongId) params.targetSongId = targetSongId;
        
        const response = await axios.get('http://localhost:3000/api/songs/search', {
          params: params,
          withCredentials: true,
          timeout: 10000
        });

        const data = response.data;
        if (data.code === 200) {
          let targetPage = 1;
          if(data.data.targetSongPosition){
              targetPage = data.data.targetSongPosition.page;
          }
          await loadSearchResults(targetPage);
          setTimeout(() => {
            highlightTargetSong(targetSongId);
          }, 100);
        } else {
          songListEl.innerHTML = `<tr><td colspan="4" class="tip-row">${escapeHtml(data.msg || '未找到该歌曲')}</td></tr>`;
          updatePagination();
        }
      } catch (error) {
        handleRequestError(error);
      }
    }

    // ========== 加载搜索结果列表 ==========
    async function loadSearchResults(page = 1) {
      try {
        const songListEl = document.getElementById('songList');
        songListEl.innerHTML = '<tr><td colspan="4" class="tip-row">正在加载搜索结果...</td></tr>';

        const response = await axios.get('http://localhost:3000/api/songs/search', {
          params: {
            keyword: searchKeyword,
            page: page,
            pageSize: 10, // ✅ 强制每页10条，不会变1条
            _t: Date.now()
          },
          withCredentials: true,
          timeout: 10000
        });

        const result = response.data;
        if (result.code !== 200) {
          songListEl.innerHTML = `<tr><td colspan="4" class="tip-row">搜索失败：${escapeHtml(result.msg || '未知错误')}</td></tr>`;
          return;
        }

        const { songs, pagination } = result.data;
        currentPage = pagination.page;
        totalPages = pagination.totalPages;
        sessionStorage.setItem('songListCurrentPage', currentPage);

        renderTableData(songs, pagination);

        if (!hasRestoredScroll) {
          hasRestoredScroll = true;
          requestAnimationFrame(() => {
            const scrollTop = pageScrollPositions[currentPage] || 0;
            window.scrollTo({ top: scrollTop, behavior: 'auto' });
          });
        }
      } catch (error) {
        handleRequestError(error);
      }
    }

    // ========== 高亮目标歌曲 + 滚动到可视区域 ==========
    function highlightTargetSong(songId) {
      if (!songId) return;
      document.querySelectorAll('.song-item.highlight').forEach(el => {
        el.classList.remove('highlight');
      });
      const targetItem = document.querySelector(`.song-item[data-id="${songId}"]`);
      if (targetItem) {
        targetItem.classList.add('highlight');
        targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
          targetItem.classList.remove('highlight');
        }, 3000);
      }
    }

    // ========== 公共：表格数据渲染封装 ==========
    function renderTableData(dataList, pagination) {
      const songListEl = document.getElementById('songList');
      if (!dataList || dataList.length === 0) {
        songListEl.innerHTML = '<tr><td colspan="4" class="tip-row">暂无相关歌曲数据</td></tr>';
        updatePagination();
        return;
      }

      const fragment = document.createDocumentFragment();
      dataList.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'song-item';
        tr.dataset.id = item.id;
        tr.innerHTML = `
          <td class="song-name">${escapeHtml(item.name_cn)}</td>
          <td style="color: var(--text-muted)">${escapeHtml(item.album_name || '单曲/未知')}</td>
          <td style="color: var(--text-muted)">${escapeHtml(item.release_date || '—')}</td>
          <td>
            <span class="score-badge">${item.averageScore || '0.0'}</span>
            <span class="rating-count">${item.ratingCount || 0} 评分</span>
          </td>
        `;

        tr.onclick = () => {
          searchAndJumpToSong(item.name_cn, item.id);
          const resourceId = encodeURIComponent(item.id);
          const resourceType = encodeURIComponent(item.type || 'song');
          sessionStorage.setItem('songListCurrentPage', currentPage);
          window.location.replace(`./songs-details.html?resourceId=${resourceId}&resourceType=${resourceType}`);
        };

        fragment.appendChild(tr);
      });

      songListEl.innerHTML = '';
      songListEl.appendChild(fragment);
      updatePagination();
    }

    // ========== 公共：请求错误统一处理 ==========
    function handleRequestError(error) {
      console.error('Data fetch error:', error);
      let errorMsg = '网络连接异常';
      if (error.response) errorMsg = `服务器异常 (${error.response.status})`;
      else if (error.request) errorMsg = '无法连接到后端，请检查后端服务';
      document.getElementById('songList').innerHTML = `<tr><td colspan="4" class="tip-row">${escapeHtml(errorMsg)}</td></tr>`;
    }

    // 更新分页
    function updatePagination() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');

      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages || totalPages === 0;
      pageInfo.textContent = totalPages === 0 ? '0 / 0' : `第 ${currentPage} 页 / 共 ${totalPages} 页`;
    }

    // ========== 导航栏登录状态初始化 ==========
    function initNav() {
      const token = localStorage.getItem('music_user_token');
      const loginBtn = document.getElementById('loginBtn');
      const avatarContainer = document.getElementById('avatarContainer');
      const navAvatar = document.getElementById('navAvatar');

      if (!token) {
        loginBtn.style.display = 'inline-block';
        avatarContainer.style.display = 'none';
        return;
      }

      loginBtn.style.display = 'none';
      avatarContainer.style.display = 'inline-block';

      fetch('http://127.0.0.1:3000/api/user/info', {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }).then(res => res.json()).then(result => {
        if (result.code === 200) {
          if (result.data.avatar) {
            navAvatar.src = result.data.avatar;
          } else {
            navAvatar.src = `data:image/svg+xml;base64,${btoa(`
              <svg width="36" height="36" xmlns="http://www.w3.org/2000/svg">
                <circle cx="18" cy="18" r="18" fill="#3498db"/>
                <text x="18" y="22" font-size="16" text-anchor="middle" fill="white">${result.data.username ? result.data.username.charAt(0).toUpperCase() : 'U'}</text>
              </svg>
            `)}`;
          }
        }
      }).catch(err => {
        console.error('获取用户信息失败：', err);
        localStorage.removeItem('music_user_token');
        window.location.reload();
      });
    }

    // ========== 退出登录函数 ==========
    function logout() {
      if (confirm('确定退出登录吗？')) {
        localStorage.removeItem('music_user_token');
        localStorage.removeItem('userAvatar');
        localStorage.removeItem('username');
        window.location.reload();
      }
    }

    // ========== 5. 页面初始化 + 事件绑定 ========== 
    window.onload = function() {
      initNav();
      renderSongList(currentPage);
      renderSearchHistory(); // 初始化渲染搜索历史

      // 监听滚动事件，保存滚动位置
      window.addEventListener('scroll', () => {
        pageScrollPositions[currentPage] = window.scrollY;
        sessionStorage.setItem('pageScrollPositions', JSON.stringify(pageScrollPositions));
      });

      // 搜索按钮点击事件
      document.getElementById('searchBtn').addEventListener('click', () => {
        const keyword = document.getElementById('searchKeyword').value;
        searchAndJumpToSong(keyword, '');
      });

      // 搜索框回车事件
      document.getElementById('searchKeyword').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          const keyword = e.target.value;
          searchAndJumpToSong(keyword, '');
        }
      });
    };

    // ========== ✅ 致命BUG修复：下一页按钮的减1 改为 加1 ==========
    document.getElementById('prevBtn').onclick = () => {
      if (currentPage > 1) {
        pageScrollPositions[currentPage] = window.scrollY;
        sessionStorage.setItem('pageScrollPositions', JSON.stringify(pageScrollPositions));
        hasRestoredScroll = false;
        isSearchMode ? loadSearchResults(currentPage - 1) : renderSongList(currentPage - 1);
      }
    };

    document.getElementById('nextBtn').onclick = () => {
      if (currentPage < totalPages) {
        pageScrollPositions[currentPage] = window.scrollY;
        sessionStorage.setItem('pageScrollPositions', JSON.stringify(pageScrollPositions));
        hasRestoredScroll = false;
        // ✅ 修复：renderSongList(currentPage - 1) → renderSongList(currentPage + 1)
        isSearchMode ? loadSearchResults(currentPage + 1) : renderSongList(currentPage + 1);
      }
    };

    // pageshow 兼容bfcache
    window.addEventListener('pageshow', (e) => {
      if (e.persisted) {
        const savedPage = parseInt(sessionStorage.getItem('songListCurrentPage')) || 1;
        hasRestoredScroll = false;
        isSearchMode ? loadSearchResults(savedPage) : renderSongList(savedPage);
      }
    });
  </script>
</body>
</html>