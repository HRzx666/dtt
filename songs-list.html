<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>歌曲列表 - 音乐收藏</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  
  <style>
    /* ========== 列表页专属样式 ========== */
    :root {
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --bg-body: #fbfcfd;
      --bg-card: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border-color: #f1f5f9;
      --accent-orange: #f59e0b;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --nav-height: 60px; /* 导航栏高度，仅用于适配 */
    }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      padding: calc(3rem + var(--nav-height)) 1rem 3rem;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: var(--shadow);
      border: 1px solid rgba(226, 232, 240, 0.5);
    }

    h1 {
      text-align: left;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 2rem;
      position: relative;
      display: flex;
      align-items: center;
      color: var(--text-main);
    }

    h1::before {
      content: '';
      width: 4px;
      height: 1.25rem;
      background: var(--primary);
      margin-right: 12px;
      border-radius: 4px;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .song-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .song-table th {
      background-color: #f8fafc;
      color: var(--text-muted);
      padding: 1rem 1.25rem;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-color);
    }

    .song-table td {
      padding: 1.25rem;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.925rem;
      transition: all 0.2s ease;
    }

    .song-item {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .song-item:hover {
      background-color: #f8faff;
    }

    .song-item:hover td {
      color: var(--primary);
    }

    .song-name {
      font-weight: 600;
      color: var(--text-main);
    }

    .score-badge {
      display: inline-flex;
      align-items: center;
      font-weight: 700;
      color: var(--accent-orange);
      background: rgba(245, 158, 11, 0.1);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
    }

    .rating-count {
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-left: 6px;
      font-weight: normal;
    }

    .pagination {
      margin-top: 2.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
    }

    .pagination button {
      padding: 0.6rem 1.25rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      color: var(--text-main);
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
    }

    .pagination button:hover:not(:disabled) {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }

    .pagination button:disabled {
      cursor: not-allowed;
      opacity: 0.4;
      background: #f1f5f9;
    }

    .pagination span {
      color: var(--text-muted);
      font-size: 0.875rem;
      font-variant-numeric: tabular-nums;
    }

    .tip-row {
      text-align: center;
      padding: 4rem !important;
      color: var(--text-muted);
      font-style: italic;
    }

    @media (max-width: 640px) {
      .container { 
        padding: 1.5rem; 
      }
      .song-table th:nth-child(3), 
      .song-table td:nth-child(3) { 
        display: none; 
      }
      body { 
        padding: calc(2rem + var(--nav-height)) 1rem 2rem; 
      }
    }
  </style>
</head>
<body>
  <!-- 导航栏：结构不变 -->
  <nav class="nav">
    <ul>
      <li><a href="index.html">首页</a></li>
      <li><a href="about.html">专辑</a></li>
      <li><a href="songs-list.html">评分</a></li>
    </ul>
    <div class="auth-buttons" id="authContainer">
      <a href="login.html" class="register-btn" id="loginBtn">登录</a>
      <div class="avatar-container" id="avatarContainer" style="display: none;">
        <img src="" alt="用户头像" id="navAvatar" class="nav-avatar">
        <div class="avatar-dropdown">
          <a href="user-profile.html">个人中心</a>
          <a href="javascript:logout()" id="logoutLink">退出登录</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- 歌曲列表容器 -->
  <div class="container">
    <h1>歌曲列表</h1>
    
    <div class="table-wrapper">
      <table class="song-table">
        <thead>
          <tr>
            <th>歌名</th>
            <th>专辑</th>
            <th>发行时间</th>
            <th>评分详情</th>
          </tr>
        </thead>
        <tbody id="songList">
        </tbody>
      </table>
    </div>

    <div class="pagination">
      <button id="prevBtn" disabled>← 上一页</button>
      <span id="pageInfo">第 1 页 / 共 0 页</span>
      <button id="nextBtn" disabled>下一页 →</button>
    </div>
  </div>

  <script>
    // ========== 1. 核心变量与基础函数 ==========
    let currentPage = parseInt(sessionStorage.getItem('songListCurrentPage')) || 1;
    let totalPages = 0;
    // 【新增】存储各页码的滚动位置（sessionStorage持久化，刷新不丢失）
    let pageScrollPositions = JSON.parse(sessionStorage.getItem('pageScrollPositions')) || {};
    // 【新增】防止重复恢复滚动的锁
    let hasRestoredScroll = false;

    // 防XSS转义
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    // ========== 2. 歌曲列表渲染逻辑（原有功能保留 + 新增恢复滚动位置） ==========
    async function renderSongList(page = 1) {
      try {
        const songListEl = document.getElementById('songList');
        songListEl.innerHTML = '<tr><td colspan="4" class="tip-row">正在同步最新资源...</td></tr>';

        const response = await axios.get('http://localhost:3000/api/all-resources/sort-by-rating', {
          params: { page, pageSize: 10, _t: Date.now() },
          withCredentials: true,
          timeout: 10000
        });

        const result = response.data;
        if (result.code !== 200) {
          songListEl.innerHTML = `<tr><td colspan="4" class="tip-row">同步失败：${escapeHtml(result.msg || '未知错误')}</td></tr>`;
          return;
        }

        const { resources, pagination } = result.data;
        currentPage = pagination.page;
        totalPages = pagination.totalPages;
        sessionStorage.setItem('songListCurrentPage', currentPage);

        if (!resources || resources.length === 0) {
          songListEl.innerHTML = '<tr><td colspan="4" class="tip-row">暂无相关歌曲数据</td></tr>';
          updatePagination();
          return;
        }

        const fragment = document.createDocumentFragment();
        resources.forEach(item => {
          const tr = document.createElement('tr');
          tr.className = 'song-item';
          tr.innerHTML = `
            <td class="song-name">${escapeHtml(item.name_cn)}</td>
            <td style="color: var(--text-muted)">${escapeHtml(item.album_name || '单曲/未知')}</td>
            <td style="color: var(--text-muted)">${escapeHtml(item.release_date || '—')}</td>
            <td>
              <span class="score-badge">${item.averageScore || '0.0'}</span>
              <span class="rating-count">${item.ratingCount || 0} 评分</span>
            </td>
          `;

          // 跳转详情页
          tr.onclick = () => {
            const resourceId = encodeURIComponent(item.id);
            const resourceType = encodeURIComponent(item.type || 'song');
            // 存储当前页（已存在），然后跳转（保持原逻辑）
            sessionStorage.setItem('songListCurrentPage', currentPage);
            window.location.replace(`./songs-details.html?resourceId=${resourceId}&resourceType=${resourceType}`);
          };

          fragment.appendChild(tr);
        });

        songListEl.innerHTML = '';
        songListEl.appendChild(fragment);
        updatePagination();

        // 【修改】只在首次渲染当前页时恢复当前页的滚动位置，防止被二次 render 冲掉
        if (!hasRestoredScroll) {
          hasRestoredScroll = true;
          requestAnimationFrame(() => {
            const scrollTop = pageScrollPositions[currentPage] || 0;
            window.scrollTo({
              top: scrollTop,
              behavior: 'auto' // 无动画，瞬间恢复更自然
            });
          });
        }

      } catch (error) {
        console.error('Data fetch error:', error);
        let errorMsg = '网络连接异常';
        if (error.response) errorMsg = `服务器异常 (${error.response.status})`;
        else if (error.request) errorMsg = '无法连接到后端，请检查后端服务';
        document.getElementById('songList').innerHTML = `<tr><td colspan="4" class="tip-row">${escapeHtml(errorMsg)}</td></tr>`;
      }
    }

    // 更新分页
    function updatePagination() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');

      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages || totalPages === 0;
      pageInfo.textContent = totalPages === 0 ? '0 / 0' : `第 ${currentPage} 页 / 共 ${totalPages} 页`;
    }

    // ========== 3. 导航栏登录状态初始化（移植首页完整逻辑） ==========
    function initNav() {
      const token = localStorage.getItem('music_user_token'); // 和首页统一token键名
      const loginBtn = document.getElementById('loginBtn');
      const avatarContainer = document.getElementById('avatarContainer');
      const navAvatar = document.getElementById('navAvatar');

      // 未登录状态
      if (!token) {
        loginBtn.style.display = 'inline-block';
        avatarContainer.style.display = 'none';
        return;
      }

      // 已登录：隐藏登录按钮，显示头像容器
      loginBtn.style.display = 'none';
      avatarContainer.style.display = 'inline-block';

      // 请求用户信息
      fetch('http://127.0.0.1:3000/api/user/info', {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }).then(res => res.json()).then(result => {
        if (result.code === 200) {
          // 有用户头像则显示，无则生成默认头像
          if (result.data.avatar) {
            navAvatar.src = result.data.avatar;
          } else {
            // 生成适配深色导航栏的默认头像（蓝色背景+首字母）
            navAvatar.src = `data:image/svg+xml;base64,${btoa(`
              <svg width="36" height="36" xmlns="http://www.w3.org/2000/svg">
                <circle cx="18" cy="18" r="18" fill="#3498db"/>
                <text x="18" y="22" font-size="16" text-anchor="middle" fill="white">${result.data.username ? result.data.username.charAt(0).toUpperCase() : 'U'}</text>
              </svg>
            `)}`;
          }
        }
      }).catch(err => {
        // token失效：清除token并刷新
        console.error('获取用户信息失败：', err);
        localStorage.removeItem('music_user_token');
        window.location.reload();
      });
    }

    // ========== 4. 退出登录函数（和首页一致，加确认提示） ==========
    function logout() {
      if (confirm('确定退出登录吗？')) {
        localStorage.removeItem('music_user_token');
        localStorage.removeItem('userAvatar');
        localStorage.removeItem('username');
        window.location.reload();
      }
    }

    // ========== 5. 页面初始化 ========== 
    window.onload = function() {
      // 初始化导航栏登录状态
      initNav();
      // 渲染歌曲列表
      renderSongList(currentPage);

      // 【新增】监听滚动事件，实时更新当前页的滚动位置
      window.addEventListener('scroll', () => {
        pageScrollPositions[currentPage] = window.scrollY;
        sessionStorage.setItem('pageScrollPositions', JSON.stringify(pageScrollPositions));
      });
    };

    // 【修改】分页点击事件：切换前保存当前页滚动位置并允许下页恢复滚动（重置锁）
    document.getElementById('prevBtn').onclick = () => {
      if (currentPage > 1) {
        // 保存当前页滚动位置
        pageScrollPositions[currentPage] = window.scrollY;
        sessionStorage.setItem('pageScrollPositions', JSON.stringify(pageScrollPositions));

        hasRestoredScroll = false; // ✅ 允许新页恢复滚动
        renderSongList(currentPage - 1);
      }
    };

    document.getElementById('nextBtn').onclick = () => {
      if (currentPage < totalPages) {
        // 保存当前页滚动位置
        pageScrollPositions[currentPage] = window.scrollY;
        sessionStorage.setItem('pageScrollPositions', JSON.stringify(pageScrollPositions));

        hasRestoredScroll = false; // ✅ 允许新页恢复滚动
        renderSongList(currentPage + 1);
      }
    };

    // pageshow 只在 bfcache 恢复时重新渲染，否则忽略（避免重复 render）
    window.addEventListener('pageshow', (e) => {
      if (e.persisted) {
        const savedPage = parseInt(sessionStorage.getItem('songListCurrentPage')) || 1;
        hasRestoredScroll = false; // bfcache 恢复，允许恢复对应页滚动
        renderSongList(savedPage);
      }
    });
  </script>
</body>
</html>