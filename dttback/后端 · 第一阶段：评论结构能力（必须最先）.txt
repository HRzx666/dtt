åç«¯è·å–å­è¯„è®ºæ•°æ®çš„æ ¸å¿ƒå‡½æ•°
åœ¨ songs-details.html æ–‡ä»¶ä¸­ï¼ŒloadCommentReplies å‡½æ•°è´Ÿè´£ä»åç«¯è·å–å­è¯„è®ºæ•°æ®ï¼š


songs-details.html
Apply
/**
 * åŠ è½½æŒ‡å®šçˆ¶è¯„è®ºçš„å­è¯„è®ºï¼ˆè°ƒç”¨æ¥å£ï¼‰
 * @param {string} commentId - çˆ¶è¯„è®ºID
 * @param {number} page - é¡µç ï¼Œé»˜è®¤1
 * @param {number} pageSize - æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10ï¼ˆæœ€å¤§50ï¼‰
 * @returns {Promise<Object>} å­è¯„è®ºæ•°æ®ï¼ˆåŒ…å«parentCommentã€repliesã€paginationï¼‰
 */
async function loadCommentReplies(commentId, page = 1, pageSize = 10) {
  console.group(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ å¼€å§‹åŠ è½½çˆ¶è¯„è®ºçš„å›å¤åˆ—è¡¨ï¼Œçˆ¶è¯„è®ºID=${commentId}`);
  console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ è¯·æ±‚å‚æ•°ï¼špage=${page}, pageSize=${pageSize}`);
  try {
    // é™åˆ¶pageSizeæœ€å¤§ä¸º50ï¼ˆæ¥å£è¦æ±‚ï¼‰
    const safePageSize = Math.min(pageSize, 50);
    const reqUrl = `http://localhost:3000/api/comments/${commentId}/replies?page=${page}&pageSize=${safePageSize}`;
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ è¯·æ±‚åœ°å€=${reqUrl}`);
    const response = await axios.get(reqUrl, {
      withCredentials: true,
      headers: {
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache'
      }
    });
    console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ è¯·æ±‚æˆåŠŸï¼Œå“åº”çŠ¶æ€=${response.status}, å“åº”æ•°æ®=`, response.data);
    
    if (response.data.code === 200) {
      const replyCount = response.data.data.pagination?.total || 0;
      console.log(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ åŠ è½½æˆåŠŸï¼Œå…±${replyCount}æ¡å›å¤æ•°æ®`);
      console.groupEnd();
      return response.data.data;
    } else {
      console.warn(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ åŠ è½½å¤±è´¥ï¼Œä¸šåŠ¡é”™è¯¯=${response.data.msg}`);
      showCommentTip(`åŠ è½½å›å¤å¤±è´¥: ${response.data.msg}`, 'error');
      console.groupEnd();
      return null;
    }
  } catch (error) {
    console.error(`ã€å›å¤åŠŸèƒ½ã€‘ã€åŠ è½½å›å¤ã€‘ åŠ è½½å­è¯„è®ºæ¥å£è¯·æ±‚å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…=`, error);
    showCommentTip(`åŠ è½½å›å¤å¤±è´¥ï¼šè¯·æ±‚åœ°å€ä¸å­˜åœ¨æˆ–åç«¯æœªå®ç°\n${error.config?.url || 'æœªçŸ¥åœ°å€'}`, 'error');
    console.groupEnd();
    return null;
  }
}
2. æ¸²æŸ“å­è¯„è®ºçš„æ ¸å¿ƒå‡½æ•°
renderReplyItem å‡½æ•°è´Ÿè´£å°†åç«¯è¿”å›çš„æ•°æ®æ¸²æŸ“ä¸ºå¯è§†åŒ–çš„DOMå…ƒç´ ï¼š


songs-details.html
Apply
/**
 * æ¸²æŸ“å•æ¡å›å¤å†…å®¹ï¼ˆè¯„è®ºçš„å­å›å¤ï¼‰
 * @param {Object} reply - å›å¤æ•°æ®å¯¹è±¡
 * @param {HTMLElement} container - å›å¤åˆ—è¡¨å®¹å™¨
 * @param {boolean} insertToTop - æ˜¯å¦æ’å…¥åˆ°åˆ—è¡¨é¡¶éƒ¨
 * @returns {HTMLElement} æ¸²æŸ“åçš„å›å¤DOMå…ƒç´ 
 */
function renderReplyItem(reply, container, insertToTop = false) {
  console.group(`ã€å›å¤æ¸²æŸ“ã€‘ã€å­å›å¤æ¸²æŸ“ã€‘ å¼€å§‹æ¸²æŸ“å•æ¡å›å¤ï¼Œå›å¤ID=${reply._id}, çˆ¶è¯„è®ºID=${reply.parent_id}`);
  if (!reply || !container) {
    console.error(`ã€å›å¤æ¸²æŸ“ã€‘ã€å­å›å¤æ¸²æŸ“ã€‘ å›å¤æ•°æ®æˆ–å®¹å™¨ä¸ºç©ºï¼Œç»ˆæ­¢æ¸²æŸ“`);
    console.groupEnd();
    return null;
  }
  
  // åˆ›å»ºå›å¤DOMèŠ‚ç‚¹
  const replyItem = document.createElement('div');
  replyItem.className = `reply-item ${reply.isTemp ? 'temp-reply' : ''}`;
  replyItem.dataset.replyId = reply._id;
  replyItem.dataset.parentId = reply.parent_id;

  // è·å–å½“å‰ç¼“å­˜ç”¨æˆ·ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±çš„å›å¤
  const cacheUser = getUserFromCache();
  const isCurrentUserReply = cacheUser && cacheUser.username === reply.username;
  const userName = isCurrentUserReply ? cacheUser.nick_name : (reply.nick_name || reply.username || 'åŒ¿åç”¨æˆ·');
  const avatarUrl = isCurrentUserComment ? cacheUser.avatar : reply.avatar;

  // ç»„è£…å¤´åƒHTML
  let avatarHtml = getDefaultAvatar(userName);
  if (avatarUrl) {
    avatarHtml = `<img src="${avatarUrl}" alt="${userName}" onerror="this.parentNode.innerHTML='${getDefaultAvatar(userName)}'">`;
  }

  // å¤„ç†å›å¤çš„@ç”¨æˆ·å‰ç¼€
  let replyContent = reply.content || 'æ— å†…å®¹';
  if (reply.reply_to_name && replyContent.startsWith(`@${reply.reply_to_name}`)) {
    replyContent = replyContent.replace(`@${reply.reply_to_name}`, `<span class="reply-at-user">@${reply.reply_to_name}</span>`);
  }

  // ä¿®å¤ï¼šå›å¤ç‚¹èµæ•°é»˜è®¤å€¼0ï¼Œé¿å…NaN
  const replyLikeCount = parseInt(reply.likeCount || '0', 10);

  // ç»„è£…å›å¤å®Œæ•´HTMLç»“æ„
  replyItem.innerHTML = `
    <div class="reply-avatar">${avatarHtml}</div>
    <div class="reply-content-wrapper">
      <div class="reply-header">
        <span class="reply-nickname">${userName}</span>
        <span class="reply-time">${formatCommentTime(reply.createdAt)}</span>
      </div>
      <div class="reply-content">${replyContent}</div>
      <div class="reply-actions">
        <button class="like-btn" data-reply-id="${reply._id}">
          <span class="heart-icon ${reply.likedByMe ? 'liked' : ''}">â¤ï¸</span>
          <span class="reply-like-count">${isNaN(replyLikeCount) ? 0 : replyLikeCount}</span>
        </button>
        <button class="reply-btn reply-to-reply-btn" data-reply-id="${reply._id}" data-parent-id="${reply.parent_id}" data-reply-to="${userName}">
          <span>ğŸ’¬</span><span>å›å¤</span>
        </button>
      </div>
    </div>
  `;

  // æ’å…¥åˆ°å®¹å™¨çš„é¡¶éƒ¨/åº•éƒ¨
  if (insertToTop) {
    container.insertBefore(replyItem, container.firstChild);
    replyItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  } else {
    container.appendChild(replyItem);
  }

  // ç»‘å®šç‚¹èµäº‹ä»¶å’Œå›å¤äº‹ä»¶
  const likeBtn = replyItem.querySelector(`.like-btn[data-reply-id="${reply._id}"]`);
  const heartIcon = replyItem.querySelector('.heart-icon');
  const likeCountEl = replyItem.querySelector('.reply-like-count');
  if (likeBtn && heartIcon && likeCountEl) {
    likeBtn.addEventListener('click', () => {
      const realReplyId = likeBtn.dataset.replyId;
      handleCommentLike(realReplyId, likeBtn, heartIcon, likeCountEl);
    });
  }

  const replyBtn = replyItem.querySelector('.reply-to-reply-btn');
  if (replyBtn) {
    replyBtn.addEventListener('click', () => {
      const parentId = replyBtn.dataset.parentId;
      const replyToName = replyBtn.dataset.replyTo;
      toggleReplyForm(parentId, replyToName);
    });
  }

  console.log(`ã€å›å¤æ¸²æŸ“ã€‘ã€å­å›å¤æ¸²æŸ“ã€‘ å›å¤æ¸²æŸ“å®Œæˆï¼ŒDOMå…ƒç´ æ’å…¥æˆåŠŸ`);
  console.groupEnd();
  return replyItem;
}
3. å®Œæ•´çš„å­è¯„è®ºåŠ è½½å’Œæ¸²æŸ“æµç¨‹
å½“ç”¨æˆ·ç‚¹å‡»"å±•å¼€å›å¤"æŒ‰é’®æ—¶ï¼Œä¼šè§¦å‘ä»¥ä¸‹å®Œæ•´æµç¨‹ï¼š


songs-details.html
Apply
// ç»‘å®šå±•å¼€/æŠ˜å å›å¤æŒ‰é’®äº‹ä»¶
const toggleRepliesBtn = item.querySelector('.toggle-replies-btn');
if (toggleRepliesBtn) {
  toggleRepliesBtn.addEventListener('click', async () => {
    const commentId = toggleRepliesBtn.dataset.commentId;
    const repliesList = item.querySelector('.replies-list');
    const emptyRepliesTip = item.querySelector('.empty-replies-tip');
    const replyCount = parseInt(toggleRepliesBtn.dataset.replyCount || '0', 10);

    if (repliesList) {
      toggleRepliesList(toggleRepliesBtn, repliesList, replyCount);
      return;
    }

    toggleRepliesBtn.disabled = true;
    toggleRepliesBtn.innerHTML = '<span>â³</span><span>åŠ è½½ä¸­...</span>';

    try {
      // 1. ä»åç«¯è·å–å­è¯„è®ºæ•°æ®
      const replyData = await loadCommentReplies(commentId, 1, 10);
      if (!replyData) return;

      // 2. åˆ›å»ºå›å¤åˆ—è¡¨å®¹å™¨
      const newRepliesList = document.createElement('div');
      newRepliesList.className = 'replies-list';

      if (emptyRepliesTip) {
        emptyRepliesTip.parentNode.replaceChild(newRepliesList, emptyRepliesTip);
      }

      const realReplyCount = parseInt(replyData.pagination?.total || '0', 10);
      toggleRepliesBtn.dataset.replyCount = realReplyCount;

      // 3. æ¸²æŸ“æ¯æ¡å­è¯„è®º
      if (replyData.replies && replyData.replies.length > 0) {
        replyData.replies.forEach(reply => {
          if (!reply.parent_id || reply.parent_id !== commentId) {
            reply.parent_id = commentId;
          }
          // è°ƒç”¨renderReplyItemå‡½æ•°æ¸²æŸ“å•æ¡å›å¤
          renderReplyItem(reply, newRepliesList, false);
        });
      } else {
        // æ— å›å¤æ—¶æ˜¾ç¤ºç©ºæç¤º
        const emptyTip = document.createElement('div');
        emptyTip.className = 'empty-replies-tip';
        emptyTip.style.cssText = 'padding: 1rem 0; color: var(--text-muted); font-size: 0.875rem; text-align: left;';
        emptyTip.textContent = 'æš‚æ— å›å¤ï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï½';
        newRepliesList.appendChild(emptyTip);
      }

      // 4. åˆ‡æ¢åˆ—è¡¨çŠ¶æ€
      toggleRepliesList(toggleRepliesBtn, newRepliesList, realReplyCount);
    } catch (err) {
      console.error('åŠ è½½å›å¤åˆ—è¡¨å¤±è´¥:', err);
      showCommentTip('åŠ è½½å›å¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      toggleRepliesBtn.disabled = false;
      const finalCount = parseInt(toggleRepliesBtn.dataset.replyCount || '0', 10);
      toggleRepliesBtn.innerHTML = finalCount > 0 ? `<span>ğŸ“¥</span><span>æ”¶èµ·å›å¤(${finalCount})</span>` : `<span>ğŸ“¤</span><span>å±•å¼€å›å¤</span>`;
    }
  });
}