# 陶喆音乐平台 - 评论系统接口文档

## 概述

本文档详细说明评论系统的父子评论区分逻辑，帮助前端正确识别和处理父评论（主评论）与子评论（回复评论）。

## 数据模型定义

### 评论模型 (Comment)

```javascript
{
  _id: ObjectId,                    // 评论唯一标识
  resource_type: "song|single|album", // 资源类型
  resource_id: String,              // 资源ID
  username: String,                 // 用户名
  nick_name: String,                // 昵称
  avatar: String,                   // 头像
  content: String,                  // 评论内容
  createdAt: Date,                  // 创建时间
  likeCount: Number,                // 点赞数
  
  // 父子评论关键字段
  parent_id: ObjectId|null,         // 父评论ID（null表示父评论）
  reply_to_user_id: String,         // 回复的目标用户ID
  reply_to_name: String             // 回复的目标用户名
}
```

### 父子评论特征区分

| 特征 | 父评论 | 子评论 |
|------|--------|--------|
| `parent_id` | `null` | 指向父评论的ObjectId |
| `reply_to_*` 字段 | 不存在或为空 | 包含回复目标信息 |
| 排序规则 | 支持NEW/HOT排序 | 按时间正序排列 |
| 返回字段 | 包含`replies_total` | 包含`reply_to_*`字段 |

## 接口列表

### 1. 发布评论（父评论）

**接口路径：** `POST /api/{resourceType}s/{resourceId}/comments`

**请求示例：**
```javascript
// 发布歌曲评论
POST /api/songs/tao_zhe_1999_01/comments
{
  "content": "这首歌太好听了！"
}
```

**响应示例：**
```javascript
{
  "code": 200,
  "msg": "评论发布成功",
  "data": {
    "commentId": "67c8a1b2e4f5d6a7b8c9d0e1",
    "songId": "tao_zhe_1999_01",
    "username": "user123",
    "nick_name": "陶喆粉丝",
    "avatar": "avatar_url",
    "content": "这首歌太好听了！",
    "createdAt": "2024-01-15T10:30:00.000Z"
    // 注意：父评论没有parent_id和reply_to相关字段
  }
}
```

### 2. 发布评论回复（子评论）

**接口路径：** `POST /api/comments/{commentId}/reply`

**请求示例：**
```javascript
POST /api/comments/67c8a1b2e4f5d6a7b8c9d0e1/reply
{
  "content": "我也超喜欢这首歌！"
}
```

**响应示例：**
```javascript
{
  "code": 200,
  "msg": "回复发布成功",
  "data": {
    "commentId": "67c8a1b2e4f5d6a7b8c9d0e2",
    "parentId": "67c8a1b2e4f5d6a7b8c9d0e1", // 指向父评论
    "replyToComment": "67c8a1b2e4f5d6a7b8c9d0e1",
    "replyToUser": "user123",
    "replyToName": "陶喆粉丝",
    "username": "user456",
    "nick_name": "音乐爱好者",
    "avatar": "avatar_url2",
    "content": "我也超喜欢这首歌！",
    "createdAt": "2024-01-15T10:35:00.000Z"
  }
}
```

### 3. 获取评论列表（父评论）

**接口路径：** `GET /api/{resourceType}s/{resourceId}/comments`

**查询参数：**
- `page`: 页码（默认1）
- `pageSize`: 每页数量（默认20）
- `sort`: 排序方式 `NEW`(时间倒序) 或 `HOT`(热度倒序)

**响应示例：**
```javascript
{
  "code": 200,
  "data": {
    "comments": [
      {
        "_id": "67c8a1b2e4f5d6a7b8c9d0e1",
        "username": "user123",
        "nick_name": "陶喆粉丝",
        "avatar": "avatar_url",
        "content": "这首歌太好听了！",
        "createdAt": "2024-01-15T10:30:00.000Z",
        "likeCount": 5,
        "replies_total": 3, // 子评论总数
        // 关键：没有parent_id，说明是父评论
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 15,
      "totalPages": 1
    }
  },
  "msg": "获取歌曲评论成功"
}
```

**前端识别逻辑：**
- 检查评论对象是否包含 `replies_total` 字段
- 检查 `parent_id` 字段是否为 `null` 或不存在
- 如果满足以上条件，则为父评论

### 4. 获取评论回复列表（子评论）

**接口路径：** `GET /api/comments/{commentId}/replies`

**查询参数：**
- `page`: 页码（默认1）
- `pageSize`: 每页数量（默认10）

**响应示例：**
```javascript
{
  "code": 200,
  "data": {
    "replies": [
      {
        "_id": "67c8a1b2e4f5d6a7b8c9d0e2",
        "username": "user456",
        "nick_name": "音乐爱好者",
        "avatar": "avatar_url2",
        "content": "我也超喜欢这首歌！",
        "parent_id": "67c8a1b2e4f5d6a7b8c9d0e1", // 指向父评论
        "reply_to_comment": "67c8a1b2e4f5d6a7b8c9d0e1",
        "reply_to_user": "user123",
        "reply_to_name": "陶喆粉丝",
        "createdAt": "2024-01-15T10:35:00.000Z",
        "likeCount": 2
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 10,
      "total": 3,
      "totalPages": 1
    }
  },
  "msg": "获取评论回复列表成功"
}
```

**前端识别逻辑：**
- 检查评论对象是否包含 `parent_id` 字段且不为 `null`
- 检查是否包含 `reply_to_*` 相关字段
- 如果满足以上条件，则为子评论

### 5. 评论点赞接口

**接口路径：** `POST /api/comments/{commentId}/like`

**特殊处理：临时评论ID**
- 临时评论ID以 `temp_` 开头（如：`temp_1767788670682`）
- 后端会跳过点赞操作，返回 `isTempId: true`
- 前端应等待真实评论ID返回后再进行点赞操作

## 前端处理建议

### 1. 父子评论显示逻辑

```javascript
// 判断是否为父评论
function isParentComment(comment) {
  return comment.parent_id === null || comment.parent_id === undefined;
}

// 判断是否为子评论
function isChildComment(comment) {
  return comment.parent_id !== null && comment.parent_id !== undefined;
}

// 渲染评论列表
function renderComments(comments) {
  comments.forEach(comment => {
    if (isParentComment(comment)) {
      // 渲染父评论
      renderParentComment(comment);
      // 如果有子评论，显示回复数量
      if (comment.replies_total > 0) {
        showRepliesCount(comment.replies_total);
      }
    } else {
      // 渲染子评论
      renderChildComment(comment);
    }
  });
}
```

### 2. 评论树形结构构建

```javascript
// 构建评论树
function buildCommentTree(parentComments, childComments) {
  const commentTree = [];
  
  parentComments.forEach(parent => {
    const parentNode = {
      ...parent,
      children: childComments.filter(child => 
        child.parent_id.toString() === parent._id.toString()
      )
    };
    commentTree.push(parentNode);
  });
  
  return commentTree;
}
```

### 3. 排序规则处理

**父评论排序：**
- `NEW`: 按 `createdAt` 倒序（最新在前）
- `HOT`: 按 `likeCount` 倒序，同点赞数按时间倒序

**子评论排序：**
- 始终按 `createdAt` 正序（最早回复在前）

## 错误码说明

| 错误码 | 说明 | 处理建议 |
|--------|------|----------|
| 400 | 评论内容为空或超长 | 检查评论内容长度（1-500字） |
| 404 | 评论不存在 | 刷新页面或检查评论ID |
| 401 | 未登录 | 引导用户登录 |
| 409 | 重复点赞 | 提示用户已点赞 |

## 注意事项

1. **临时评论处理**：前端创建临时评论时，ID应以 `temp_` 开头，后端会自动识别并跳过相关操作
2. **分页加载**：子评论数量较多时建议使用分页加载，避免一次性加载过多数据
3. **实时更新**：点赞和回复操作后，建议及时更新本地数据状态
4. **数据一致性**：确保父子评论的 `resource_type` 和 `resource_id` 一致

## 示例场景

### 场景1：用户查看歌曲评论
```javascript
// 1. 获取父评论列表
GET /api/songs/tao_zhe_1999_01/comments?sort=HOT

// 2. 用户点击查看某条父评论的回复
GET /api/comments/67c8a1b2e4f5d6a7b8c9d0e1/replies

// 3. 用户在回复中继续回复
POST /api/comments/67c8a1b2e4f5d6a7b8c9d0e2/reply
```

### 场景2：用户发布评论流程
```javascript
// 1. 前端创建临时评论（提供即时反馈）
const tempComment = {
  _id: 'temp_' + Date.now(),
  content: '新评论内容',
  isTemp: true
};

// 2. 调用发布接口
POST /api/songs/tao_zhe_1999_01/comments

// 3. 收到真实评论ID后替换临时评论
replaceTempComment(tempComment._id, realComment);
```

---

**文档版本：** v1.0  
**最后更新：** 2024-01-15  
**维护者：** 后端开发团队