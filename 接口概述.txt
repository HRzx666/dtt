è®¤è¯è¯´æ˜
è®¤è¯æ–¹å¼: JWT Token
Tokenä¼ é€’: é€šè¿‡Cookieè‡ªåŠ¨ä¼ é€’ï¼ˆwithCredentials: trueï¼‰
éœ€è¦è®¤è¯çš„æ¥å£: ç‚¹èµã€ç¼–è¾‘ã€åˆ é™¤ã€å‘è¡¨è¯„è®º
ğŸ“ è¯„è®ºç›¸å…³æ¥å£
1. è·å–ä¸“è¾‘è¯„è®ºåˆ—è¡¨
æ¥å£åœ°å€: GET /api/albums/:albumId/comments

è¯·æ±‚å‚æ•°:

å‚æ•°å	ç±»å‹	å¿…å¡«	è¯´æ˜	é»˜è®¤å€¼
albumId	string	æ˜¯	ä¸“è¾‘ID	-
page	number	å¦	é¡µç 	1
pageSize	number	å¦	æ¯é¡µæ•°é‡	10
å“åº”ç¤ºä¾‹:


json
Apply
{
  "code": 200,
  "msg": "è·å–ä¸“è¾‘è¯„è®ºæˆåŠŸ",
  "data": {
    "comments": [
      {
        "_id": "è¯„è®ºID",
        "username": "ç”¨æˆ·å",
        "nick_name": "æ˜µç§°",
        "avatar": "å¤´åƒURL",
        "content": "è¯„è®ºå†…å®¹",
        "createdAt": "åˆ›å»ºæ—¶é—´",
        "likeCount": ç‚¹èµæ•°,
        "replies_total": å›å¤æ€»æ•°
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 10,
      "total": 50,
      "totalPages": 5
    }
  }
}
å‰ç«¯è°ƒç”¨ç¤ºä¾‹:


javascript
Apply
async function loadAlbumComments(albumId, page = 1, pageSize = 10) {
  try {
    const response = await axios.get(
      `http://localhost:3000/api/albums/${albumId}/comments?page=${page}&pageSize=${pageSize}`,
      { withCredentials: true }
    );
    return response.data.data;
  } catch (error) {
    console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
    return null;
  }
}
2. å‘è¡¨è¯„è®º
æ¥å£åœ°å€: POST /api/comments

è¯·æ±‚å‚æ•°:

å‚æ•°å	ç±»å‹	å¿…å¡«	è¯´æ˜
content	string	æ˜¯	è¯„è®ºå†…å®¹ï¼ˆ1-500å­—ï¼‰
resource_id	string	æ˜¯	èµ„æºIDï¼ˆä¸“è¾‘IDï¼‰
parent_id	string	å¦	çˆ¶è¯„è®ºIDï¼ˆå›å¤æ—¶ä½¿ç”¨ï¼‰
reply_to_user_id	string	å¦	å›å¤ç›®æ ‡ç”¨æˆ·ID
reply_to_name	string	å¦	å›å¤ç›®æ ‡ç”¨æˆ·å
è¯·æ±‚ç¤ºä¾‹:


json
Apply
{
  "content": "è¿™æ˜¯ä¸€æ¡è¯„è®º",
  "resource_id": "ä¸“è¾‘ID",
  "parent_id": "çˆ¶è¯„è®ºID", // å¯é€‰ï¼Œå›å¤æ—¶ä½¿ç”¨
  "reply_to_user_id": "ç›®æ ‡ç”¨æˆ·ID", // å¯é€‰
  "reply_to_name": "ç›®æ ‡ç”¨æˆ·å" // å¯é€‰
}
å“åº”ç¤ºä¾‹:


json
Apply
{
  "code": 200,
  "msg": "è¯„è®ºå‘è¡¨æˆåŠŸ",
  "data": {
    "commentId": "æ–°è¯„è®ºID",
    "content": "è¯„è®ºå†…å®¹",
    "createdAt": "åˆ›å»ºæ—¶é—´"
  }
}
å‰ç«¯è°ƒç”¨ç¤ºä¾‹:


javascript
Apply
async function submitComment(content, albumId, parentId = null, replyTo = null) {
  try {
    const requestData = {
      content: content.trim(),
      resource_id: albumId
    };
    
    // å¦‚æœæ˜¯å›å¤è¯„è®º
    if (parentId) {
      requestData.parent_id = parentId;
      if (replyTo) {
        requestData.reply_to_user_id = replyTo.userId;
        requestData.reply_to_name = replyTo.username;
      }
    }
    
    const response = await axios.post(
      'http://localhost:3000/api/comments',
      requestData,
      { withCredentials: true }
    );
    
    return response.data.data;
  } catch (error) {
    console.error('å‘è¡¨è¯„è®ºå¤±è´¥:', error);
    return null;
  }
}
3. è·å–ç‰¹å®šè¯„è®ºçš„å­è¯„è®ºåˆ—è¡¨
æ¥å£åœ°å€: GET /api/comments/:commentId/replies

è¯·æ±‚å‚æ•°:

å‚æ•°å	ç±»å‹	å¿…å¡«	è¯´æ˜	é»˜è®¤å€¼	é™åˆ¶
commentId	string	æ˜¯	çˆ¶è¯„è®ºID	-	-
page	number	å¦	é¡µç 	1	â‰¥1
pageSize	number	å¦	æ¯é¡µæ•°é‡	10	1-50
å“åº”ç¤ºä¾‹:


json
Apply
{
  "code": 200,
  "msg": "è·å–å­è¯„è®ºæˆåŠŸ",
  "data": {
    "parentComment": {
      "_id": "çˆ¶è¯„è®ºID",
      "username": "çˆ¶è¯„è®ºç”¨æˆ·å",
      "nick_name": "çˆ¶è¯„è®ºæ˜µç§°",
      "content": "çˆ¶è¯„è®ºå†…å®¹"
    },
    "replies": [
      {
        "_id": "å›å¤ID",
        "username": "å›å¤è€…ç”¨æˆ·å",
        "nick_name": "å›å¤è€…æ˜µç§°",
        "avatar": "å›å¤è€…å¤´åƒ",
        "content": "å›å¤å†…å®¹",
        "createdAt": "å›å¤æ—¶é—´",
        "likeCount": ç‚¹èµæ•°,
        "parent_id": "çˆ¶è¯„è®ºID",
        "reply_to_user_id": "å›å¤ç›®æ ‡ç”¨æˆ·ID",
        "reply_to_name": "å›å¤ç›®æ ‡ç”¨æˆ·å"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 10,
      "total": 25,
      "totalPages": 3
    }
  }
}
å‰ç«¯è°ƒç”¨ç¤ºä¾‹:


javascript
Apply
async function loadCommentReplies(commentId, page = 1, pageSize = 10) {
  try {
    const safePageSize = Math.min(pageSize, 50);
    const response = await axios.get(
      `http://localhost:3000/api/comments/${commentId}/replies?page=${page}&pageSize=${safePageSize}`,
      { withCredentials: true }
    );
    
    if (response.data.code === 200) {
      return response.data.data;
    }
    return null;
  } catch (error) {
    console.error('åŠ è½½å›å¤å¤±è´¥:', error);
    return null;
  }
}
4. è¯„è®ºç‚¹èµ/å–æ¶ˆç‚¹èµ
æ¥å£åœ°å€: POST /api/comments/:commentId/like

è¯·æ±‚å‚æ•°:

å‚æ•°å	ç±»å‹	å¿…å¡«	è¯´æ˜
commentId	string	æ˜¯	è¯„è®ºID
å“åº”ç¤ºä¾‹:


json
Apply
{
  "code": 200,
  "msg": "ç‚¹èµæˆåŠŸ",
  "data": {
    "isLiked": true
  }
}
å‰ç«¯è°ƒç”¨ç¤ºä¾‹:


javascript
Apply
async function toggleCommentLike(commentId) {
  try {
    const response = await axios.post(
      `http://localhost:3000/api/comments/${commentId}/like`,
      {},
      { withCredentials: true }
    );
    
    return response.data.data.isLiked;
  } catch (error) {
    console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
    return null;
  }
}
5. æŸ¥è¯¢ç‚¹èµçŠ¶æ€
æ¥å£åœ°å€: GET /api/comments/:commentId/like/status

è¯·æ±‚å‚æ•°:

å‚æ•°å	ç±»å‹	å¿…å¡«	è¯´æ˜
commentId	string	æ˜¯	è¯„è®ºID
å“åº”ç¤ºä¾‹:


json
Apply
{
  "code": 200,
  "data": {
    "isLiked": true
  },
  "msg": "æŸ¥è¯¢ç‚¹èµçŠ¶æ€æˆåŠŸ"
}
å‰ç«¯è°ƒç”¨ç¤ºä¾‹:


javascript
Apply
async function checkLikeStatus(commentId) {
  try {
    const response = await axios.get(
      `http://localhost:3000/api/comments/${commentId}/like/status`,
      { withCredentials: true }
    );
    
    return response.data.data.isLiked;
  } catch (error) {
    console.error('æŸ¥è¯¢ç‚¹èµçŠ¶æ€å¤±è´¥:', error);
    return false;
  }
}
6. ç¼–è¾‘è¯„è®º
æ¥å£åœ°å€: PUT /api/comments/:commentId

è¯·æ±‚å‚æ•°:

å‚æ•°å	ç±»å‹	å¿…å¡«	è¯´æ˜
commentId	string	æ˜¯	è¯„è®ºID
content	string	æ˜¯	æ–°è¯„è®ºå†…å®¹ï¼ˆ1-500å­—ï¼‰
è¯·æ±‚ç¤ºä¾‹:


json
Apply
{
  "content": "ä¿®æ”¹åçš„è¯„è®ºå†…å®¹"
}
å“åº”ç¤ºä¾‹:


json
Apply
{
  "code": 200,
  "msg": "è¯„è®ºç¼–è¾‘æˆåŠŸ",
  "data": {
    "commentId": "è¯„è®ºID",
    "content": "æ–°è¯„è®ºå†…å®¹",
    "updatedAt": "æ›´æ–°æ—¶é—´"
  }
}
å‰ç«¯è°ƒç”¨ç¤ºä¾‹:


javascript
Apply
async function editComment(commentId, newContent) {
  try {
    const response = await axios.put(
      `http://localhost:3000/api/comments/${commentId}`,
      { content: newContent.trim() },
      { withCredentials: true }
    );
    
    return response.data.data;
  } catch (error) {
    console.error('ç¼–è¾‘è¯„è®ºå¤±è´¥:', error);
    return null;
  }
}
7. åˆ é™¤è¯„è®º
æ¥å£åœ°å€: DELETE /api/comments/:commentId

è¯·æ±‚å‚æ•°:

å‚æ•°å	ç±»å‹	å¿…å¡«	è¯´æ˜
commentId	string	æ˜¯	è¯„è®ºID
å“åº”ç¤ºä¾‹:


json
Apply
{
  "code": 200,
  "msg": "è¯„è®ºåˆ é™¤æˆåŠŸ",
  "data": {
    "commentId": "è¢«åˆ é™¤çš„è¯„è®ºID"
  }
}
å‰ç«¯è°ƒç”¨ç¤ºä¾‹:


javascript
Apply
async function deleteComment(commentId) {
  try {
    const response = await axios.delete(
      `http://localhost:3000/api/comments/${commentId}`,
      { withCredentials: true }
    );
    
    return response.data.data.commentId;
  } catch (error) {
    console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
    return null;
  }
}
âš ï¸ é”™è¯¯ç è¯´æ˜
é”™è¯¯ç 	è¯´æ˜	å¯èƒ½åŸå› 
200	æˆåŠŸ	æ“ä½œæˆåŠŸ
400	è¯·æ±‚å‚æ•°é”™è¯¯	å‚æ•°ç¼ºå¤±ã€æ ¼å¼é”™è¯¯ã€å†…å®¹è¿‡é•¿ç­‰
401	æœªæˆæƒ	æœªç™»å½•æˆ–Tokenå¤±æ•ˆ
403	ç¦æ­¢è®¿é—®	æ— æƒæ“ä½œä»–äººè¯„è®º
404	èµ„æºä¸å­˜åœ¨	è¯„è®ºæˆ–ä¸“è¾‘ä¸å­˜åœ¨
500	æœåŠ¡å™¨å†…éƒ¨é”™è¯¯	æœåŠ¡å™¨å¼‚å¸¸
ğŸ”§ å‰ç«¯é…ç½®å»ºè®®
1. Axioså…¨å±€é…ç½®

javascript
Apply
// è®¾ç½®åŸºç¡€URLå’Œè®¤è¯é…ç½®
axios.defaults.baseURL = 'http://localhost:3000';
axios.defaults.withCredentials = true; // è‡ªåŠ¨ä¼ é€’Cookie
2. é”™è¯¯å¤„ç†å°è£…

javascript
Apply
// ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å‡½æ•°
function handleApiError(error, defaultMessage = 'æ“ä½œå¤±è´¥') {
  if (error.response) {
    const message = error.response.data.msg || defaultMessage;
    showErrorTip(message);
  } else if (error.request) {
    showErrorTip('ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
  } else {
    showErrorTip(defaultMessage);
  }
  console.error('APIé”™è¯¯:', error);
}
3. è¯„è®ºå†…å®¹éªŒè¯

javascript
Apply
function validateCommentContent(content) {
  const trimmed = content.trim();
  if (trimmed.length === 0) {
    return { valid: false, message: 'è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º' };
  }
  if (trimmed.length > 500) {
    return { valid: false, message: 'è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡500å­—' };
  }
  return { valid: true, message: '' };
}
ğŸ“± å‰ç«¯äº¤äº’æµç¨‹ç¤ºä¾‹
1. åŠ è½½è¯„è®ºåˆ—è¡¨

javascript
Apply
// é¡µé¢åŠ è½½æ—¶è°ƒç”¨
async function initComments(albumId) {
  const commentsData = await loadAlbumComments(albumId);
  if (commentsData) {
    renderComments(commentsData.comments);
    setupPagination(commentsData.pagination);
  }
}
2. å›å¤è¯„è®ºæµç¨‹

javascript
Apply
// ç‚¹å‡»å›å¤æŒ‰é’®
function onReplyClick(commentId, replyToName) {
  // æ˜¾ç¤ºå›å¤è¡¨å•
  toggleReplyForm(commentId, replyToName);
  
  // åŠ è½½å›å¤åˆ—è¡¨ï¼ˆå¦‚æœè¿˜æ²¡åŠ è½½è¿‡ï¼‰
  if (!isRepliesLoaded(commentId)) {
    loadAndDisplayReplies(commentId);
  }
}

// æäº¤å›å¤
async function onSubmitReply(parentCommentId, content, replyTo) {
  const result = await submitComment(content, albumId, parentCommentId, replyTo);
  if (result) {
    // åˆ·æ–°å›å¤åˆ—è¡¨
    await loadAndDisplayReplies(parentCommentId);
    // éšè—å›å¤è¡¨å•
    toggleReplyForm(parentCommentId);
    showSuccessTip('å›å¤æˆåŠŸ');
  }
}